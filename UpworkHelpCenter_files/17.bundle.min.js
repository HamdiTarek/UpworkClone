/* Tagove! */
webpff([17],{498:function(B,C,u){function w(b){return b&&b.__esModule?b:{"default":b}}function E(b,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);b.prototype=Object.create(e&&e.prototype,{constructor:{value:b,enumerable:!1,writable:!0,configurable:!0}});e&&(Object.setPrototypeOf?Object.setPrototypeOf(b,e):b.__proto__=e)}Object.defineProperty(C,"__esModule",{value:!0});var p=function(){function b(b,f){for(var e=0;e<f.length;e++){var a=
f[e];a.enumerable=a.enumerable||!1;a.configurable=!0;"value"in a&&(a.writable=!0);Object.defineProperty(b,a.key,a)}}return function(e,f,a){f&&b(e.prototype,f);a&&b(e,a);return e}}(),t=function(b,e,f){var a=!0;for(;a;)if(null===b&&(b=Function.prototype),a=Object.getOwnPropertyDescriptor(b,e),void 0===a){b=Object.getPrototypeOf(b);if(null===b)break;a=!0}else{if("value"in a)return a.value;e=a.get;return void 0===e?void 0:e.call(f)}},q=u(160),h=w(q),q=u(1),b=w(q),q=u(499),c=w(q),q=u(279),g=w(q),q=u(98),
a=w(q),q=u(289),q=w(q),k=u(291),d=w(k),k=u(280),r=w(k),k=u(98);w(k);var m=r["default"].limitCalls(.3),q=function(l){function e(f,a){var n=this;if(!(this instanceof e))throw new TypeError("Cannot call a class as a function");t(Object.getPrototypeOf(e.prototype),"constructor",this).call(this);this.app=f;this.chatMessenger=!1;this.logger=f.logger.logger("chat");this._creq={};this._data=h["default"].observable(a);this.data=h["default"].computed({read:function(){return n._data()},write:function(){var f=
0>=arguments.length||void 0===arguments[0]?{}:arguments[0],b=r["default"].deepExtend(n._data(),f);"undefined"!==typeof f.users&&(b.users=f.users);try{n._data(b),n._data.valueHasMutated()}catch(J){n.logger.error(J)}}});this.translate_from=h["default"].observable("auto");this.translate_to=h["default"].observable("en");this.ctranslate_from=h["default"].observable("auto");this.ctranslate_to=h["default"].observable(null);this.translate_form_show=h["default"].observable(!1);this.translate_mode=h["default"].observable(!1);
this.account_translate_language=h["default"].observable("");this.messages=h["default"].observableArray([]);this.loadedHistory=h["default"].observable(!1);this.loadingMessages=h["default"].observable(!1);this.active=h["default"].observable(!1);this.typingText=h["default"].observable();this.inputArea=h["default"].observable(null);this.loadShortCut=!0;this.inputArea.subscribe(function(){n.inputArea&&n.inputArea()&&(d["default"].init(n),"backend"==n.app.type&&d["default"].initShortCut(n))});this.silentRequestCoBrowse=
!0;this.prepopup_email_title=h["default"].observable("");this.prepopup_phone_title=h["default"].observable("");this.prepopup_notified_title=h["default"].observable("");this.prepopup_email_val=h["default"].observable("");this.prepopup_phone_val=h["default"].observable("");this.prepopup_email_display=h["default"].observable(!1);this.prepopup_phone_display=h["default"].observable(!1);this.prepopup_notified_display=h["default"].observable(!1);var v=this.app.form_settings().chat_wait_time,l=this.app.form_settings().after_chat_notification_visible?
this.app.form_settings().after_chat_notification_visible:"";if(!v&&""!==v||0>v)v=10;var v=1E3*v,k=this.app.availableAgents()&&0<this.app.availableAgents().length?this.app.availableAgents().length:"0";"pending"==this.data().status&&0<k&&"bot"!=this.data().type&&l&&setTimeout(function(){n.app&&"frontend"==n.app.type&&n.afterChatEmailStep()},v);this.stop_timer=h["default"].observable(null);this.init_visitor_name=h["default"].observable("");this.init_visitor_email=h["default"].observable("");this.init_visitor_phone=
h["default"].observable("");this.init_visitor_message=h["default"].observable("");this.visitor_name=h["default"].observable("");this.visitor_email=h["default"].observable("");this.visitor_phone=h["default"].observable("");this.ask_to_visitor_title=h["default"].observable("");this.ask_to_visitor_popup=h["default"].observable(!1);this._users=h["default"].observableArray([]);this.users=h["default"].computed(function(){n.app.myself();n.data()&&n.data().users&&n._users&&"function"==typeof n._users&&n._users()?
(b["default"].each(n.data().users,function(f,a){if("active"==a.status){var e=!1;b["default"].each(n._users(),function(f,b){b().id==a.id&&(e=b)});"agent"==a.type&&n.getAgent(a.id_real)&&(n.app.myself()&&"agent"==n.app.myself().type&&n.app.myself().id==a.id_real?a.me=!0:a.me=!1,a.user=null);"visitor"==a.type&&(n.app.myself()&&"visitor"==n.app.myself().type&&n.app.myself().id==a.id_real?a.me=!0:a.me=!1,a.user=null);e?(e(b["default"].extend(e(),a)),e.valueHasMutated()):n._users.push(h["default"].observable(a))}}),
b["default"].each(n._users(),function(f,a){var e=!1;"undefined"!=typeof n.data().users&&b["default"].each(n.data().users,function(f,b){a&&b.id_real==a().id_real&&(e=!0)});e||n._users.remove(a)})):n._users([]);return n._users()});this.users.remove=function(f){n._users.remove(f)};this.messages.subscribe(function(){n.typingText(null)});this.translate_to(this.data().translate_to);this.translate_form_show(this.data().translate_form_show);this.translate_mode(this.data().translation_mode);this.unseenMessages=
h["default"].computed(function(){var a=[],e=parseInt(n.app.cookieManager.getSimple("_lastmsgnotification")||0);b["default"].each(n.messages(),function(b,c){"system_log"!=c().type&&"unseen"==c().seen&&("frontend"==n.app.type&&"agent"==c().sender_type||"backend"==n.app.type&&"visitor"==c().sender_type)&&(a.push(c().id),setTimeout(function(){n.app&&"unseen"==c().seen&&!c()._n&&"message"==c().type&&(c(),e<c().id&&(e=c().id,f.cookieManager.setSimple("_lastmsgnotification",c().id),c().noticedone=n.app.notify("new_message",
n.app.getTransMsg("{num} new messages !"),c().message,function(){n.focus();n.$call("seen",[c().id]);n.onBroadCast(null,"seen",[c().id])})),c()._n=!0)},1E3))});return a});this.oldMessageLoadScroll(!1);this.rtcroom=new c["default"](this,f);this.event_move=function(){if(n.app){if(0<n.unseenMessages().length&&n.isVisible()){if("frontend"==n.app.type&&"min"==n.app.ui.status())return;n.$call("seen",[n.unseenMessages()]);n.onBroadCast(null,"seen",n.unseenMessages())}var f=!0,b=!1,a=void 0;try{for(var e=
n.messages()[Symbol.iterator](),c;!(f=(c=e.next()).done);f=!0){var v=c.value;v()&&v().noticedone&&(v().noticedone(),v().noticedone=void 0)}}catch(K){b=!0,a=K}finally{try{if(!f&&e["return"])e["return"]()}finally{if(b)throw a;}}}};(0,b["default"])(window).on("mousemove click scroll resize",this.event_move);(0,b["default"])(window).on("tagove_move",this.event_move);var g=!1;this.data.subscribe(function(){!n.data()||"pending"!=n.data().status||"audio"!=n.data().type&&"video"!=n.data().type||n.data.subscribe(function(){n.data()&&
"pending"==n.data().status&&n.rtcroom.myself()&&!g&&(g=!0,n.rtcroom.myself().startRTCCall("video"==n.data().type?!0:!1))})});var m={},y={},A={};this.users.subscribe(function(a){var e=void 0,c=void 0;b["default"].each(a,function(f,b){var a=b();"visitor"==a.type&&a.owner&&(e=a.id_real);"visitor"==a.type&&a.virtual&&"online"==a.state&&(c=a.id_real)});b["default"].each(a,function(v,d){var l=d(),k=l.state;"undefined"==typeof m[l.id]&&(m[l.id]=[]);"undefined"==typeof A[l.id]&&(A[l.id]=!1);"undefined"==
typeof y[l.id]&&(y[l.id]=null);-1==m[l.id].indexOf(k)&&m[l.id].push(k);if(k!=y[l.id]&&!l.me){y[l.id]=l.state;if("offline"==y[l.id])return A[l.id]=!1,m[l.id]=[],m[l.id].push(y[l.id]),!0;if(A[l.id])return!0;A[l.id]=!0;if("online"==y[l.id]&&f.myself&&"undefined"!=typeof f.myself()){var g,D,r,h,z,k=function(){var v=void 0,d=f.myself().type+"-"+f.myself().id;if("agent"==l.type&&l.id!=d){var k=f.getAgent(l.id_real);k&&(v=k.data().messenger_id)}if("visitor"==f.myself().type&&"visitor"==l.type&&l.id!=d&&
f.pairedCBUsers){g=!0;D=!1;r=void 0;try{for(h=f.pairedCBUsers[Symbol.iterator]();!(g=(z=h.next()).done);g=!0){var F=z.value;0<=F.indexOf(l.id)&&(v=F)}}catch(L){D=!0,r=L}finally{try{if(!g&&h["return"])h["return"]()}finally{if(D)throw r;}}}"agent"==f.myself().type&&"visitor"==l.type&&l.id!=d&&(d=f.visitorList().findVisitor(l.id_real))&&(v=d.data().messenger_id);var x=null,y=null;"agent"==f.myself().type&&e&&(d=f.visitorList().findVisitor(e))&&(x=d.data().messenger_id);"agent"==f.myself().type&&c&&((d=
f.visitorList().findVisitor(c))?y=d.data().messenger_id:console.error("match Virtual Visitor for Messenger : "+c+" but not in list"));f.myself();d=1<m[l.id].length;if(v&&(d||n.silentRequestCoBrowse||!l.owner)&&(m[l.id]=[],0<=f.pairedCBUsers.indexOf(v)||!l.owner&&0<=f.pairedCBUsers.indexOf(x)||y==v)){if(f.external_cobrowse())return{v:void 0};f.messengerApp(function(e){var c=[];b["default"].each(a,function(a,b){var d=b();if(!d.me){var k=null;if("agent"==f.myself().type)if("agent"==d.type){var g=n.getAgent(d.id_real);
g&&g.data().messenger_id==v&&(k=g.data().messenger_id)}else"visitor"==d.type&&(g=f.visitorList().findVisitor(d.id_real))&&(k=g.data().messenger_id);else k=v;if(k&&(g=function(){if(0<=c.indexOf(k))return{v:void 0};c.push(k);var a={chat:n.data().id};!d.owner&&x&&(a.owner=x);!d.virtual&&y&&"online"==d.state&&(a.virtual=y);n.app.socket.emit("cobrowse_ready",k,a,function(b,c){var d=f.myself().messenger_id.substr(0,16)+"@"+f.myself().type+"-"+f.myself().id;"visitor"==f.myself().type&&"visitor"==l.type&&
window.tagoveVirtulWebPage&&e.emit("external_cobrowse",d,a,[v],null);"agent"!=n.app.myself().type||c!=x&&c!=y||n.openCoBrowse(v,a,function(a){setTimeout(function(){var b=f.me().data().first_name;y&&(k=y,a.pairedLeaderId=k);e.emit("remote_start",d,{chat:n.data().id,nickname:b},[k],function(){})},0);n.coBrowsing(a)},function(f){alert(f)})})}(),"object"===typeof g))return g.v}})})}}();if("object"===typeof k)return k.v}}})});this.active.subscribe(function(){n.oldMessageLoadScroll()});"frontend"==this.app.type&&
function(){var f=h["default"].observable(0),a=Date.now();setInterval(function(){f(f()+Math.ceil((Date.now()-a)/1E3));a=Date.now()},1E4);n.ahead_chats=h["default"].computed(function(){return n.data().ahead_chats?n.data().ahead_chats:0});var b=n.data().ahead_time;n.ahead_time=h["default"].computed(function(){var a;b===n.data().ahead_time?a=n.data().ahead_time-f():(b=n.data().ahead_time,a=n.data().ahead_time);return 3600<a?Math.round(a/3600,1)+" hours":60<a?Math.round(a/60,1)+" minutes":2>a?" only a few seconds":
Math.ceil(a)+" seconds"})}();f.uiPrefetch()}E(e,l);p(e,[{key:"dispose",value:function(){this.rtcroom&&this.rtcroom.dispose();try{(0,b["default"])(window).off("mousemove click scroll resize",this.event_move),(0,b["default"])(window).off("tagove_move",this.event_move)}catch(f){}t(Object.getPrototypeOf(e.prototype),"dispose",this).call(this)}},{key:"close",value:function(){this.active(!1)}},{key:"focus",value:function(){this.app.maxM()}},{key:"getLocationUrl",value:function(f){this.app&&this.app.theFrame&&
this.app.theFrame()&&this.app.theFrame().window?f(this.app.theFrame().window.location.href):f(window.location.href)}},{key:"openChat",value:function(){}},{key:"isVisible",value:function(){return!0}},{key:"getAgent",value:function(f){return this.app.getAgent(f)}},{key:"getTitle",value:function(){return this.data()?(this.data().visitor&&""!=this.data().visitor.name?this.data().visitor_name+"-":"")+this.data().visitor_id:"noname"}},{key:"broadcast",value:function(f,a){var b=2>=arguments.length||void 0===
arguments[2]?[]:arguments[2],e=3>=arguments.length||void 0===arguments[3]?null:arguments[3];"function"!==typeof e&&(e=null);this.$call("broadcast",[f,a,b,e])}},{key:"onBroadCast",value:function(f,a,e,c){var l=this,d=this.app.myself().messenger_id.substr(0,16)+"@"+this.app.myself().type+"-"+this.app.myself().id;if(0===a.indexOf("rtc_"))this.rtcroom.onMessage(f,a.replace("rtc_",""),e,c);else if("screen_request"==a)e||confirm("undefined"!=typeof this.app.settings().screen_share_request_alert?this.app.settings().screen_share_request_alert:
this.app.getTransMsg("Would you like to share your screen with agent?"))?this.rtcroom.myself()&&this.rtcroom.myself().startScreenShare():this.broadcast("screen_response",!1,[f]);else if("document_request"==a)b["default"].ajax({url:e,success:function(a){l.app.documentFrameHtml(a);l.app.messengerApp(function(a){l.broadcast("cobrowse_response_doc",d,[f])})},error:function(){}});else if("cobrowse_request"==a)this.app.documentFrameHtml(null),e&&"undefined"!=typeof e&&"undefined"!=typeof e.autoCobrowse&&
e.autoCobrowse?this.broadcast("cobrowse_response",d,[f]):e||confirm("undefined"!=typeof this.app.settings().cobrowse_request_alert?this.app.settings().cobrowse_request_alert:this.app.getTransMsg("Would you like to allow agent to CoBrowse with you?"))?this.app.messengerApp(function(a){l.broadcast("cobrowse_response",d,[f])}):this.broadcast("cobrowse_response",!1,[f]);else if("redirect_request"==a)0!==e.indexOf("https://")&&0!==e.indexOf("http://")&&(e=window.location.protocol+"//"+e),a=document.createElement("a"),
a.href=e,a.host==window.location.host?this.app.theFrame()&&this.app.theFrame().window?this.app.theFrame().window.location.href=e:window.location.href=e:window.open(e,"_blank").focus();else if("screenshot_request"==a)u.e(7,function(f){f=[f(503)];(function(f){f(window.document.body,{onrendered:function(f){(f=f.toDataURL("image/png"))&&l.broadcast("screenshot_file",f)}})}).apply(null,f)});else if("speedtest_request"==a)g["default"].get().takeFullSpeedTest(function(f){l.broadcast("speedtest_result",{result:f,
"final":1>=arguments.length||void 0===arguments[1]?!1:arguments[1]})});else if("seen"==a)b["default"].each(this.messages(),function(f,a){0<=e.indexOf(a().id)&&(a().seen="seen",a.valueHasMutated())});else if("ask_to_visior"==a){this.ask_to_visitor_popup(e);a=this.data()&&this.data().details?this.data().details.name:null;c=this.data()&&this.data().details?this.data().details.email:null;var v=this.data()&&this.data().details?this.data().details.phone:null,n=this.app.form_settings().ask_to_visitor_title;
n||""===n||(n=this.app.getTransMsg("Please fill the above detail to making our interaction more closer."));this.visitor_name(a);this.visitor_email(c);this.visitor_phone(v);this.ask_to_visitor_title(n)}}},{key:"uiRequired",value:function(){return!0}},{key:"typed",value:function(f,a){var b=this;if(this&&this.typingText&&"active"==this.data().status&&(this.typingText(this.app.filterTransMsg(f,"system")),0<a))var e=this._typedLastTimer=setTimeout(function(){b._typedLastTimer==e&&b.typingText(null)},a)}},
{key:"getAccountLanguage",value:function(f){b["default"].ajax({url:this.app.account().reseller_app_url+"/site/languagecode",type:"POST",dataType:"json",data:{account_id:this.app.account().uid},cache:!1,success:function(a){f(null,a)},error:function(a){console.log("server error");f("server error","en")}})}},{key:"tranlateMessage",value:function(f,e,c){if(this.translate_mode()){var l=this.translate_from();b["default"].ajax({url:a["default"].server+"/translate",data:{text:f,from:l,to:e},type:"POST",dataType:"json",
cache:!1,success:function(a){a.text&&a.text.translatedText?c(a.text.translatedText,!0):(c(f,!0),console.log(a))},error:function(a){console.log(a);c(f,!0)}})}else c(f,!1)}},{key:"askNextQuestion",value:function(){var f=0>=arguments.length||void 0===arguments[0]?"":arguments[0],a="";this.stop_timer=null;"name"==f?"on"==tagoveApp.form_settings().offline_name?((a=tagoveApp.form_settings().bot_name_message)||""===a||(a=tagoveApp.getTransMsg("Hi, as the Tagove Bot it's my job to make sure you get connected to the right team member. Let's start by capturing your name...")),
this.process_on_visitor_input="name"):this.askNextQuestion("email"):"email"==f?"on"==tagoveApp.form_settings().offline_email?((a=tagoveApp.form_settings().bot_email_message)||""===a||(a=tagoveApp.getTransMsg("So we can reach back out to you, what is your email address ?")),this.process_on_visitor_input="email"):this.askNextQuestion("phone"):"invalid-email"==f?"on"==tagoveApp.form_settings().offline_email?((a=tagoveApp.form_settings().bot_invalid_email_message)||""===a||(a=tagoveApp.getTransMsg("Please type a valid email address, it must be in correct format.")),
this.process_on_visitor_input="email"):this.askNextQuestion("phone"):"phone"==f?"on"==tagoveApp.form_settings().offline_phone?((a=tagoveApp.form_settings().bot_phone_message)||""===a||(a=tagoveApp.getTransMsg("So we can reach you faster, what is your direct number ?")),this.process_on_visitor_input="phone"):this.askNextQuestion("message"):"invalid-phone"==f?"on"==tagoveApp.form_settings().offline_phone?((a=tagoveApp.form_settings().bot_invalid_phone_message)||""===a||(a=tagoveApp.getTransMsg("Please type a valid phone number, it must be in correct format.")),
this.process_on_visitor_input="phone"):this.askNextQuestion("message"):"message"==f?"on"==tagoveApp.form_settings().offline_message?((a=tagoveApp.form_settings().bot_query_message)||""===a||(a=tagoveApp.getTransMsg("Awesome! What brought you to Tagove ? simply leave a message.")),this.process_on_visitor_input="message"):this.askNextQuestion("xyz"):"success-message"==f?((a=tagoveApp.form_settings().bot_success_query_message)||""===a||(a=tagoveApp.getTransMsg("I got your message and forwarded to our team. They will get back to you asap!")),
this.process_on_visitor_input="wait"):"wait"==f?(a=tagoveApp.getTransMsg("I already sent your message to our team. Be patience, we will reply soon."),this.process_on_visitor_input="wait"):(a=tagoveApp.getTransMsg("Something went wrong, Try after few moments."),this.process_on_visitor_input="error");a&&(this.typingText(null),this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"agent",sender_id:1,type:"message",date_created:r["default"].toMysqlTime(new Date),message:a,user:{name:"Bot",
photo:null},seen:"seen"}))}},{key:"botTypingMessage",value:function(){var a=this;"active-bot"==this.data().status&&setTimeout(function(){var f=tagoveApp.getTransMsg("Please wait, Bot typing...");a.typingText(f)},600)}},{key:"submitMessage",value:function(a,e){var f=this;if(2>=arguments.length||void 0===arguments[2]?0:arguments[2])var c=(0,b["default"])(e.target);else c=e.target,c=(0,b["default"])(c).parents(".message-input").find("textarea");if(""!=b["default"].trim(c.val())){if(""!==c.val()&&c.val()){var l=
c.val(),d=tagoveApp.form_settings().offline_form_type;d||""===d||(d="form");if("bot"==d&&"active-bot"==this.data().status){d=!1;if("name"==this.process_on_visitor_input)this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),message:c.val(),user:{name:"Visitor",photo:null},seen:"seen"}),this.init_visitor_name(this.init_visitor_name()+" "+c.val()),this.botTypingMessage(),this.stop_timer||(this.stop_timer=
setTimeout(function(){f.askNextQuestion("email")},1800)),(0,b["default"])(c).val("");else if("email"==this.process_on_visitor_input){this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),message:c.val(),user:{name:"Visitor",photo:null},seen:"seen"});var k=c.val();if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(k)){this.botTypingMessage();
this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("invalid-email")},1800));(0,b["default"])(c).val("");return}this.init_visitor_email(c.val());this.botTypingMessage();this.stop_timer=setTimeout(function(){f.askNextQuestion("phone")},1800);(0,b["default"])(c).val("")}else if("phone"==this.process_on_visitor_input){this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),message:c.val(),
user:{name:"Visitor",photo:null},seen:"seen"});k=c.val();if(!/^(\+?\d{1,3}[- ]?)?(\([0-9]{3}\)[ ]?|[0-9]{3}[- ]?)[0-9]{3}[- ]?[0-9]{1,4}([x]\d{1,10})?$/.test(k)){this.botTypingMessage();this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("invalid-phone")},1800));(0,b["default"])(c).val("");return}this.init_visitor_phone(c.val());this.botTypingMessage();this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("message")},1800));(0,b["default"])(c).val("")}else"message"==
this.process_on_visitor_input?(this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),message:c.val(),user:{name:"Visitor",photo:null},seen:"seen"}),this.init_visitor_message(this.init_visitor_message()+" "+c.val()),this.botTypingMessage(),this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("success-message")},1800)),(0,b["default"])(c).val(""),d=!0):("wait"==this.process_on_visitor_input?
(this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),message:c.val(),user:{name:"Visitor",photo:null},seen:"seen"}),this.botTypingMessage(),this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("wait")},1800))):"error"==this.process_on_visitor_input?(this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),
message:c.val(),user:{name:"Visitor",photo:null},seen:"seen"}),this.botTypingMessage(),this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("error")},1800))):(this.addMessage({id:this.custome_chat_id++,chat_id:1,sender_type:"visitor",sender_id:0,type:"message",date_created:r["default"].toMysqlTime(new Date),message:c.val(),user:{name:"Visitor",photo:null}}),this.botTypingMessage(),this.stop_timer||(this.stop_timer=setTimeout(function(){f.askNextQuestion("wait")},1800))),(0,b["default"])(c).val(""));
if(d){var v;(function(){var a=[];f.messages().forEach(function(f){a.push({user:f().user.name,message:f().message,date_created:f().date_created})});0<a.length&&(v=tagoveApp.selected_agent(),f.app.socket.emit("offline_message",{agent:v,name:f.init_visitor_name(),email:f.init_visitor_email(),phone:f.init_visitor_phone(),message:f.init_visitor_message(),chatscript:JSON.parse(JSON.stringify(a)),page:window.location.href,type:"bot",remarks:"",reseller_id:f.app.account()&&f.app.account().reseller_id?f.app.account().reseller_id:
"1"},function(a,f){a&&alert(a)}))})()}}else{var g="en";"agent"==this.app.myself().type&&(g=this.translate_to());"visitor"==this.app.myself().type&&(g=this.account_translate_language());this.tranlateMessage(l,g,function(a,e){if(e){var b="#TRANSLATED#:"+JSON.stringify({message:l,translated_text:a,translated_language:g});f.$call("addMessage",["message",b])}else f.$call("addMessage",["message",l])});this.textMessage&&(this.textMessage(""),this.voiceTypingText="");(0,b["default"])(c).val("")}}return!0}}},
{key:"translate_show",value:function(a){var f=this;"translated"==a?(this.translate_mode(!0),this.$call("update_translate_mode",[!0,this.account_translate_language()])):(this.translate_mode(!1),this.$call("update_translate_mode",[!1,this.account_translate_language()]));b["default"].each(this.messages(),function(e,b){"system"!==b().sender_type&&"agent"!==b().sender_type&&(b().translation_mode=a,f.updateMessage(b().id,b()))})}},{key:"update_translate_mode",value:function(a,e){var f=this;b["default"].each(this.messages(),
function(b,c){c().id==a&&(c().translation_mode=e,f.updateMessage(c().id,c()))})}},{key:"checkMsgTyped",value:function(a,e){var f=this,c=e.target;13!==e.keyCode&&"active-bot"!=this.data().status&&m(function(){f.$call("typed",[c.value])});""==b["default"].trim(c.value)&&(this.voiceTypingText="");""!==b["default"].trim(c.value)&&(this.voiceTypingText=c.value);if(13==e.keyCode){if(""==b["default"].trim(c.value))return;if(!e.shiftKey){if("active-bot"!=this.data().status)if(""!==c.value&&c.value){if(1==
(0,b["default"])(c).parents(".chat-pop-box").find(".atwho-container>div>div.atwho-view:visible").length)return!0;var l="en";"agent"==this.app.myself().type&&(l=this.translate_to());"visitor"==this.app.myself().type&&(l=this.account_translate_language());var d=c.value;this.tranlateMessage(d,l,function(a,e){if(e){var b="#TRANSLATED#:"+JSON.stringify({message:d,translated_text:a,translated_language:l});f.$call("addMessage",["message",b])}else f.$call("addMessage",["message",d])});this.textMessage&&(this.textMessage(""),
this.voiceTypingText="")}else return!0;else this.submitMessage(a,e,"1");c.value="";return!1}}return!0}},{key:"oldMessageLoadScroll",value:function(){var a=this,e=0>=arguments.length||void 0===arguments[0]?!1:arguments[0];(!e||120>=(0,b["default"])(e).scrollTop())&&this.loadingMessages&&!this.loadingMessages()&&this.active()&&(e=0<this.messages().length?this.messages()[0]().id:999999999998,this.loadedHistory()!=e&&(this.loadedHistory(e),this.loadingMessages(!0),0==this.messages().length&&this.loadingMessages(!1),
setTimeout(function(){a.app&&a.$call("getLast20Messages",[a.loadedHistory(),function(f,e){b["default"].each(e,function(f,e){a.addMessage(e,!0)});a.loadingMessages(!1)}])},700)))}},{key:"scrollAlwaysBottom",value:function(){}},{key:"addSelfMessage",value:function(a){a=b["default"].extend({chat_id:this._data().id,sender_type:this.app.myself().type,sender_id:this.app.myself().id,date_created:r["default"].toMysqlTime()},a);this.addMessage(a)}},{key:"updateMessage",value:function(a,e){var f=!1;b["default"].each(this.messages(),
function(e,b){b().id==a&&(f=b)});if(null===e)return this.messages.remove(f);f&&f(b["default"].extend(f(),e))}},{key:"filterMsg",value:function(a){return this.app.filterMsg(a)}},{key:"setTranslateLanguage",value:function(a){this.translate_mode()||(this.translate_to(a),this.translate_form_show(!0))}},{key:"update_translating_mode",value:function(a){this.translate_mode(a)}},{key:"update_chat_message",value:function(a,e){this.updateMessage(a,e)}},{key:"addMessage",value:function(a){var f=this,e=1>=arguments.length||
void 0===arguments[1]?!1:arguments[1];""==this.account_translate_language()?this.getAccountLanguage(function(b,c){f.$call("updateAccountLanguage",[c]);f.account_translate_language(c);f.addMessage2(a,e)}):this.addMessage2(a,e)}},{key:"addMessage2",value:function(f){var e=1>=arguments.length||void 0===arguments[1]?!1:arguments[1];if(this.app){var c=!1;b["default"].each(this.messages(),function(a,e){e().id==f.id&&(c=!0)});if(!c){if(f.message&&"file"==f.type)try{var l=JSON.parse(f.message);f.message=
"";f=b["default"].extend(f,l)}catch(F){}if("message"==f.type&&f.message.startsWith("#TRANSLATED#:")){f.message=f.message.replace("#TRANSLATED#:","");try{var d=JSON.parse(f.message);f=b["default"].extend(f,d);f.type="translated"}catch(F){}}l=this.translate_mode()&&"visitor"==f.sender_type&&"backend"==this.app.type?"translated":"agent"==f.sender_type&&"frontend"==this.app.type?"translated":"orignal";l=h["default"].observable(b["default"].extend({id:"",chat_id:"",sender_type:"",sender_id:"",type:"",
date_created:"",message:"",user:{name:"",photo:null},translation_mode:l},f));"visitor"==f.sender_type&&(l().user.photo=a["default"].mediaDefaultVisitorPhoto);e?(0<this.messages().length&&"message"==l().type&&"message"==this.messages()[0]().type&&(this.messages()[0](),l()),this.messages.unshift(l)):(0<this.messages().length&&"message"==l().type&&"message"==this.messages()[this.messages().length-1]().type&&(this.messages()[this.messages().length-1](),l()),this.messages.push(l))}}}},{key:"afterChatEmailStep",
value:function(){var a=this.data().details.phone,e=this.data().details.email;!this.app.form_settings()||"on"!=this.app.form_settings().online_email||"optional_after_chat"!=this.app.form_settings().online_email_req&&"after_chat"!=this.app.form_settings().online_email_req?this.afterChatPhoneStep():"undefined"===typeof e||"undefined"!==typeof e&&null!=e&&0==e.length?("undefined"!==typeof a&&0<a.length&&this.prepopup_phone_val(a),(a=this.app.form_settings().online_email_after_chat_text)||""===a||(a=this.app.getTransMsg("Please fill your email, we will reply you soon.")),
this.prepopup_email_display(!0),this.prepopup_email_title(a)):(this.prepopup_email_val(e),this.afterChatPhoneStep())}},{key:"afterChatPhoneStep",value:function(){var a=this.data().details.phone,e=this.data().details.email;!this.app.form_settings()||"on"!=this.app.form_settings().online_phone||"optional_after_chat"!=this.app.form_settings().online_phone_req&&"after_chat"!=this.app.form_settings().online_phone_req?this.afterChatNotifiedStep():"undefined"===typeof a||"undefined"!==typeof a&&null!=a&&
0==a.length?("undefined"!==typeof e&&null!=e&&0<e.length&&this.prepopup_email_val(e),(a=this.app.form_settings().online_phone_after_chat_text)||""===a||(a=this.app.getTransMsg("Please fill your phone, we will reply you soon.")),this.prepopup_email_display(!1),this.prepopup_phone_display(!0),this.prepopup_phone_title(a)):(this.prepopup_phone_val(a),this.afterChatNotifiedStep())}},{key:"afterChatNotifiedStep",value:function(){var a=this.data()&&this.data().details?this.data().details.phone:null,e=this.data()&&
this.data().details?this.data().details.email:null;"undefined"!==typeof e&&null!==e&&0<e.length&&""==this.prepopup_email_val()&&this.prepopup_email_val(e);"undefined"!==typeof a&&null!==a&&0<a.length&&""==this.prepopup_phone_val()&&this.prepopup_phone_val(a);if(""!=this.prepopup_email_val()||""!=this.prepopup_phone_val())(a=this.app.form_settings().chat_wait_notified_title)||""===a||(a=this.app.getTransMsg("You will be notified soon. Stay with us!!!")),this.prepopup_notified_title(a),this.prepopup_email_display(!1),
this.prepopup_phone_display(!1),this.prepopup_notified_display(!0)}},{key:"saveAfterChatVisitorData",value:function(a){var e=this,f=b["default"].trim(this.prepopup_email_val()),c=b["default"].trim(this.prepopup_phone_val()),l=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,d=/^(\+?\d{1,3}[- ]?)?(\([0-9]{3}\)[ ]?|[0-9]{3}[- ]?)[0-9]{3}[- ]?[0-9]{1,4}([x]\d{1,10})?$/;setTimeout(function(){if("email"==
a){if(0==f.length){alert("Please fill the email.");return}if(""!==f&&!l.test(f)){alert("Please enter a valid email.");return}}else{if(0==c.length){alert("Please fill the phone number.");return}if(0<c.length&&!d.test(c)){alert("Please enter a valid phone number.");return}}setTimeout(function(){e.$call("updateVisitorInfo",[{email:f,phone:c},function(a,b){if(a)return alert(a);""!==f&&""==c?(e.prepopup_email_val(f),e.afterChatPhoneStep()):""!==c&&""==f?(e.prepopup_phone_val(c),e.afterChatNotifiedStep()):
""!==c&&""!==f&&(e.prepopup_email_val(f),e.prepopup_phone_val(c),e.afterChatNotifiedStep())}])},300)},500)}},{key:"visitorKeyPress",value:function(a,e){return 13===e.keyCode?!1:!0}},{key:"saveVisitorData",value:function(a){var e=this,f=b["default"].trim(this.visitor_name()),c=b["default"].trim(this.visitor_email()),l=b["default"].trim(this.visitor_phone()),d=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
k=/^(\+?\d{1,3}[- ]?)?(\([0-9]{3}\)[ ]?|[0-9]{3}[- ]?)[0-9]{3}[- ]?[0-9]{1,4}([x]\d{1,10})?$/;setTimeout(function(){f&&c&&l?d.test(c)?k.test(l)?setTimeout(function(){e.$call("updateVisitorInfo",[{name:f,email:c,phone:l},function(a,f){if(a)return alert(a);e.ask_to_visitor_popup(!1);e.broadcast("response_ask_to_visitor",!0)}])},300):alert("Please enter a valid phone number."):alert("Please enter a valid email."):alert("Please fill all the details.")},500)}}],[{key:"getClassName",value:function(){return"chat"}}]);
return e}(q["default"].SocketObject);C["default"]=q;B.exports=C["default"]},499:function(B,C,u){function w(c){return c&&c.__esModule?c:{"default":c}}function E(c,b){if(!(c instanceof b))throw new TypeError("Cannot call a class as a function");}Object.defineProperty(C,"__esModule",{value:!0});var p=function(){function c(c,a){for(var b=0;b<a.length;b++){var d=a[b];d.enumerable=d.enumerable||!1;d.configurable=!0;"value"in d&&(d.writable=!0);Object.defineProperty(c,d.key,d)}}return function(b,a,k){a&&
c(b.prototype,a);k&&c(b,k);return b}}();B=u(500);w(B);B=u(501);var t=w(B);B=u(160);var q=w(B);B=u(1);var h=w(B);B=u(502);var b=w(B);u=u(280);w(u);C.SyncUsersClass=function g(a,b,d,r,m){var l=this;E(this,g);var e,f=[],k=function(){if(m(l)){var k=!0,g=!1,v=void 0;try{for(var h=a.users()[Symbol.iterator](),q;!(k=(q=h.next()).done);k=!0){var x=q.value;0>f.indexOf(x)&&x&&r(x.user().id,x)&&(b(x.user().id,x),f.push(x))}}catch(H){g=!0,v=H}finally{try{if(!k&&h["return"])h["return"]()}finally{if(g)throw v;
}}k=!0;g=!1;v=void 0;try{for(var y=f[Symbol.iterator](),A;!(k=(A=y.next()).done);k=!0)x=A.value,0>a.users().indexOf(x)&&x&&(d(x.user().id,x),f.splice(f.indexOf(x),1))}catch(H){g=!0,v=H}finally{try{if(!k&&y["return"])y["return"]()}finally{if(g)throw v;}}}else e&&e.dispose(),e=null,f=[]};e=a.users.subscribe(k);setTimeout(k,0)};u=function(){function g(a,k){var d=this;E(this,g);this.chat=a;this.app=k;this._dispose=[];this.logger=k.logger.logger(a.data.id);this.call_sound=k.getSound("call");this.users=
q["default"].observableArray([]);this.clientPopState=q["default"].observable(!1);this.clientPopState.subscribe(function(){h["default"].each(d.users(),function(a,b){"standby"!=b.status()&&b.msg("rtc_full_screen",d.clientPopState());"standby"!=b.screen_status()&&b.msg("screen_full_screen",d.clientPopState())})});this.myself=q["default"].observable(null);this._req={};this.call_id=q["default"].observable(null);this.call_time=q["default"].observable(0);this.timeEc=q["default"].computed(function(){var a=
Math.floor(d.call_time()/3600),b=Math.floor((d.call_time()-3600*a)/60),e=d.call_time()-3600*a-60*b;return a+":"+b+":"+e});var r=setInterval(function(){d.call_time&&d.call_time()&&0!==d.call_time()&&d.call_time(d.call_time()+1)},1E3);this._dispose.push(function(){clearInterval(r)});this.incall=q["default"].computed(function(){return d.myself()?"standby"!==d.myself().status():!1});this.inscreencall=q["default"].computed(function(){return d.myself()?"standby"!==d.myself().screen_status():!1});this.fullscreen=
q["default"].observable(!1);this.fullscreen.subscribe(function(){"undefined"!=typeof d.chat.active_tab&&(d.fullscreen()?d.chat.active_tab("rtc"):d.chat.active_tab("chat"))});this.rtcUsers=q["default"].computed(function(){var a=[];h["default"].each(d.users(),function(b,e){"joined"==e.status()&&a.push(e)});return a});this.rtcAUsers=q["default"].computed(function(){var a=[];h["default"].each(d.rtcUsers(),function(b,e){d.activeInRoom()!==e&&a.push(e)});return a});this.mediaRecorder=q["default"].observable(null);
this.callType=q["default"].computed(function(){var a=null,b=!0,e=!1,f=void 0;try{for(var k=d.users()[Symbol.iterator](),g;!(b=(g=k.next()).done);b=!0){var r=g.value;if(0<=r.stream_type().indexOf("video")||0<=r.stream_type().indexOf("video_only")){a="video";break}if(0<=r.stream_type().indexOf("audio")||0<=r.stream_type().indexOf("audio_only")){a="video"==a?a:"audio";break}}}catch(z){e=!0,f=z}finally{try{if(!b&&k["return"])k["return"]()}finally{if(e)throw f;}}if(d.myself()){if(0<=d.myself().stream_type().indexOf("video")||
0<=d.myself().stream_type().indexOf("video_only"))a="video";if(0<=d.myself().stream_type().indexOf("audio")||0<=d.myself().stream_type().indexOf("audio_only"))a="video"==a?a:"audio"}return a});this.screenUsers=q["default"].computed(function(){var a=[];h["default"].each(d.users(),function(b,e){"joined"==e.screen_status()&&a.push(e)});d.chat&&d.chat.app&&d.chat.app.popup_mode_sections&&(0<a.length?d.chat.app.popup_mode_sections&&0>d.chat.app.popup_mode_sections.indexOf("screen")&&d.chat.app.popup_mode_sections.push("screen"):
d.chat.app.popup_mode_sections&&0<=d.chat.app.popup_mode_sections.indexOf("screen")&&d.chat.app.popup_mode_sections.remove("screen"));return a});a.users.subscribe(function(a){h["default"].each(a,function(a,e){var f=e();f.rtc||(f.rtc=new b["default"](e,d));f.me?d.myself()!==f.rtc&&(d.myself(f.rtc),h["default"].each(d.users(),function(a,e){e==f.rtc&&d.users.remove(e)})):0>d.users().indexOf(f.rtc)&&(d.users.push(f.rtc),d.myself()===f.rtc&&d.myself(null))});h["default"].each(d.users(),function(b,e){var f=
!1;h["default"].each(a,function(a,b){b().rtc==e&&(f=!0)});f||(d.users.remove(e),e&&d.myself()===e.rtc&&d.myself(null))})});this.doChromeExtInstall=q["default"].observable(!1);h["default"].each(a.users(),function(a,l){l().rtc=new b["default"](l,d);l.me?d.myself(l.rtc):d.users.push(l().rtc)});this._activeInRoom=q["default"].observable();this.activeInRoom=q["default"].computed({read:function(){if(0==d.rtcUsers().length)return d._activeInRoom(null),null;d._activeInRoom()||"Mobile Safari"!=window.parserResult.browser.name&&
d._activeInRoom(d.rtcUsers()[0]);return d._activeInRoom()},write:function(a){d._activeInRoom(a)}});this.rtcScreenAUsers=q["default"].computed(function(){var a=[];h["default"].each(d.screenUsers(),function(b,e){d.activeScreenRoom()!==e&&a.push(e)});return a});this._activeScreenRoom=q["default"].observable();this.activeScreenRoom=q["default"].computed({read:function(){if(0==d.screenUsers().length)return d._activeScreenRoom(null),null;d._activeScreenRoom()||d._activeScreenRoom(d.screenUsers()[0]);return d._activeScreenRoom()},
write:function(a){d._activeScreenRoom(a)}});q["default"].computed(function(){var a=d.incall()||d.inscreencall();d.mediaRecorder()&&d.mediaRecorder().incall(a)});this.incall.subscribe(function(){d.incall()?0===d.call_time()&&d.call_time(1):d.call_time(0)});this.app.socket&&this.app.socket.emit("rtc_turn_servers",function(a,b){if(2>=arguments.length||void 0===arguments[2]?0:arguments[2])t["default"].forceTurnServer=!0,t["default"].PeerConnectionConfig.iceServers=[];if(a)return console.error(a);b=b?
b.concat(t["default"].PeerConnectionConfig.iceServers):t["default"].PeerConnectionConfig.iceServers;t["default"].PeerConnectionConfig.bundlePolicy="max-bundle";t["default"].PeerConnectionConfig.rtcpMuxPolicy="require";t["default"].PeerConnectionConfig.iceServers=b})}p(g,[{key:"dispose",value:function(){this.myself&&this.myself()&&(this.myself().stopRTCCall(),this.myself().stopScreenCall());if(this._dispose){var a=!0,b=!1,d=void 0;try{for(var g=this._dispose[Symbol.iterator](),m;!(a=(m=g.next()).done);a=
!0){var l=m.value;l()}}catch(v){b=!0,d=v}finally{try{if(!a&&g["return"])g["return"]()}finally{if(b)throw d;}}}for(var e in this)this[e]&&"undefined"!=typeof this[e]._subscriptions&&this[e].dispose&&this[e].dispose();for(e in this){if(this[e]&&"undefined"!=typeof this[e]._subscriptions&&this[e].dispose)for(var f in this[e])delete this[e][f];delete this[e]}}},{key:"refreshMyRTCStatus",value:function(){var a=!1;h["default"].each(this.users(),function(b,d){"standby"!==d.status()&&(a=!0)});!a&&this.myself()&&
(this.myself().status("standby"),this.myself().stopRTCCall(!1))}},{key:"refreshMyScreenStatus",value:function(){var a=!1;h["default"].each(this.users(),function(b,d){"standby"!==d.screen_status()&&(a=!0)});!a&&this.myself()&&(this.myself().screen_status("standby"),this.myself().stopScreenCall(!1))}},{key:"ensureCallId",value:function(){var a=0>=arguments.length||void 0===arguments[0]?null:arguments[0];this.call_id(21E3*Math.random());return a()}},{key:"onMessage",value:function(a,b,d,g){var k=null;
h["default"].each(this.users(),function(b,e){e.user().id==a&&(k=e)});if(null!=a&&null==k)console.error("user sending message but not in online list.."),console.error(d);else this.onMessageUser(k,b,d,g)}},{key:"onMessageUser",value:function(a,b,d,g){if(a&&this.myself())this.myself().onMsg(a,b,d,g)}},{key:"sendMessage",value:function(a,b,d){void 0===a&&(a=null);var k=3>=arguments.length||void 0===arguments[3]?null:arguments[3];a=a?[a.user().id]:[];this.chat.broadcast("rtc_"+b,d,a,k)}}]);return g}();
C["default"]=u},500:function(B,C,u){(function(u){B.exports=function(){return function p(t,q,h){function b(a,k){if(!q[a]){if(!t[a]){if(c)return c(a,!0);var d=Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d;}d=q[a]={exports:{}};t[a][0].call(d.exports,function(c){var d=t[a][1][c];return b(d?d:c)},d,d.exports,p,t,q,h)}return q[a].exports}for(var c=!1,g=0;g<h.length;g++)b(h[g]);return b}({1:[function(p,t,q){function h(a,b,c,l){b=k.writeRtpDescription(a.kind,b);b+=k.writeIceParameters(a.iceGatherer.getLocalParameters());
b+=k.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active");b+="a=mid:"+a.mid+"\r\n";b=a.direction?b+("a="+a.direction+"\r\n"):a.rtpSender&&a.rtpReceiver?b+"a=sendrecv\r\n":a.rtpSender?b+"a=sendonly\r\n":a.rtpReceiver?b+"a=recvonly\r\n":b+"a=inactive\r\n";a.rtpSender&&(c="msid:"+l.id+" "+a.rtpSender.track.id+"\r\n",b=b+("a="+c)+("a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+c),a.sendEncodingParameters[0].rtx&&(b+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+
c,b+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n"));b+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+k.localCName+"\r\n";a.rtpSender&&a.sendEncodingParameters[0].rtx&&(b+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+k.localCName+"\r\n");return b}function b(a,b){var c=!1;a=JSON.parse(JSON.stringify(a));return a.filter(function(a){if(a&&(a.urls||a.url)){var e=a.urls||a.url;a.url&&!a.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");
var f="string"===typeof e;f&&(e=[e]);e=e.filter(function(a){return 0!==a.indexOf("turn:")||-1===a.indexOf("transport=udp")||-1!==a.indexOf("turn:[")||c?0===a.indexOf("stun:")&&14393<=b&&-1===a.indexOf("?transport=udp"):c=!0});delete a.url;a.urls=f?e[0]:e;return!!e.length}return!1})}function c(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]},l=function(a,b){a=parseInt(a,10);for(var e=0;e<b.length;e++)if(b[e].payloadType===a||b[e].preferredPayloadType===a)return b[e]},e=function(a,b,e,c){a=
l(a.parameters.apt,e);b=l(b.parameters.apt,c);return a&&b&&a.name.toLowerCase()===b.name.toLowerCase()};a.codecs.forEach(function(f){for(var l=0;l<b.codecs.length;l++){var d=b.codecs[l];if(f.name.toLowerCase()===d.name.toLowerCase()&&f.clockRate===d.clockRate&&("rtx"!==f.name.toLowerCase()||!f.parameters||!d.parameters.apt||e(f,d,a.codecs,b.codecs))){d=JSON.parse(JSON.stringify(d));d.numChannels=Math.min(f.numChannels,d.numChannels);c.codecs.push(d);d.rtcpFeedback=d.rtcpFeedback.filter(function(a){for(var b=
0;b<f.rtcpFeedback.length;b++)if(f.rtcpFeedback[b].type===a.type&&f.rtcpFeedback[b].parameter===a.parameter)return!0;return!1});break}}});a.headerExtensions.forEach(function(a){for(var e=0;e<b.headerExtensions.length;e++){var f=b.headerExtensions[e];if(a.uri===f.uri){c.headerExtensions.push(f);break}}});return c}function g(a,b,c){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer",
"have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[b][a].indexOf(c)}function a(a,b){var c=a.getRemoteCandidates().find(function(a){return b.foundation===a.foundation&&b.ip===a.ip&&b.port===a.port&&b.priority===a.priority&&b.protocol===a.protocol&&b.type===a.type});c||a.addRemoteCandidate(b);return!c}var k=p("sdp");t.exports=function(d,r){var m=function(a){var e=this,c=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){e[a]=
c[a].bind(c)});this.canTrickleIceCandidates=this.ondatachannel=this.onnegotiationneeded=this.onicegatheringstatechange=this.oniceconnectionstatechange=this.onsignalingstatechange=this.onremovestream=this.ontrack=this.onaddstream=this.onicecandidate=null;this.needNegotiation=!1;this.localStreams=[];this.remoteStreams=[];this.remoteDescription=this.localDescription=null;this.signalingState="stable";this.iceGatheringState=this.iceConnectionState="new";a=JSON.parse(JSON.stringify(a||{}));this.usingBundle=
"max-bundle"===a.bundlePolicy;if("negotiate"===a.rtcpMuxPolicy)throw a=Error("rtcpMuxPolicy 'negotiate' is not supported"),a.name="NotSupportedError",a;a.rtcpMuxPolicy||(a.rtcpMuxPolicy="require");switch(a.iceTransportPolicy){case "all":case "relay":break;default:a.iceTransportPolicy="all"}switch(a.bundlePolicy){case "balanced":case "max-compat":case "max-bundle":break;default:a.bundlePolicy="balanced"}a.iceServers=b(a.iceServers||[],r);this._iceGatherers=[];if(a.iceCandidatePoolSize)for(var l=a.iceCandidatePoolSize;0<
l;l--)this._iceGatherers=new d.RTCIceGatherer({iceServers:a.iceServers,gatherPolicy:a.iceTransportPolicy});else a.iceCandidatePoolSize=0;this._config=a;this.transceivers=[];this._sdpSessionId=k.generateSessionId();this._sdpSessionVersion=0};m.prototype._emitGatheringStateChange=function(){var a=new Event("icegatheringstatechange");this.dispatchEvent(a);if("function"===typeof this.onicegatheringstatechange)this.onicegatheringstatechange(a)};m.prototype.getConfiguration=function(){return this._config};
m.prototype.getLocalStreams=function(){return this.localStreams};m.prototype.getRemoteStreams=function(){return this.remoteStreams};m.prototype._createTransceiver=function(a){var b=0<this.transceivers.length;a={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:a,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,wantReceive:!0};this.usingBundle&&b?(a.iceTransport=this.transceivers[0].iceTransport,
a.dtlsTransport=this.transceivers[0].dtlsTransport):(b=this._createIceAndDtlsTransports(),a.iceTransport=b.iceTransport,a.dtlsTransport=b.dtlsTransport);this.transceivers.push(a);return a};m.prototype.addTrack=function(a,b){for(var e,c=0;c<this.transceivers.length;c++)this.transceivers[c].track||this.transceivers[c].kind!==a.kind||(e=this.transceivers[c]);e||(e=this._createTransceiver(a.kind));this._maybeFireNegotiationNeeded();-1===this.localStreams.indexOf(b)&&this.localStreams.push(b);e.track=
a;e.stream=b;e.rtpSender=new d.RTCRtpSender(a,e.dtlsTransport);return e.rtpSender};m.prototype.addStream=function(a){var b=this;if(15025<=r)a.getTracks().forEach(function(e){b.addTrack(e,a)});else{var c=a.clone();a.getTracks().forEach(function(a,b){var e=c.getTracks()[b];a.addEventListener("enabled",function(a){e.enabled=a.enabled})});c.getTracks().forEach(function(a){b.addTrack(a,c)})}};m.prototype.removeStream=function(a){a=this.localStreams.indexOf(a);-1<a&&(this.localStreams.splice(a,1),this._maybeFireNegotiationNeeded())};
m.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})};m.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})};m.prototype._createIceGatherer=function(a,b){var e=this;if(b&&0<a)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var c=new d.RTCIceGatherer({iceServers:this._config.iceServers,
gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(c,"state",{value:"new",writable:!0});this.transceivers[a].candidates=[];this.transceivers[a].bufferCandidates=function(b){var f=!b.candidate||0===Object.keys(b.candidate).length;c.state=f?"completed":"gathering";null!==e.transceivers[a].candidates&&e.transceivers[a].candidates.push(b.candidate)};c.addEventListener("localcandidate",this.transceivers[a].bufferCandidates);return c};m.prototype._gather=function(a,b){var e=this,c=this.transceivers[b].iceGatherer;
if(!c.onlocalcandidate){var l=this.transceivers[b].candidates;this.transceivers[b].candidates=null;c.removeEventListener("localcandidate",this.transceivers[b].bufferCandidates);c.onlocalcandidate=function(f){if(!(e.usingBundle&&0<b)){var d=new Event("icecandidate");d.candidate={sdpMid:a,sdpMLineIndex:b};var l=f.candidate;if(f=!l||0===Object.keys(l).length){if("new"===c.state||"gathering"===c.state)c.state="completed"}else"new"===c.state&&(c.state="gathering"),l.component=1,d.candidate.candidate=k.writeCandidate(l);
l=k.splitSections(e.localDescription.sdp);l[d.candidate.sdpMLineIndex+1]=f?l[d.candidate.sdpMLineIndex+1]+"a=end-of-candidates\r\n":l[d.candidate.sdpMLineIndex+1]+("a="+d.candidate.candidate+"\r\n");e.localDescription.sdp=l.join("");l=e.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});"gathering"!==e.iceGatheringState&&(e.iceGatheringState="gathering",e._emitGatheringStateChange());if(!f&&(e.dispatchEvent(d),"function"===typeof e.onicecandidate))e.onicecandidate(d);
if(l){e.dispatchEvent(new Event("icecandidate"));if("function"===typeof e.onicecandidate)e.onicecandidate(new Event("icecandidate"));e.iceGatheringState="complete";e._emitGatheringStateChange()}}};d.setTimeout(function(){l.forEach(function(a){var b=new Event("RTCIceGatherEvent");b.candidate=a;c.onlocalcandidate(b)})},0)}};m.prototype._createIceAndDtlsTransports=function(){var a=this,b=new d.RTCIceTransport(null);b.onicestatechange=function(){a._updateConnectionState()};var c=new d.RTCDtlsTransport(b);
c.ondtlsstatechange=function(){a._updateConnectionState()};c.onerror=function(){Object.defineProperty(c,"state",{value:"failed",writable:!0});a._updateConnectionState()};return{iceTransport:b,dtlsTransport:c}};m.prototype._disposeIceAndDtlsTransports=function(a){var b=this.transceivers[a].iceGatherer;b&&(delete b.onlocalcandidate,delete this.transceivers[a].iceGatherer);if(b=this.transceivers[a].iceTransport)delete b.onicestatechange,delete this.transceivers[a].iceTransport;if(b=this.transceivers[a].dtlsTransport)delete b.ondtlsstatechange,
delete b.onerror,delete this.transceivers[a].dtlsTransport};m.prototype._transceive=function(a,b,f){var e=c(a.localCapabilities,a.remoteCapabilities);b&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:k.localCName,compound:a.rtcpParameters.compound},a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e));f&&a.rtpReceiver&&0<e.codecs.length&&("video"===a.kind&&a.recvEncodingParameters&&15019>r&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),
e.encodings=a.recvEncodingParameters,e.rtcp={cname:a.rtcpParameters.cname,compound:a.rtcpParameters.compound},a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(e))};m.prototype.setLocalDescription=function(a){var b=this,f=arguments;if(!g("setLocalDescription",a.type,this.signalingState))return new Promise(function(c,e){var d=Error("Can not set local "+a.type+" in state "+b.signalingState);d.name="InvalidStateError";2<f.length&&"function"===typeof f[2]&&
f[2].apply(null,[d]);e(d)});var d,l;if("offer"===a.type)d=k.splitSections(a.sdp),l=d.shift(),d.forEach(function(a,c){var e=k.parseRtpParameters(a);b.transceivers[c].localCapabilities=e}),this.transceivers.forEach(function(a,c){b._gather(a.mid,c)});else if("answer"===a.type){d=k.splitSections(b.remoteDescription.sdp);l=d.shift();var r=0<k.matchPrefix(l,"a=ice-lite").length;d.forEach(function(a,e){var f=b.transceivers[e],d=f.iceGatherer,g=f.iceTransport,n=f.dtlsTransport,m=f.localCapabilities,v=f.remoteCapabilities;
if(!(k.isRejected(a)&&1===!k.matchPrefix(a,"a=bundle-only").length||f.isDatachannel)){var h=k.getIceParameters(a,l),D=k.getDtlsParameters(a,l);r&&(D.role="server");b.usingBundle&&0!==e||(b._gather(f.mid,e),"new"===g.state&&g.start(d,h,r?"controlling":"controlled"),"new"===n.state&&n.start(D));d=c(m,v);b._transceive(f,0<d.codecs.length,!1)}})}this.localDescription={type:a.type,sdp:a.sdp};switch(a.type){case "offer":this._updateSignalingState("have-local-offer");break;case "answer":this._updateSignalingState("stable");
break;default:throw new TypeError('unsupported type "'+a.type+'"');}var m=1<arguments.length&&"function"===typeof arguments[1]&&arguments[1];return new Promise(function(a){m&&m.apply(null);a()})};m.prototype.setRemoteDescription=function(b){var c=this,f=arguments;if(!g("setRemoteDescription",b.type,this.signalingState))return new Promise(function(a,e){var d=Error("Can not set remote "+b.type+" in state "+c.signalingState);d.name="InvalidStateError";2<f.length&&"function"===typeof f[2]&&f[2].apply(null,
[d]);e(d)});var l={};this.remoteStreams.forEach(function(a){l[a.id]=a});var n=[],m=k.splitSections(b.sdp),h=m.shift(),F=0<k.matchPrefix(h,"a=ice-lite").length,q=0<k.matchPrefix(h,"a=group:BUNDLE ").length;this.usingBundle=q;var x=k.matchPrefix(h,"a=ice-options:")[0];this.canTrickleIceCandidates=x?0<=x.substr(14).split(" ").indexOf("trickle"):!1;m.forEach(function(e,f){var g=k.splitLines(e),m=k.getKind(e),v=k.isRejected(e)&&1===!k.matchPrefix(e,"a=bundle-only").length,D=g[0].substr(2).split(" ")[2],
g=k.getDirection(e,h),z=k.parseMsid(e),x=k.getMid(e)||k.generateIdentifier();if("application"===m&&"DTLS/SCTP"===D)c.transceivers[f]={mid:x,isDatachannel:!0};else{var p,t,y,u,A,I=k.parseRtpParameters(e),w;v||(A=k.getIceParameters(e,h),w=k.getDtlsParameters(e,h),w.role="client");var D=k.parseRtpEncodingParameters(e),B=k.parseRtcpParameters(e),C=0<k.matchPrefix(e,"a=end-of-candidates",h).length,G=k.matchPrefix(e,"a=candidate:").map(function(a){return k.parseCandidate(a)}).filter(function(a){return 1===
a.component});("offer"===b.type||"answer"===b.type)&&!v&&q&&0<f&&c.transceivers[f]&&(c._disposeIceAndDtlsTransports(f),c.transceivers[f].iceGatherer=c.transceivers[0].iceGatherer,c.transceivers[f].iceTransport=c.transceivers[0].iceTransport,c.transceivers[f].dtlsTransport=c.transceivers[0].dtlsTransport,c.transceivers[f].rtpSender&&c.transceivers[f].rtpSender.setTransport(c.transceivers[0].dtlsTransport),c.transceivers[f].rtpReceiver&&c.transceivers[f].rtpReceiver.setTransport(c.transceivers[0].dtlsTransport));
if("offer"!==b.type||v)"answer"!==b.type||v||(p=c.transceivers[f],m=p.iceGatherer,t=p.iceTransport,y=p.dtlsTransport,u=p.rtpReceiver,v=p.sendEncodingParameters,x=p.localCapabilities,c.transceivers[f].recvEncodingParameters=D,c.transceivers[f].remoteCapabilities=I,c.transceivers[f].rtcpParameters=B,G.length&&(!F&&!C||q&&0!==f||"new"!==t.state?G.forEach(function(b){a(p.iceTransport,b)}):t.setRemoteCandidates(G)),q&&0!==f||("new"===t.state&&t.start(m,A,"controlling"),"new"===y.state&&y.start(w)),c._transceive(p,
"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!u||"sendrecv"!==g&&"sendonly"!==g?delete p.rtpReceiver:(A=u.track,z?(l[z.stream]||(l[z.stream]=new d.MediaStream),l[z.stream].addTrack(A),n.push([A,u,l[z.stream]])):(l["default"]||(l["default"]=new d.MediaStream),l["default"].addTrack(A),n.push([A,u,l["default"]]))));else{p=c.transceivers[f]||c._createTransceiver(m);p.mid=x;p.iceGatherer||(p.iceGatherer=c._createIceGatherer(f,q));G.length&&"new"===p.iceTransport.state&&(!C||q&&0!==f?
G.forEach(function(b){a(p.iceTransport,b)}):p.iceTransport.setRemoteCandidates(G));x=d.RTCRtpReceiver.getCapabilities(m);15019>r&&(x.codecs=x.codecs.filter(function(a){return"rtx"!==a.name}));v=[{ssrc:1001*(2*f+2)}];if("sendrecv"===g||"sendonly"===g)A=!p.rtpReceiver,u=p.rtpReceiver||new d.RTCRtpReceiver(p.dtlsTransport,m),A&&(A=u.track,z?(l[z.stream]||(l[z.stream]=new d.MediaStream,Object.defineProperty(l[z.stream],"id",{get:function(){return z.stream}})),Object.defineProperty(A,"id",{get:function(){return z.track}}),
w=l[z.stream]):(l["default"]||(l["default"]=new d.MediaStream),w=l["default"]),w.addTrack(A),n.push([A,u,w]));p.localCapabilities=x;p.remoteCapabilities=I;p.rtpReceiver=u;p.rtcpParameters=B;p.sendEncodingParameters=v;p.recvEncodingParameters=D;c._transceive(c.transceivers[f],!1,"sendrecv"===g||"sendonly"===g)}}});this.remoteDescription={type:b.type,sdp:b.sdp};switch(b.type){case "offer":this._updateSignalingState("have-remote-offer");break;case "answer":this._updateSignalingState("stable");break;
default:throw new TypeError('unsupported type "'+b.type+'"');}Object.keys(l).forEach(function(a){var b=l[a];if(b.getTracks().length){if(-1===c.remoteStreams.indexOf(b)){c.remoteStreams.push(b);var e=new Event("addstream");e.stream=b;d.setTimeout(function(){c.dispatchEvent(e);if("function"===typeof c.onaddstream)c.onaddstream(e)})}n.forEach(function(a){var e=a[0],f=a[1];if(b.id===a[2].id){var k=new Event("track");k.track=e;k.receiver=f;k.transceiver={receiver:f};k.streams=[b];d.setTimeout(function(){c.dispatchEvent(k);
if("function"===typeof c.ontrack)c.ontrack(k)})}})}});d.setTimeout(function(){c&&c.transceivers&&c.transceivers.forEach(function(a){a.iceTransport&&"new"===a.iceTransport.state&&0<a.iceTransport.getRemoteCandidates().length&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),a.iceTransport.addRemoteCandidate({}))})},4E3);return new Promise(function(a){1<f.length&&"function"===typeof f[1]&&f[1].apply(null);a()})};m.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&
a.iceTransport.stop();a.dtlsTransport&&a.dtlsTransport.stop();a.rtpSender&&a.rtpSender.stop();a.rtpReceiver&&a.rtpReceiver.stop()});this._updateSignalingState("closed")};m.prototype._updateSignalingState=function(a){this.signalingState=a;a=new Event("signalingstatechange");this.dispatchEvent(a);if("function"===typeof this.onsignalingstatechange)this.onsignalingstatechange(a)};m.prototype._maybeFireNegotiationNeeded=function(){var a=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=
!0,d.setTimeout(function(){if(!1!==a.needNegotiation){a.needNegotiation=!1;var b=new Event("negotiationneeded");a.dispatchEvent(b);if("function"===typeof a.onnegotiationneeded)a.onnegotiationneeded(b)}},0))};m.prototype._updateConnectionState=function(){var a,b={"new":0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(a){b[a.iceTransport.state]++;b[a.dtlsTransport.state]++});b.connected+=b.completed;a="new";if(0<b.failed)a="failed";
else if(0<b.connecting||0<b.checking)a="connecting";else if(0<b.disconnected)a="disconnected";else if(0<b["new"])a="new";else if(0<b.connected||0<b.completed)a="connected";if(a!==this.iceConnectionState&&(this.iceConnectionState=a,a=new Event("iceconnectionstatechange"),this.dispatchEvent(a),"function"===typeof this.oniceconnectionstatechange))this.oniceconnectionstatechange(a)};m.prototype.createOffer=function(){var a=this,b=arguments,c;1===arguments.length&&"function"!==typeof arguments[0]?c=arguments[0]:
3===arguments.length&&(c=arguments[2]);var g=this.transceivers.filter(function(a){return"audio"===a.kind}).length,n=this.transceivers.filter(function(a){return"video"===a.kind}).length;if(c){if(c.mandatory||c.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==c.offerToReceiveAudio&&(g=!0===c.offerToReceiveAudio?1:!1===c.offerToReceiveAudio?0:c.offerToReceiveAudio);void 0!==c.offerToReceiveVideo&&(n=!0===c.offerToReceiveVideo?1:!1===c.offerToReceiveVideo?
0:c.offerToReceiveVideo)}for(this.transceivers.forEach(function(a){"audio"===a.kind?(g--,0>g&&(a.wantReceive=!1)):"video"===a.kind&&(n--,0>n&&(a.wantReceive=!1))});0<g||0<n;)0<g&&(this._createTransceiver("audio"),g--),0<n&&(this._createTransceiver("video"),n--);var m=k.writeSessionBoilerplate(this._sdpSessionId,this._sdpSessionVersion++);this.transceivers.forEach(function(b,c){var e=b.track,f=b.kind,g=k.generateIdentifier();b.mid=g;b.iceGatherer||(b.iceGatherer=a._createIceGatherer(c,a.usingBundle));
g=d.RTCRtpSender.getCapabilities(f);15019>r&&(g.codecs=g.codecs.filter(function(a){return"rtx"!==a.name}));g.codecs.forEach(function(a){"H264"===a.name&&void 0===a.parameters["level-asymmetry-allowed"]&&(a.parameters["level-asymmetry-allowed"]="1")});var l=[{ssrc:1001*(2*c+1)}];e&&15019<=r&&"video"===f&&(l[0].rtx={ssrc:1001*(2*c+1)+1});b.wantReceive&&(b.rtpReceiver=new d.RTCRtpReceiver(b.dtlsTransport,f));b.localCapabilities=g;b.sendEncodingParameters=l});"max-compat"!==this._config.bundlePolicy&&
(m+="a=group:BUNDLE "+this.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n");m+="a=ice-options:trickle\r\n";this.transceivers.forEach(function(b,c){m+=h(b,b.localCapabilities,"offer",b.stream);m+="a=rtcp-rsize\r\n";!b.iceGatherer||"new"===a.iceGatheringState||0!==c&&a.usingBundle||(b.iceGatherer.getLocalCandidates().forEach(function(a){a.component=1;m+="a="+k.writeCandidate(a)+"\r\n"}),"completed"===b.iceGatherer.state&&(m+="a=end-of-candidates\r\n"))});var z=new d.RTCSessionDescription({type:"offer",
sdp:m});return new Promise(function(a){0<b.length&&"function"===typeof b[0]?(b[0].apply(null,[z]),a()):a(z)})};m.prototype.createAnswer=function(){var a=arguments,b=k.writeSessionBoilerplate(this._sdpSessionId,this._sdpSessionVersion++);this.usingBundle&&(b+="a=group:BUNDLE "+this.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n");var f=k.splitSections(this.remoteDescription.sdp).length-1;this.transceivers.forEach(function(a,e){if(!(e+1>f))if(a.isDatachannel)b+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+
a.mid+"\r\n";else{if(a.stream){var d;"audio"===a.kind?d=a.stream.getAudioTracks()[0]:"video"===a.kind&&(d=a.stream.getVideoTracks()[0]);d&&15019<=r&&"video"===a.kind&&(a.sendEncodingParameters[0].rtx={ssrc:1001*(2*e+2)+1})}d=c(a.localCapabilities,a.remoteCapabilities);!d.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length&&a.sendEncodingParameters[0].rtx&&delete a.sendEncodingParameters[0].rtx;b+=h(a,d,"answer",a.stream);a.rtcpParameters&&a.rtcpParameters.reducedSize&&(b+="a=rtcp-rsize\r\n")}});
var g=new d.RTCSessionDescription({type:"answer",sdp:b});return new Promise(function(b){0<a.length&&"function"===typeof a[0]?(a[0].apply(null,[g]),b()):b(g)})};m.prototype.addIceCandidate=function(b){var c,f;if(b&&""!==b.candidate)if(b.sdpMLineIndex||b.sdpMid)if(this.remoteDescription){var d=b.sdpMLineIndex;if(b.sdpMid)for(f=0;f<this.transceivers.length;f++)if(this.transceivers[f].mid===b.sdpMid){d=f;break}if(f=this.transceivers[d]){if(f.isDatachannel)return Promise.resolve();var g=0<Object.keys(b.candidate).length?
k.parseCandidate(b.candidate):{};if("tcp"===g.protocol&&(0===g.port||9===g.port)||g.component&&1!==g.component)return Promise.resolve();(0===d||0<d&&f.iceTransport!==this.transceivers[0].iceTransport)&&!a(f.iceTransport,g)&&(c=Error("Can not add ICE candidate"),c.name="OperationError");if(!c){var l=b.candidate.trim();0===l.indexOf("a=")&&(l=l.substr(2));f=k.splitSections(this.remoteDescription.sdp);f[d+1]+="a="+(g.type?l:"end-of-candidates")+"\r\n";this.remoteDescription.sdp=f.join("")}}else c=Error("Can not add ICE candidate"),
c.name="OperationError"}else c=Error("Can not add ICE candidate without a remote description"),c.name="InvalidStateError";else throw new TypeError("sdpMLineIndex or sdpMid required");else for(d=0;d<this.transceivers.length&&(this.transceivers[d].isDatachannel||(this.transceivers[d].iceTransport.addRemoteCandidate({}),f=k.splitSections(this.remoteDescription.sdp),f[d+1]+="a=end-of-candidates\r\n",this.remoteDescription.sdp=f.join(""),!this.usingBundle));d++);var m=arguments;return new Promise(function(a,
b){c?(2<m.length&&"function"===typeof m[2]&&m[2].apply(null,[c]),b(c)):(1<m.length&&"function"===typeof m[1]&&m[1].apply(null),a())})};m.prototype.getStats=function(){var a=[];this.transceivers.forEach(function(b){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(c){b[c]&&a.push(b[c].getStats())})});var b=1<arguments.length&&"function"===typeof arguments[1]&&arguments[1];return new Promise(function(c){var e=new Map;Promise.all(a).then(function(a){a.forEach(function(a){Object.keys(a).forEach(function(b){var c=
a[b];a[b].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[c.type]||c.type;e.set(b,a[b])})});b&&b.apply(null,e);c(e)})})};return m}},{sdp:2}],2:[function(p,t,q){var h={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};h.localCName=h.generateIdentifier();h.splitLines=function(b){return b.trim().split("\n").map(function(b){return b.trim()})};h.splitSections=function(b){return b.split("\nm=").map(function(b,
g){return(0<g?"m="+b:b).trim()+"\r\n"})};h.matchPrefix=function(b,c){return h.splitLines(b).filter(function(b){return 0===b.indexOf(c)})};h.parseCandidate=function(b){b=0===b.indexOf("a=candidate:")?b.substring(12).split(" "):b.substring(10).split(" ");for(var c={foundation:b[0],component:parseInt(b[1],10),protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],port:parseInt(b[5],10),type:b[7]},g=8;g<b.length;g+=2)switch(b[g]){case "raddr":c.relatedAddress=b[g+1];break;case "rport":c.relatedPort=
parseInt(b[g+1],10);break;case "tcptype":c.tcpType=b[g+1];break;case "ufrag":c.ufrag=b[g+1];c.usernameFragment=b[g+1];break;default:c[b[g]]=b[g+1]}return c};h.writeCandidate=function(b){var c=[];c.push(b.foundation);c.push(b.component);c.push(b.protocol.toUpperCase());c.push(b.priority);c.push(b.ip);c.push(b.port);var g=b.type;c.push("typ");c.push(g);"host"!==g&&b.relatedAddress&&b.relatedPort&&(c.push("raddr"),c.push(b.relatedAddress),c.push("rport"),c.push(b.relatedPort));b.tcpType&&"tcp"===b.protocol.toLowerCase()&&
(c.push("tcptype"),c.push(b.tcpType));b.ufrag&&(c.push("ufrag"),c.push(b.ufrag));return"candidate:"+c.join(" ")};h.parseIceOptions=function(b){return b.substr(14).split(" ")};h.parseRtpMap=function(b){b=b.substr(9).split(" ");var c={payloadType:parseInt(b.shift(),10)};b=b[0].split("/");c.name=b[0];c.clockRate=parseInt(b[1],10);c.numChannels=3===b.length?parseInt(b[2],10):1;return c};h.writeRtpMap=function(b){var c=b.payloadType;void 0!==b.preferredPayloadType&&(c=b.preferredPayloadType);return"a=rtpmap:"+
c+" "+b.name+"/"+b.clockRate+(1!==b.numChannels?"/"+b.numChannels:"")+"\r\n"};h.parseExtmap=function(b){b=b.substr(9).split(" ");return{id:parseInt(b[0],10),direction:0<b[0].indexOf("/")?b[0].split("/")[1]:"sendrecv",uri:b[1]}};h.writeExtmap=function(b){return"a=extmap:"+(b.id||b.preferredId)+(b.direction&&"sendrecv"!==b.direction?"/"+b.direction:"")+" "+b.uri+"\r\n"};h.parseFmtp=function(b){for(var c={},g=b.substr(b.indexOf(" ")+1).split(";"),a=0;a<g.length;a++)b=g[a].trim().split("="),c[b[0].trim()]=
b[1];return c};h.writeFmtp=function(b){var c="",g=b.payloadType;void 0!==b.preferredPayloadType&&(g=b.preferredPayloadType);if(b.parameters&&Object.keys(b.parameters).length){var a=[];Object.keys(b.parameters).forEach(function(c){a.push(c+"="+b.parameters[c])});c+="a=fmtp:"+g+" "+a.join(";")+"\r\n"}return c};h.parseRtcpFb=function(b){b=b.substr(b.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}};h.writeRtcpFb=function(b){var c="",g=b.payloadType;void 0!==b.preferredPayloadType&&
(g=b.preferredPayloadType);b.rtcpFeedback&&b.rtcpFeedback.length&&b.rtcpFeedback.forEach(function(a){c+="a=rtcp-fb:"+g+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"});return c};h.parseSsrcMedia=function(b){var c=b.indexOf(" "),g={ssrc:parseInt(b.substr(7,c-7),10)},a=b.indexOf(":",c);-1<a?(g.attribute=b.substr(c+1,a-c-1),g.value=b.substr(a+1)):g.attribute=b.substr(c+1);return g};h.getMid=function(b){if(b=h.matchPrefix(b,"a=mid:")[0])return b.substr(6)};h.parseFingerprint=function(b){b=
b.substr(14).split(" ");return{algorithm:b[0].toLowerCase(),value:b[1]}};h.getDtlsParameters=function(b,c){return{role:"auto",fingerprints:h.matchPrefix(b+c,"a=fingerprint:").map(h.parseFingerprint)}};h.writeDtlsParameters=function(b,c){var g="a=setup:"+c+"\r\n";b.fingerprints.forEach(function(a){g+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"});return g};h.getIceParameters=function(b,c){var g=h.splitLines(b),g=g.concat(h.splitLines(c));return{usernameFragment:g.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),
password:g.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)}};h.writeIceParameters=function(b){return"a=ice-ufrag:"+b.usernameFragment+"\r\na=ice-pwd:"+b.password+"\r\n"};h.parseRtpParameters=function(b){for(var c={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},g=h.splitLines(b)[0].split(" "),a=3;a<g.length;a++){var k=g[a],d=h.matchPrefix(b,"a=rtpmap:"+k+" ")[0];if(d){var d=h.parseRtpMap(d),r=h.matchPrefix(b,"a=fmtp:"+k+" ");d.parameters=r.length?h.parseFmtp(r[0]):{};
d.rtcpFeedback=h.matchPrefix(b,"a=rtcp-fb:"+k+" ").map(h.parseRtcpFb);c.codecs.push(d);switch(d.name.toUpperCase()){case "RED":case "ULPFEC":c.fecMechanisms.push(d.name.toUpperCase())}}}h.matchPrefix(b,"a=extmap:").forEach(function(a){c.headerExtensions.push(h.parseExtmap(a))});return c};h.writeRtpDescription=function(b,c){var g="",g=g+("m="+b+" "),g=g+(0<c.codecs.length?"9":"0"),g=g+" UDP/TLS/RTP/SAVPF ",g=g+(c.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:
a.payloadType}).join(" ")+"\r\n"),g=g+"c=IN IP4 0.0.0.0\r\n",g=g+"a=rtcp:9 IN IP4 0.0.0.0\r\n";c.codecs.forEach(function(a){g+=h.writeRtpMap(a);g+=h.writeFmtp(a);g+=h.writeRtcpFb(a)});var a=0;c.codecs.forEach(function(b){b.maxptime>a&&(a=b.maxptime)});0<a&&(g+="a=maxptime:"+a+"\r\n");g+="a=rtcp-mux\r\n";c.headerExtensions.forEach(function(a){g+=h.writeExtmap(a)});return g};h.parseRtpEncodingParameters=function(b){var c=[],g=h.parseRtpParameters(b),a=-1!==g.fecMechanisms.indexOf("RED"),k=-1!==g.fecMechanisms.indexOf("ULPFEC"),
d=h.matchPrefix(b,"a=ssrc:").map(function(a){return h.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),r=0<d.length&&d[0].ssrc,m,d=h.matchPrefix(b,"a=ssrc-group:FID").map(function(a){a=a.split(" ");a.shift();return a.map(function(a){return parseInt(a,10)})});0<d.length&&1<d[0].length&&d[0][0]===r&&(m=d[0][1]);g.codecs.forEach(function(b){"RTX"===b.name.toUpperCase()&&b.parameters.apt&&(b={ssrc:r,codecPayloadType:parseInt(b.parameters.apt,10),rtx:{ssrc:m}},c.push(b),a&&(b=JSON.parse(JSON.stringify(b)),
b.fec={ssrc:m,mechanism:k?"red+ulpfec":"red"},c.push(b)))});0===c.length&&r&&c.push({ssrc:r});var l=h.matchPrefix(b,"b=");l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?950*parseInt(l[0].substr(5),10)-16E3:void 0,c.forEach(function(a){a.maxBitrate=l}));return c};h.parseRtcpParameters=function(b){var c={},g=h.matchPrefix(b,"a=ssrc:").map(function(a){return h.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];g&&(c.cname=g.value,c.ssrc=
g.ssrc);g=h.matchPrefix(b,"a=rtcp-rsize");c.reducedSize=0<g.length;c.compound=0===g.length;b=h.matchPrefix(b,"a=rtcp-mux");c.mux=0<b.length;return c};h.parseMsid=function(b){var c=h.matchPrefix(b,"a=msid:");if(1===c.length)return b=c[0].substr(7).split(" "),{stream:b[0],track:b[1]};b=h.matchPrefix(b,"a=ssrc:").map(function(b){return h.parseSsrcMedia(b)}).filter(function(b){return"msid"===b.attribute});if(0<b.length)return b=b[0].value.split(" "),{stream:b[0],track:b[1]}};h.generateSessionId=function(){return Math.random().toString().substr(2,
21)};h.writeSessionBoilerplate=function(b,c){var g=void 0!==c?c:2;return"v=0\r\no=thisisadapterortc "+(b?b:h.generateSessionId())+" "+g+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"};h.writeMediaSection=function(b,c,g,a){c=h.writeRtpDescription(b.kind,c);c+=h.writeIceParameters(b.iceGatherer.getLocalParameters());c+=h.writeDtlsParameters(b.dtlsTransport.getLocalParameters(),"offer"===g?"actpass":"active");c+="a=mid:"+b.mid+"\r\n";c=b.direction?c+("a="+b.direction+"\r\n"):b.rtpSender&&b.rtpReceiver?c+"a=sendrecv\r\n":
b.rtpSender?c+"a=sendonly\r\n":b.rtpReceiver?c+"a=recvonly\r\n":c+"a=inactive\r\n";b.rtpSender&&(g="msid:"+a.id+" "+b.rtpSender.track.id+"\r\n",c=c+("a="+g)+("a=ssrc:"+b.sendEncodingParameters[0].ssrc+" "+g),b.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+b.sendEncodingParameters[0].rtx.ssrc+" "+g,c+="a=ssrc-group:FID "+b.sendEncodingParameters[0].ssrc+" "+b.sendEncodingParameters[0].rtx.ssrc+"\r\n"));c+="a=ssrc:"+b.sendEncodingParameters[0].ssrc+" cname:"+h.localCName+"\r\n";b.rtpSender&&b.sendEncodingParameters[0].rtx&&
(c+="a=ssrc:"+b.sendEncodingParameters[0].rtx.ssrc+" cname:"+h.localCName+"\r\n");return c};h.getDirection=function(b,c){for(var g=h.splitLines(b),a=0;a<g.length;a++)switch(g[a]){case "a=sendrecv":case "a=sendonly":case "a=recvonly":case "a=inactive":return g[a].substr(2)}return c?h.getDirection(c):"sendrecv"};h.getKind=function(b){return h.splitLines(b)[0].split(" ")[0].substr(2)};h.isRejected=function(b){return"0"===b.split(" ",2)[1]};h.parseMLine=function(b){b=h.splitLines(b)[0].split(" ");return{kind:b[0].substr(2),
port:parseInt(b[1],10),protocol:b[2],fmt:b.slice(3).join(" ")}};"object"===typeof t&&(t.exports=h)},{}],3:[function(p,t,q){q="undefined"!==typeof u?u:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{};p=p("./adapter_factory.js");t.exports=p({window:q.window})},{"./adapter_factory.js":4}],4:[function(p,t,q){var h=p("./utils");t.exports=function(b,c){var g=b&&b.window,a={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},k;for(k in c)hasOwnProperty.call(c,k)&&(a[k]=c[k]);k=h.log;
var d=h.detectBrowser(g),r={browserDetails:d,extractVersion:h.extractVersion,disableLog:h.disableLog,disableWarnings:h.disableWarnings},m=p("./chrome/chrome_shim")||null,l=p("./edge/edge_shim")||null,e=p("./firefox/firefox_shim")||null,f=p("./safari/safari_shim")||null,v=p("./common_shim")||null;switch(d.browser){case "chrome":if(!m||!m.shimPeerConnection||!a.shimChrome){k("Chrome shim is not included in this adapter release.");break}k("adapter.js shimming chrome.");r.browserShim=m;v.shimCreateObjectURL(g);
m.shimGetUserMedia(g);m.shimMediaStream(g);m.shimSourceObject(g);m.shimPeerConnection(g);m.shimOnTrack(g);m.shimAddTrackRemoveTrack(g);m.shimGetSendersWithDtmf(g);v.shimRTCIceCandidate(g);break;case "firefox":if(!e||!e.shimPeerConnection||!a.shimFirefox){k("Firefox shim is not included in this adapter release.");break}k("adapter.js shimming firefox.");r.browserShim=e;v.shimCreateObjectURL(g);e.shimGetUserMedia(g);e.shimSourceObject(g);e.shimPeerConnection(g);e.shimOnTrack(g);v.shimRTCIceCandidate(g);
break;case "edge":if(!l||!l.shimPeerConnection||!a.shimEdge){k("MS edge shim is not included in this adapter release.");break}k("adapter.js shimming edge.");r.browserShim=l;v.shimCreateObjectURL(g);l.shimGetUserMedia(g);l.shimPeerConnection(g);l.shimReplaceTrack(g);break;case "safari":if(!f||!a.shimSafari){k("Safari shim is not included in this adapter release.");break}k("adapter.js shimming safari.");r.browserShim=f;v.shimCreateObjectURL(g);f.shimRTCIceServerUrls(g);f.shimCallbacksAPI(g);f.shimLocalStreamsAPI(g);
f.shimRemoteStreamsAPI(g);f.shimTrackEventTransceiver(g);f.shimGetUserMedia(g);v.shimRTCIceCandidate(g);break;default:k("Unsupported browser!")}return r}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":10,"./safari/safari_shim":12,"./utils":13}],5:[function(p,t,q){var h=p("../utils.js"),b=h.log;t.exports={shimMediaStream:function(b){b.MediaStream=b.MediaStream||b.webkitMediaStream},shimOnTrack:function(b){if("object"===typeof b&&b.RTCPeerConnection&&!("ontrack"in
b.RTCPeerConnection.prototype)){Object.defineProperty(b.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&this.removeEventListener("track",this._ontrack);this.addEventListener("track",this._ontrack=a)}});var c=b.RTCPeerConnection.prototype.setRemoteDescription;b.RTCPeerConnection.prototype.setRemoteDescription=function(){var a=this;a._ontrackpoly||(a._ontrackpoly=function(c){c.stream.addEventListener("addtrack",function(d){var g;g=b.RTCPeerConnection.prototype.getReceivers?
a.getReceivers().find(function(a){return a.track&&a.track.id===d.track.id}):{track:d.track};var k=new Event("track");k.track=d.track;k.receiver=g;k.transceiver={receiver:g};k.streams=[c.stream];a.dispatchEvent(k)});c.stream.getTracks().forEach(function(d){var g;g=b.RTCPeerConnection.prototype.getReceivers?a.getReceivers().find(function(a){return a.track&&a.track.id===d.id}):{track:d};var k=new Event("track");k.track=d;k.receiver=g;k.transceiver={receiver:g};k.streams=[c.stream];a.dispatchEvent(k)})},
a.addEventListener("addstream",a._ontrackpoly));return c.apply(a,arguments)}}},shimAddTrackRemoveTrack:function(b){function c(a,b){var c=b.sdp;Object.keys(a._reverseStreams||[]).forEach(function(b){b=a._reverseStreams[b];c=c.replace(new RegExp(a._streams[b.id].id,"g"),b.id)});return new RTCSessionDescription({type:b.type,sdp:c})}function a(a,b){var c=b.sdp;Object.keys(a._reverseStreams||[]).forEach(function(b){b=a._reverseStreams[b];c=c.replace(new RegExp(b.id,"g"),a._streams[b.id].id)});return new RTCSessionDescription({type:b.type,
sdp:c})}var k=h.detectBrowser(b);if(!(b.RTCPeerConnection.prototype.addTrack&&62<=k.version)){var d=b.RTCPeerConnection.prototype.getLocalStreams;b.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this,b=d.apply(this);a._reverseStreams=a._reverseStreams||{};return b.map(function(b){return a._reverseStreams[b.id]})};var r=b.RTCPeerConnection.prototype.addStream;b.RTCPeerConnection.prototype.addStream=function(a){var c=this;c._streams=c._streams||{};c._reverseStreams=c._reverseStreams||
{};a.getTracks().forEach(function(a){if(c.getSenders().find(function(b){return b.track===a}))throw new DOMException("Track already exists.","InvalidAccessError");});if(!c._reverseStreams[a.id]){var e=new b.MediaStream(a.getTracks());c._streams[a.id]=e;c._reverseStreams[e.id]=a;a=e}r.apply(c,[a])};var m=b.RTCPeerConnection.prototype.removeStream;b.RTCPeerConnection.prototype.removeStream=function(a){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};m.apply(this,[this._streams[a.id]||
a]);delete this._reverseStreams[this._streams[a.id]?this._streams[a.id].id:a.id];delete this._streams[a.id]};b.RTCPeerConnection.prototype.addTrack=function(a,c){var e=this;if("closed"===e.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var f=[].slice.call(arguments,1);if(1!==f.length||!f[0].getTracks().find(function(b){return b===a}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.",
"NotSupportedError");if(e.getSenders().find(function(b){return b.track===a}))throw new DOMException("Track already exists.","InvalidAccessError");e._streams=e._streams||{};e._reverseStreams=e._reverseStreams||{};(f=e._streams[c.id])?(f.addTrack(a),Promise.resolve().then(function(){e.dispatchEvent(new Event("negotiationneeded"))})):(f=new b.MediaStream([a]),e._streams[c.id]=f,e._reverseStreams[f.id]=c,e.addStream(f));return e.getSenders().find(function(b){return b.track===a})};["createOffer","createAnswer"].forEach(function(a){var e=
b.RTCPeerConnection.prototype[a];b.RTCPeerConnection.prototype[a]=function(){var a=this,b=arguments;return arguments.length&&"function"===typeof arguments[0]?e.apply(a,[function(e){e=c(a,e);b[0].apply(null,[e])},function(a){b[1]&&b[1].apply(null,a)},arguments[2]]):e.apply(a,arguments).then(function(b){return c(a,b)})}});var l=b.RTCPeerConnection.prototype.setLocalDescription;b.RTCPeerConnection.prototype.setLocalDescription=function(){if(!arguments.length||!arguments[0].type)return l.apply(this,arguments);
arguments[0]=a(this,arguments[0]);return l.apply(this,arguments)};var e=Object.getOwnPropertyDescriptor(b.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(b.RTCPeerConnection.prototype,"localDescription",{get:function(){var a=e.get.apply(this);return""===a.type?a:c(this,a)}});b.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;if("closed"===b.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!a._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.",
"TypeError");if(a._pc!==b)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");b._streams=b._streams||{};var c;Object.keys(b._streams).forEach(function(e){b._streams[e].getTracks().find(function(b){return a.track===b})&&(c=b._streams[e])});c&&(1===c.getTracks().length?b.removeStream(c):c.removeTrack(a.track),b.dispatchEvent(new Event("negotiationneeded")))}}},shimGetSendersWithDtmf:function(b){if("object"===typeof b&&b.RTCPeerConnection&&!("getSenders"in b.RTCPeerConnection.prototype)&&
"createDTMFSender"in b.RTCPeerConnection.prototype){var c=function(a,b){return Object.defineProperties({track:b,_pc:a},{dtmf:{get:function(){void 0===this._dtmf&&(this._dtmf="audio"===b.kind?a.createDTMFSender(b):null);return this._dtmf},configurable:!0,enumerable:!0}})};if(!b.RTCPeerConnection.prototype.getSenders){b.RTCPeerConnection.prototype.getSenders=function(){this._senders=this._senders||[];return this._senders.slice()};var a=b.RTCPeerConnection.prototype.addTrack;b.RTCPeerConnection.prototype.addTrack=
function(b,e){var f=a.apply(this,arguments);f||(f=c(this,b),this._senders.push(f));return f};var k=b.RTCPeerConnection.prototype.removeTrack;b.RTCPeerConnection.prototype.removeTrack=function(a){k.apply(this,arguments);var b=this._senders.indexOf(a);-1!==b&&this._senders.splice(b,1)}}var d=b.RTCPeerConnection.prototype.addStream;b.RTCPeerConnection.prototype.addStream=function(a){var b=this;b._senders=b._senders||[];d.apply(b,[a]);a.getTracks().forEach(function(a){b._senders.push(c(b,a))})};var r=
b.RTCPeerConnection.prototype.removeStream;b.RTCPeerConnection.prototype.removeStream=function(a){var b=this;b._senders=b._senders||[];r.apply(b,[b._streams[a.id]||a]);a.getTracks().forEach(function(a){var c=b._senders.find(function(b){return b.track===a});c&&b._senders.splice(b._senders.indexOf(c),1)})}}else if("object"===typeof b&&b.RTCPeerConnection&&"getSenders"in b.RTCPeerConnection.prototype&&"createDTMFSender"in b.RTCPeerConnection.prototype&&b.RTCRtpSender&&!("dtmf"in b.RTCRtpSender.prototype)){var m=
b.RTCPeerConnection.prototype.getSenders;b.RTCPeerConnection.prototype.getSenders=function(){var a=this,b=m.apply(a,[]);b.forEach(function(b){b._pc=a});return b};Object.defineProperty(b.RTCRtpSender.prototype,"dtmf",{get:function(){void 0===this._dtmf&&(this._dtmf="audio"===this.track.kind?this._pc.createDTMFSender(this.track):null);return this._dtmf}})}},shimSourceObject:function(b){var c=b&&b.URL;"object"===typeof b&&(!b.HTMLMediaElement||"srcObject"in b.HTMLMediaElement.prototype||Object.defineProperty(b.HTMLMediaElement.prototype,
"srcObject",{get:function(){return this._srcObject},set:function(a){var b=this;this._srcObject=a;this.src&&c.revokeObjectURL(this.src);a?(this.src=c.createObjectURL(a),a.addEventListener("addtrack",function(){b.src&&c.revokeObjectURL(b.src);b.src=c.createObjectURL(a)}),a.addEventListener("removetrack",function(){b.src&&c.revokeObjectURL(b.src);b.src=c.createObjectURL(a)})):this.src=""}}))},shimPeerConnection:function(c){var g=h.detectBrowser(c);if(c.RTCPeerConnection){var a=c.RTCPeerConnection;c.RTCPeerConnection=
function(b,c){if(b&&b.iceServers){for(var d=[],e=0;e<b.iceServers.length;e++){var f=b.iceServers[e];!f.hasOwnProperty("urls")&&f.hasOwnProperty("url")?(h.deprecated("RTCIceServer.url","RTCIceServer.urls"),f=JSON.parse(JSON.stringify(f)),f.urls=f.url,d.push(f)):d.push(b.iceServers[e])}b.iceServers=d}return new a(b,c)};c.RTCPeerConnection.prototype=a.prototype;Object.defineProperty(c.RTCPeerConnection,"generateCertificate",{get:function(){return a.generateCertificate}})}else c.RTCPeerConnection=function(a,
d){b("PeerConnection");a&&a.iceTransportPolicy&&(a.iceTransports=a.iceTransportPolicy);return new c.webkitRTCPeerConnection(a,d)},c.RTCPeerConnection.prototype=c.webkitRTCPeerConnection.prototype,c.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(c.RTCPeerConnection,"generateCertificate",{get:function(){return c.webkitRTCPeerConnection.generateCertificate}});var k=c.RTCPeerConnection.prototype.getStats;c.RTCPeerConnection.prototype.getStats=function(a,b,c){var e=this,d=arguments;
if(0<arguments.length&&"function"===typeof a)return k.apply(this,arguments);if(0===k.length&&(0===arguments.length||"function"!==typeof arguments[0]))return k.apply(this,[]);var g=function(a){var b={};a.result().forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type};a.names().forEach(function(b){c[b]=a.stat(b)});b[c.id]=c});return b},l=function(a){return new Map(Object.keys(a).map(function(b){return[b,a[b]]}))};
return 2<=arguments.length?k.apply(this,[function(a){d[1](l(g(a)))},arguments[0]]):(new Promise(function(a,b){k.apply(e,[function(b){a(l(g(b)))},b])})).then(b,c)};51>g.version&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=c.RTCPeerConnection.prototype[a];c.RTCPeerConnection.prototype[a]=function(){var a=arguments,c=this,d=new Promise(function(e,d){b.apply(c,[a[0],e,d])});return 2>a.length?d:d.then(function(){a[1].apply(null,[])},function(b){3<=a.length&&
a[2].apply(null,[b])})}});52>g.version&&["createOffer","createAnswer"].forEach(function(a){var b=c.RTCPeerConnection.prototype[a];c.RTCPeerConnection.prototype[a]=function(){var a=this;if(1>arguments.length||1===arguments.length&&"object"===typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(e,d){b.apply(a,[e,d,c])})}return b.apply(this,arguments)}});["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=c.RTCPeerConnection.prototype[a];
c.RTCPeerConnection.prototype[a]=function(){arguments[0]=new ("addIceCandidate"===a?c.RTCIceCandidate:c.RTCSessionDescription)(arguments[0]);return b.apply(this,arguments)}});var d=c.RTCPeerConnection.prototype.addIceCandidate;c.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?d.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}},shimGetUserMedia:p("./getusermedia")}},{"../utils.js":13,"./getusermedia":6}],6:[function(p,t,q){var h=p("../utils.js"),
b=h.log;t.exports=function(c){var g=h.detectBrowser(c),a=c&&c.navigator,k=function(a){if("object"!==typeof a||a.mandatory||a.optional)return a;var b={};Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var e="object"===typeof a[c]?a[c]:{ideal:a[c]};void 0!==e.exact&&"number"===typeof e.exact&&(e.min=e.max=e.exact);var d=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==e.ideal){b.optional=b.optional||[];var f=
{};"number"===typeof e.ideal?(f[d("min",c)]=e.ideal,b.optional.push(f),f={},f[d("max",c)]=e.ideal):f[d("",c)]=e.ideal;b.optional.push(f)}void 0!==e.exact&&"number"!==typeof e.exact?(b.mandatory=b.mandatory||{},b.mandatory[d("",c)]=e.exact):["min","max"].forEach(function(a){void 0!==e[a]&&(b.mandatory=b.mandatory||{},b.mandatory[d(a,c)]=e[a])})}});a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced));return b},d=function(c,d){if((c=JSON.parse(JSON.stringify(c)))&&"object"===typeof c.audio){var e=
function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])};c=JSON.parse(JSON.stringify(c));e(c.audio,"autoGainControl","googAutoGainControl");e(c.audio,"noiseSuppression","googNoiseSuppression");c.audio=k(c.audio)}if(c&&"object"===typeof c.video){var f=c.video.facingMode,f=f&&("object"===typeof f?f:{ideal:f}),e=61>g.version;if(!(!f||"user"!==f.exact&&"environment"!==f.exact&&"user"!==f.ideal&&"environment"!==f.ideal||a.mediaDevices.getSupportedConstraints&&a.mediaDevices.getSupportedConstraints().facingMode&&
!e)){delete c.video.facingMode;var l;if("environment"===f.exact||"environment"===f.ideal)l=["back","rear"];else if("user"===f.exact||"user"===f.ideal)l=["front"];if(l)return a.mediaDevices.enumerateDevices().then(function(a){a=a.filter(function(a){return"videoinput"===a.kind});var e=a.find(function(a){return l.some(function(b){return-1!==a.label.toLowerCase().indexOf(b)})});!e&&a.length&&-1!==l.indexOf("back")&&(e=a[a.length-1]);e&&(c.video.deviceId=f.exact?{exact:e.deviceId}:{ideal:e.deviceId});
c.video=k(c.video);b("chrome: "+JSON.stringify(c));return d(c)})}c.video=k(c.video)}b("chrome: "+JSON.stringify(c));return d(c)},r=function(a){return{name:{PermissionDeniedError:"NotAllowedError",InvalidStateError:"NotReadableError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotReadableError",MediaDeviceKillSwitchOn:"NotReadableError"}[a.name]||a.name,message:a.message,constraint:a.constraintName,
toString:function(){return this.name+(this.message&&": ")+this.message}}};a.getUserMedia=function(b,c,g){d(b,function(b){a.webkitGetUserMedia(b,c,function(a){g&&g(r(a))})})};var m=function(b){return new Promise(function(c,e){a.getUserMedia(b,c,e)})};a.mediaDevices||(a.mediaDevices={getUserMedia:m,enumerateDevices:function(){return new Promise(function(a){var b={audio:"audioinput",video:"videoinput"};return c.MediaStreamTrack.getSources(function(c){a(c.map(function(a){return{label:a.label,kind:b[a.kind],
deviceId:a.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}});if(a.mediaDevices.getUserMedia){var l=a.mediaDevices.getUserMedia.bind(a.mediaDevices);a.mediaDevices.getUserMedia=function(a){return d(a,function(a){return l(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");
return b},function(a){return Promise.reject(r(a))})})}}else a.mediaDevices.getUserMedia=function(a){return m(a)};"undefined"===typeof a.mediaDevices.addEventListener&&(a.mediaDevices.addEventListener=function(){b("Dummy mediaDevices.addEventListener called.")});"undefined"===typeof a.mediaDevices.removeEventListener&&(a.mediaDevices.removeEventListener=function(){b("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":13}],7:[function(p,t,q){function h(b,a,c){if(b.RTCPeerConnection){b=
b.RTCPeerConnection.prototype;var d=b.addEventListener;b.addEventListener=function(b,g){if(b!==a)return d.apply(this,arguments);var e=function(a){g(c(a))};this._eventMap=this._eventMap||{};this._eventMap[g]=e;return d.apply(this,[b,e])};var g=b.removeEventListener;b.removeEventListener=function(b,c){if(b!==a||!this._eventMap||!this._eventMap[c])return g.apply(this,arguments);var d=this._eventMap[c];delete this._eventMap[c];return g.apply(this,[b,d])};Object.defineProperty(b,"on"+a,{get:function(){return this["_on"+
a]},set:function(b){this["_on"+a]&&(this.removeEventListener(a,this["_on"+a]),delete this["_on"+a]);b&&this.addEventListener(a,this["_on"+a]=b)}})}}var b=p("sdp"),c=p("./utils");t.exports={shimRTCIceCandidate:function(c){if(!(c.RTCIceCandidate&&"foundation"in c.RTCIceCandidate.prototype)){var a=c.RTCIceCandidate;c.RTCIceCandidate=function(c){"object"===typeof c&&c.candidate&&0===c.candidate.indexOf("a=")&&(c=JSON.parse(JSON.stringify(c)),c.candidate=c.candidate.substr(2));var d=new a(c);c=b.parseCandidate(c.candidate);
var g=Object.assign(d,c);g.toJSON=function(){return{candidate:g.candidate,sdpMid:g.sdpMid,sdpMLineIndex:g.sdpMLineIndex,usernameFragment:g.usernameFragment}};return g};h(c,"icecandidate",function(a){a.candidate&&Object.defineProperty(a,"candidate",{value:new c.RTCIceCandidate(a.candidate),writable:"false"});return a})}},shimCreateObjectURL:function(b){if(navigator&&!/iPhone|iPad|iPod/i.test(navigator.userAgent)&&-1==navigator.userAgent.toLowerCase().indexOf("chrome")&&11<=(-1!==navigator.userAgent.toLowerCase().indexOf("safari")&&
parseFloat(navigator.userAgent.match(/version\/(\d+)/i)[1]))&&null===navigator.userAgent.match(/mobile\/(\d+)/i)||-1!==navigator.userAgent.toLowerCase().indexOf("firefox")){var a=b&&b.URL;if("object"===typeof b&&b.HTMLMediaElement&&"srcObject"in b.HTMLMediaElement.prototype&&a.createObjectURL&&a.revokeObjectURL){var g=a.createObjectURL.bind(a),d=a.revokeObjectURL.bind(a),h=new Map,m=0;a.createObjectURL=function(a){if("getTracks"in a){var b="polyblob:"+ ++m;h.set(b,a);c.deprecated("URL.createObjectURL(stream)",
"elem.srcObject = stream");return b}return g(a)};a.revokeObjectURL=function(a){d(a);h["delete"](a)};var l=Object.getOwnPropertyDescriptor(b.HTMLMediaElement.prototype,"src");Object.defineProperty(b.HTMLMediaElement.prototype,"src",{get:function(){return l.get.apply(this)},set:function(a){this.srcObject=h.get(a)||null;return l.set.apply(this,[a])}});var e=b.HTMLMediaElement.prototype.setAttribute;b.HTMLMediaElement.prototype.setAttribute=function(){2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&
(this.srcObject=h.get(arguments[1])||null);return e.apply(this,arguments)}}}}}},{"./utils":13,sdp:2}],8:[function(p,t,q){var h=p("../utils"),b=p("rtcpeerconnection-shim");t.exports={shimGetUserMedia:p("./getusermedia"),shimPeerConnection:function(c){var g=h.detectBrowser(c);if(c.RTCIceGatherer&&(c.RTCIceCandidate||(c.RTCIceCandidate=function(a){return a}),c.RTCSessionDescription||(c.RTCSessionDescription=function(a){return a}),15025>g.version)){var a=Object.getOwnPropertyDescriptor(c.MediaStreamTrack.prototype,
"enabled");Object.defineProperty(c.MediaStreamTrack.prototype,"enabled",{set:function(b){a.set.call(this,b);var c=new Event("enabled");c.enabled=b;this.dispatchEvent(c)}})}!c.RTCRtpSender||"dtmf"in c.RTCRtpSender.prototype||Object.defineProperty(c.RTCRtpSender.prototype,"dtmf",{get:function(){void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new c.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null));return this._dtmf}});c.RTCPeerConnection=b(c,g.version)},shimReplaceTrack:function(b){!b.RTCRtpSender||
"replaceTrack"in b.RTCRtpSender.prototype||(b.RTCRtpSender.prototype.replaceTrack=b.RTCRtpSender.prototype.setTrack)}}},{"../utils":13,"./getusermedia":9,"rtcpeerconnection-shim":1}],9:[function(p,t,q){t.exports=function(h){h=h&&h.navigator;var b=function(b){return{name:{PermissionDeniedError:"NotAllowedError"}[b.name]||b.name,message:b.message,constraint:b.constraint,toString:function(){return this.name}}},c=h.mediaDevices.getUserMedia.bind(h.mediaDevices);h.mediaDevices.getUserMedia=function(g){return c(g)["catch"](function(a){return Promise.reject(b(a))})}}},
{}],10:[function(p,t,q){var h=p("../utils");t.exports={shimOnTrack:function(b){"object"!==typeof b||!b.RTCPeerConnection||"ontrack"in b.RTCPeerConnection.prototype||Object.defineProperty(b.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(b){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly));this.addEventListener("track",this._ontrack=b);this.addEventListener("addstream",this._ontrackpoly=
function(b){b.stream.getTracks().forEach(function(a){var c=new Event("track");c.track=a;c.receiver={track:a};c.transceiver={receiver:c.receiver};c.streams=[b.stream];this.dispatchEvent(c)}.bind(this))}.bind(this))}});"object"===typeof b&&b.RTCTrackEvent&&"receiver"in b.RTCTrackEvent.prototype&&!("transceiver"in b.RTCTrackEvent.prototype)&&Object.defineProperty(b.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(b){"object"===typeof b&&
(!b.HTMLMediaElement||"srcObject"in b.HTMLMediaElement.prototype||Object.defineProperty(b.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(b){this.mozSrcObject=b}}))},shimPeerConnection:function(b){var c=h.detectBrowser(b);if("object"===typeof b&&(b.RTCPeerConnection||b.mozRTCPeerConnection)){b.RTCPeerConnection||(b.RTCPeerConnection=function(a,d){if(38>c.version&&a&&a.iceServers){for(var g=[],e=0;e<a.iceServers.length;e++){var f=a.iceServers[e];if(f.hasOwnProperty("urls"))for(var k=
0;k<f.urls.length;k++){var h={url:f.urls[k]};0===f.urls[k].indexOf("turn")&&(h.username=f.username,h.credential=f.credential);g.push(h)}else g.push(a.iceServers[e])}a.iceServers=g}return new b.mozRTCPeerConnection(a,d)},b.RTCPeerConnection.prototype=b.mozRTCPeerConnection.prototype,b.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(b.RTCPeerConnection,"generateCertificate",{get:function(){return b.mozRTCPeerConnection.generateCertificate}}),b.RTCSessionDescription=b.mozRTCSessionDescription,
b.RTCIceCandidate=b.mozRTCIceCandidate);["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var c=b.RTCPeerConnection.prototype[a];b.RTCPeerConnection.prototype[a]=function(){arguments[0]=new ("addIceCandidate"===a?b.RTCIceCandidate:b.RTCSessionDescription)(arguments[0]);return c.apply(this,arguments)}});var g=b.RTCPeerConnection.prototype.addIceCandidate;b.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?g.apply(this,arguments):(arguments[1]&&
arguments[1].apply(null),Promise.resolve())};var a=function(a){var b=new Map;Object.keys(a).forEach(function(c){b.set(c,a[c]);b[c]=a[c]});return b},k={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},d=b.RTCPeerConnection.prototype.getStats;b.RTCPeerConnection.prototype.getStats=function(b,g,l){return d.apply(this,[b||null]).then(function(b){48>c.version&&(b=a(b));if(53>c.version&&!g)try{b.forEach(function(a){a.type=
k[a.type]||a.type})}catch(f){if("TypeError"!==f.name)throw f;b.forEach(function(a,c){b.set(c,Object.assign({},a,{type:k[a.type]||a.type}))})}return b}).then(g,l)}}},shimGetUserMedia:p("./getusermedia")}},{"../utils":13,"./getusermedia":11}],11:[function(p,t,q){var h=p("../utils"),b=h.log;t.exports=function(c){var g=h.detectBrowser(c),a=c&&c.navigator;c=c&&c.MediaStreamTrack;var k=function(a){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",
SecurityError:"NotAllowedError"}[a.name]||a.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[a.message]||a.message,constraint:a.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},d=function(c,d,e){var f=function(a){if("object"!==typeof a||a.require)return a;var b=[];Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"===typeof a[c]?
a[c]:{ideal:a[c]};void 0===d.min&&void 0===d.max&&void 0===d.exact||b.push(c);void 0!==d.exact&&("number"===typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact);if(void 0!==d.ideal){a.advanced=a.advanced||[];var e={};e[c]="number"===typeof d.ideal?{min:d.ideal,max:d.ideal}:d.ideal;a.advanced.push(e);delete d.ideal;Object.keys(d).length||delete a[c]}}});b.length&&(a.require=b);return a};c=JSON.parse(JSON.stringify(c));38>g.version&&(b("spec: "+JSON.stringify(c)),c.audio&&(c.audio=f(c.audio)),
c.video&&(c.video=f(c.video)),b("ff37: "+JSON.stringify(c)));return a.mozGetUserMedia(c,d,function(a){e(k(a))})},r=function(a){return new Promise(function(b,c){d(a,b,c)})};a.mediaDevices||(a.mediaDevices={getUserMedia:r,addEventListener:function(){},removeEventListener:function(){}});a.mediaDevices.enumerateDevices=a.mediaDevices.enumerateDevices||function(){return new Promise(function(a){a([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",
groupId:""}])})};if(41>g.version){var m=a.mediaDevices.enumerateDevices.bind(a.mediaDevices);a.mediaDevices.enumerateDevices=function(){return m().then(void 0,function(a){if("NotFoundError"===a.name)return[];throw a;})}}if(49>g.version){var l=a.mediaDevices.getUserMedia.bind(a.mediaDevices);a.mediaDevices.getUserMedia=function(a){return l(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("The object can not be found here.",
"NotFoundError");return b},function(a){return Promise.reject(k(a))})}}if(!(55<g.version&&"autoGainControl"in a.mediaDevices.getSupportedConstraints())){var e=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])},f=a.mediaDevices.getUserMedia.bind(a.mediaDevices);a.mediaDevices.getUserMedia=function(a){"object"===typeof a&&"object"===typeof a.audio&&(a=JSON.parse(JSON.stringify(a)),e(a.audio,"autoGainControl","mozAutoGainControl"),e(a.audio,"noiseSuppression","mozNoiseSuppression"));return f(a)};
if(c&&c.prototype.getSettings){var p=c.prototype.getSettings;c.prototype.getSettings=function(){var a=p.apply(this,arguments);e(a,"mozAutoGainControl","autoGainControl");e(a,"mozNoiseSuppression","noiseSuppression");return a}}if(c&&c.prototype.applyConstraints){var n=c.prototype.applyConstraints;c.prototype.applyConstraints=function(a){"audio"===this.kind&&"object"===typeof a&&(a=JSON.parse(JSON.stringify(a)),e(a,"autoGainControl","mozAutoGainControl"),e(a,"noiseSuppression","mozNoiseSuppression"));
return n.apply(this,[a])}}}a.getUserMedia=function(b,c,e){if(44>g.version)return d(b,c,e);h.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");a.mediaDevices.getUserMedia(b).then(c,e)}}},{"../utils":13}],12:[function(p,t,q){var h=p("../utils");t.exports={shimCallbacksAPI:function(b){if("object"===typeof b&&b.RTCPeerConnection){b=b.RTCPeerConnection.prototype;var c=b.createOffer,g=b.createAnswer,a=b.setLocalDescription,k=b.setRemoteDescription,d=b.addIceCandidate;b.createOffer=
function(a,b){var d=c.apply(this,[2<=arguments.length?arguments[2]:arguments[0]]);if(!b)return d;d.then(a,b);return Promise.resolve()};b.createAnswer=function(a,b){var c=g.apply(this,[2<=arguments.length?arguments[2]:arguments[0]]);if(!b)return c;c.then(a,b);return Promise.resolve()};var h=function(b,c,d){b=a.apply(this,[b]);if(!d)return b;b.then(c,d);return Promise.resolve()};b.setLocalDescription=h;h=function(a,b,c){a=k.apply(this,[a]);if(!c)return a;a.then(b,c);return Promise.resolve()};b.setRemoteDescription=
h;h=function(a,b,c){a=d.apply(this,[a]);if(!c)return a;a.then(b,c);return Promise.resolve()};b.addIceCandidate=h}},shimLocalStreamsAPI:function(b){if("object"===typeof b&&b.RTCPeerConnection){"getLocalStreams"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.getLocalStreams=function(){this._localStreams||(this._localStreams=[]);return this._localStreams});"getStreamById"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.getStreamById=function(b){var a=null;this._localStreams&&
this._localStreams.forEach(function(c){c.id===b&&(a=c)});this._remoteStreams&&this._remoteStreams.forEach(function(c){c.id===b&&(a=c)});return a});if(!("addStream"in b.RTCPeerConnection.prototype)){var c=b.RTCPeerConnection.prototype.addTrack;b.RTCPeerConnection.prototype.addStream=function(b){this._localStreams||(this._localStreams=[]);-1===this._localStreams.indexOf(b)&&this._localStreams.push(b);var a=this;b.getTracks().forEach(function(g){c.call(a,g,b)})};b.RTCPeerConnection.prototype.addTrack=
function(b,a){a&&(this._localStreams?-1===this._localStreams.indexOf(a)&&this._localStreams.push(a):this._localStreams=[a]);c.call(this,b,a)}}"removeStream"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.removeStream=function(b){this._localStreams||(this._localStreams=[]);var a=this._localStreams.indexOf(b);if(-1!==a){this._localStreams.splice(a,1);var c=this,d=b.getTracks();this.getSenders().forEach(function(a){-1!==d.indexOf(a.track)&&c.removeTrack(a)})}})}},shimRemoteStreamsAPI:function(b){"object"===
typeof b&&b.RTCPeerConnection&&("getRemoteStreams"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),"onaddstream"in b.RTCPeerConnection.prototype||Object.defineProperty(b.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(b){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly));this.addEventListener("addstream",
this._onaddstream=b);this.addEventListener("track",this._onaddstreampoly=function(b){var a=b.streams[0];this._remoteStreams||(this._remoteStreams=[]);0<=this._remoteStreams.indexOf(a)||(this._remoteStreams.push(a),a=new Event("addstream"),a.stream=b.streams[0],this.dispatchEvent(a))}.bind(this))}}))},shimGetUserMedia:function(b){var c=b&&b.navigator;c.getUserMedia||(c.webkitGetUserMedia?c.getUserMedia=c.webkitGetUserMedia.bind(c):c.mediaDevices&&c.mediaDevices.getUserMedia&&(c.getUserMedia=function(b,
a,k){c.mediaDevices.getUserMedia(b).then(a,k)}.bind(c)))},shimRTCIceServerUrls:function(b){var c=b.RTCPeerConnection;b.RTCPeerConnection=function(b,a){if(b&&b.iceServers){for(var g=[],d=0;d<b.iceServers.length;d++){var r=b.iceServers[d];!r.hasOwnProperty("urls")&&r.hasOwnProperty("url")?(h.deprecated("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,g.push(r)):g.push(b.iceServers[d])}b.iceServers=g}return new c(b,a)};b.RTCPeerConnection.prototype=c.prototype;
"generateCertificate"in b.RTCPeerConnection&&Object.defineProperty(b.RTCPeerConnection,"generateCertificate",{get:function(){return c.generateCertificate}})},shimTrackEventTransceiver:function(b){"object"===typeof b&&b.RTCPeerConnection&&"receiver"in b.RTCTrackEvent.prototype&&!b.RTCTransceiver&&Object.defineProperty(b.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}}},{"../utils":13}],13:[function(p,t,q){var h=!0,b=!0;p={disableLog:function(b){return"boolean"!==
typeof b?Error("Argument type: "+typeof b+". Please use a boolean."):(h=b)?"adapter.js logging disabled":"adapter.js logging enabled"},disableWarnings:function(c){if("boolean"!==typeof c)return Error("Argument type: "+typeof c+". Please use a boolean.");b=!c;return"adapter.js deprecation warnings "+(c?"disabled":"enabled")},log:function(){"object"!==typeof window||h||"undefined"!==typeof console&&"function"===typeof console.log&&console.log.apply(console,arguments)},deprecated:function(c,g){b&&console.warn(c+
" is deprecated, please use "+g+" instead.")},extractVersion:function(b,g,a){return(b=b.match(g))&&b.length>=a&&parseInt(b[a],10)},detectBrowser:function(b){var c=b&&b.navigator,a={browser:null,version:null};if("undefined"===typeof b||!b.navigator)return a.browser="Not a browser.",a;c.mozGetUserMedia?(a.browser="firefox",a.version=this.extractVersion(c.userAgent,/Firefox\/(\d+)\./,1)):c.webkitGetUserMedia?b.webkitRTCPeerConnection?(a.browser="chrome",a.version=this.extractVersion(c.userAgent,/Chrom(e|ium)\/(\d+)\./,
2)):c.userAgent.match(/Version\/(\d+).(\d+)/)?(a.browser="safari",a.version=this.extractVersion(c.userAgent,/AppleWebKit\/(\d+)\./,1)):a.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.":c.mediaDevices&&c.userAgent.match(/Edge\/(\d+).(\d+)$/)?(a.browser="edge",a.version=this.extractVersion(c.userAgent,/Edge\/(\d+).(\d+)$/,2)):c.mediaDevices&&c.userAgent.match(/AppleWebKit\/(\d+)\./)?(a.browser="safari",a.version=this.extractVersion(c.userAgent,/AppleWebKit\/(\d+)\./,
1)):a.browser="Not a supported browser.";return a}};t.exports={log:p.log,deprecated:p.deprecated,disableLog:p.disableLog,disableWarnings:p.disableWarnings,extractVersion:p.extractVersion,shimCreateObjectURL:p.shimCreateObjectURL,detectBrowser:p.detectBrowser.bind(p)}},{}]},{},[3])(3)}()}).call(C,function(){return this}())},501:function(B,C,u){function w(b){return b&&b.__esModule?b:{"default":b}}Object.defineProperty(C,"__esModule",{value:!0});var E=function(){function b(b,g){for(var a=0;a<g.length;a++){var c=
g[a];c.enumerable=c.enumerable||!1;c.configurable=!0;"value"in c&&(c.writable=!0);Object.defineProperty(b,c.key,c)}}return function(c,g,a){g&&b(c.prototype,g);a&&b(c,a);return c}}(),p=u(500);w(p);p=u(160);w(p);p=u(98);w(p);u=u(1);var t=w(u);u="undefined"!==typeof RTCPeerConnection&&null!==RTCPeerConnection;var q=function(){function b(){if(!(this instanceof b))throw new TypeError("Cannot call a class as a function");}E(b,null,[{key:"checkFirefoxExtInstalled",value:function(b){var c=Math.random();window[c]=
function(a){1==a||"1"===a?b(!0):b(!1)};window.parent.parent.postMessage("cocomm__sendMessgeBack('window[\\'"+c+"\\']('+(document.body.classList.contains('ff-tagove-ext-installed')?1:0)+')');","*")}},{key:"getUserMediaStreams",value:function(c,g){var a=2>=arguments.length||void 0===arguments[2]?!1:arguments[2],k=this,d=3>=arguments.length||void 0===arguments[3]?null:arguments[3],r=4>=arguments.length||void 0===arguments[4]?null:arguments[4],m=b.streams[c];if(a||!m||m.ended||!1===m.active||d){var l=
[];b.streams[c]=function(a){l.push(a)};var e=function(a,c){c.dispose=function(){try{c.getTracks().length&&c.getTracks()[0].stop&&c.getTracks().forEach(function(a){a.stop()})}catch(F){}try{c.stop()}catch(F){}};t["default"].each(l,function(a,b){b(c)});b.streams[a]=c;g(null,c,a)},m={width:{exact:1280},height:{exact:720}},f={optional:[],mandatory:{}};"0"===tagoveApp.settings().hdClient&&(m={mandatory:{minWidth:640,minHeight:480,maxAspectRatio:4/3},optional:[]});/iPhone|iPad|iPod/i.test(navigator.userAgent)&&
(m={width:{ideal:640},height:{ideal:480}},f=!0);var p=function z(d){var f=d.fallback;delete d.fallback;navigator.getUserMedia(d,function(a){a.localStream=!0;e(c,a)},function(d){if(d&&f)z(f);else{if("video"==c)return alert("Please allow access to webcam, we are trying again with microphone only."),b.logger&&b.logger.error(d),b.getUserMediaStreams("audio",g,a);"screen"==c?(alert("Please allow access to screen sharing or might be your browser is not supported for screen sharing."),b.logger&&b.logger.error(d),
g(d)):"audio"==c&&(alert("Please allow access your microphone and speaker."),b.logger&&b.logger.error(d),g(d))}})};if("screen"==c){m=function(){var f;f=b.isChrome?{mandatory:{chromeMediaSource:h.screen.chromeMediaSource,maxWidth:1920,maxHeight:1080,minAspectRatio:16/9},optional:[]}:b.isFirefox?{mozMediaSource:"window",mediaSource:"window",maxWidth:1920,maxHeight:1080,minAspectRatio:16/9}:{audio:!1,video:{mandatory:{chromeMediaSource:"screen",mediaSource:"screen",maxWidth:1280,maxHeight:720},optional:[]}};
var l=function(){b.isChrome&&"desktop"==h.screen.chromeMediaSource&&!d?h.screen.getSourceId(function(d){d&&"PermissionDeniedError"==d?(alert("PermissionDeniedError: User denied to share content of his screen."),g("User denied")):b.getUserMediaStreams(c,g,a,d)}):(b.isChrome&&"desktop"==h.screen.chromeMediaSource&&(f.mandatory.chromeMediaSourceId=h.screen.sourceId),navigator.getUserMedia({audio:!1,video:f},function(a){e("screen",a)},function(){h.screen.isChromeExtensionAvailable(function(a){b.isFirefox?
(alert("Please give access to capture your screen when asked."),g("User denied")):a&&b.isChrome?(alert("Please give access to capture your screen when asked."),g("User denied")):b.isChrome?(g("Please install following chrome extension to enable screen sharing"),a=document.createElement("link"),0==(0,t["default"])('[href="https://chrome.google.com/webstore/detail/cbpcdhgamaoohffhbklobgmfemlahnho"]').length&&(a.setAttribute("href","https://chrome.google.com/webstore/detail/cbpcdhgamaoohffhbklobgmfemlahnho"),
a.setAttribute("rel","chrome-webstore-item"),document.head.appendChild(a)),r.doChromeExtInstall(function(){try{chrome.webstore.install("https://chrome.google.com/webstore/detail/cbpcdhgamaoohffhbklobgmfemlahnho",function(){r.doChromeExtInstall(!1);window.location.href=window.location.href},function(a,b){window.open("https://chrome.google.com/webstore/detail/cbpcdhgamaoohffhbklobgmfemlahnho","_blank");r.app.logger.log(a)})}catch(y){window.open("https://chrome.google.com/webstore/detail/cbpcdhgamaoohffhbklobgmfemlahnho",
"_blank")}})):(alert("Screen sharing is only available on chrome."),g("Not Support"))})}))};if(b.isFirefox){var m=function y(){k.checkFirefoxExtInstalled(function(a){a?l():setTimeout(y,500)})};k.checkFirefoxExtInstalled(function(a){a?l():(window.location.href="https://app.tagove.com/thirdparty/tagove-screenshare-firefox-extension/@tagove-screenshare-firefox-extension-0.0.1.xpi",m())})}else l()};try{if("object"==typeof window.process){var n=eval("require('nw.gui');");n.Screen.Init();n.Screen.chooseDesktopMedia(["window",
"screen"],function(a){navigator.webkitGetUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxWidth:1920,maxHeight:1080},optional:[]}},function(a){e("screem",a)},function(){alert("Please allow screen sharing access")})})}else m()}catch(z){m(),console.error(z)}}else"audio"==c?p({audio:f}):"video"==c&&p("0"!==tagoveApp.settings().hdClient?{video:m,audio:f,fallback:{video:{mandatory:{minWidth:640,minHeight:480,maxAspectRatio:4/3},optional:[]},audio:f}}:{video:m,
audio:f})}else if("function"==typeof m)m(function(a){return g(null,a,c)});else return g(null,m,c)}},{key:"filterCandidates",value:function(){}},{key:"generateCallid",value:function(){for(var b="",g=0;5>g;g++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return b}},{key:"lineSettings",value:function(b){"Safari"!==window.parserResult.browser.name&&(b.sdp=b.sdp.replace("UDP/TLS/RTP/SAVPF","RTP/SAVPF"));return b}},{key:"handleIceCandidates",value:function(c,
g,a,k,d){c.oniceconnectionstatechange=function(a){null!==c&&("disconnected"==c.iceConnectionState||"closed"==c.iceConnectionState||"failed"==c.iceConnectionState?k?k(!0):"":"completed"==c.iceConnectionState&&"complete"==c.iceGatheringState&&"stable"==c.signalingState&&(k?k(null,!0):""))};c.onnegotiationneeded=function(a){d()};var h=0;c.onicecandidate=function(c){if(null!=c.candidate){var d=!1;b.removeLocalCandidates&&(0<=c.candidate.candidate.indexOf("127.0.0.1")||0<=c.candidate.candidate.indexOf("localhost")||
0<=c.candidate.candidate.indexOf("192.168."))&&(d=!0);b.forceTurnServer&&"relay"!==c.candidate.candidate.split(" ")[7]&&(d=!0);d||(h++,a(c.candidate))}}}}]);return b}();q.logger=null;q.streams={};q.isChrome=!!navigator.webkitGetUserMedia;q.isFirefox=!!navigator.mozGetUserMedia;q.forceTurnServer=!1;q.webrtcSupported=u;q.removeLocalCandidates=!1;q.PeerConnectionConfig={iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]},{urls:["stun:stun2.l.google.com:19302"]}]};
q.PeerConnectionOptions={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]};var h={};(function(){var b;h.screen={chromeMediaSource:"screen",getSourceId:function(c){if(!c)throw'"callback" parameter is mandatory.';b=c;window.postMessage("get-sourceId","*")},isChromeExtensionAvailable:function(b){"desktop"==h.screen.chromeMediaSource&&b(!0);window.postMessage("are-you-there","*");setTimeout(function(){"screen"==h.screen.chromeMediaSource?b?b(!1):"":b?b(!0):""},2E3)},onMessageCallback:function(c){if("PermissionDeniedError"==
c){h.screen.chromeMediaSource="PermissionDeniedError";if(b)return b("PermissionDeniedError");throw Error("PermissionDeniedError");}"rtcmulticonnection-extension-loaded"==c&&(h.screen.chromeMediaSource="desktop");c.sourceId&&(h.screen.sourceId=c.sourceId,b&&b(h.screen.sourceId))}};window.postMessage&&q.isChrome&&h.screen.isChromeExtensionAvailable()})();window.addEventListener("message",function(b){if(b.origin==window.location.origin)h.screen.onMessageCallback(b.data)});C["default"]=q;B.exports=C["default"]},
502:function(B,C,u){function w(b){return b&&b.__esModule?b:{"default":b}}Object.defineProperty(C,"__esModule",{value:!0});var E=function(){function b(a,b){for(var c=0;c<b.length;c++){var g=b[c];g.enumerable=g.enumerable||!1;g.configurable=!0;"value"in g&&(g.writable=!0);Object.defineProperty(a,g.key,g)}}return function(a,c,d){c&&b(a.prototype,c);d&&b(a,d);return a}}(),p=u(500);w(p);var p=u(160),t=w(p),p=u(1),q=w(p),p=u(280),h=w(p),p=u(98);w(p);var b=u(499);u=u(501);var c=w(u);u=function(){function g(a,
b){var d=this;if(!(this instanceof g))throw new TypeError("Cannot call a class as a function");c["default"].logger=b.logger;this.twilioToken=b.app.config.twilioToken||[];this.user=a;this.room=b;this.callback_type=t["default"].observable("visitor"==a().type?"required":b.chat.app.cookieManager.getSimple("_rtcct","required"));this.callback_type.subscribe(function(){b.chat.app.cookieManager.setSimple("_rtcct",d.callback_type())});this.status=t["default"].observable("standby");this.screen_status=t["default"].observable("standby");
this.config=t["default"].observable({flashSupported:!0,sslVersion:0===location.href.indexOf("https://")||0<=location.href.indexOf("://localhost"),webrtcCoreSupported:c["default"].webrtcSupported,webrtcSupported:c["default"].webrtcSupported&&(0===location.href.indexOf("https://")||0<=location.href.indexOf("://localhost"))});this.logger=b.logger.logger("user-"+a().id);this.connections={};this.rotation=t["default"].observable(0);this._stream=t["default"].observable({screen:null,rtc:null,flash:null,video_mute:!1,
audio_mute:!1,screen_mute:!1});this.stream=t["default"].computed({read:function(){return d._stream()},write:function(a){d._stream(q["default"].extend(!0,d._stream(),a))}});this.rtcStreamName=t["default"].computed(function(){a();return d.stream().rtc?a().id+"-"+(0>d.stream_type().indexOf("audio_only")?"video":"audio"):"na"});this.screenStreamName=t["default"].computed(function(){a();return d.stream().screen&&a()?a().id+"-screen":"na"});this.stream_type=t["default"].computed(function(){var a=[];d.stream().flash&&
a.push("flash");d.stream().screen&&a.push("screen");d.stream().rtc&&(a.push("rtc"),0<d.stream().rtc.getVideoTracks().length&&a.push("video"),0<d.stream().rtc.getAudioTracks().length&&a.push("audio"),0<d.stream().rtc.getVideoTracks().length&&0==d.stream().rtc.getAudioTracks().length&&a.push("video_only"),0==d.stream().rtc.getVideoTracks().length&&0<d.stream().rtc.getAudioTracks().length&&a.push("audio_only"),0==d.stream().rtc.getVideoTracks().length&&0==d.stream().rtc.getAudioTracks().length&&a.push("none"));
return a});this.flashFrameUrl=t["default"].computed(function(){if(d.stream().flash){var a=d.stream().flash.replace("@","");return 0===d.stream().flash.indexOf("@")?tagoveApp.getServerAssetUrl("flash-call.html?play="+a+"&pub="+a+"x"):tagoveApp.getServerAssetUrl("flash-call.html?play="+a+"x&pub="+a)}return!1});this.video_mute=t["default"].observable(null);this.audio_mute=t["default"].observable(null);this.screen_mute=t["default"].observable(null);this.sholudWePickCall=t["default"].observable(null);
this.sholudWePickCall.subscribe(function(){try{d.sholudWePickCall()?(d.room.call_sound.loop=!0,d.room.call_sound.play()):(d.room.call_sound.loop=!1,d.room.call_sound.pause(),d.room.call_sound.currentTime=0,d.room.call_sound.pause(),setTimeout(function(){d.room.call_sound.loop=!1;d.room.call_sound.pause();d.room.call_sound.currentTime=0;d.room.call_sound.pause()},1E3))}catch(r){console.error(r)}});this.video_mute.subscribe(function(){!d.stream().flash&&d.stream().rtc&&0<d.stream().rtc.getVideoTracks().length&&
(d.stream().rtc.getVideoTracks()[0].enabled=!d.video_mute())});setTimeout(function(){["video_mute","audio_mute","screen_mute"].forEach(function(a){d[a].subscribe(function(){d._stream()&&!d._stream().flash&&(q["default"].each(d.room.users(),function(b,c){c.msg(a,d[a]())}),d._stream()[a]=d[a](),d._stream.valueHasMutated())})})},500);this.audio_mute.subscribe(function(){!d.stream().flash&&d.stream().rtc&&0<d.stream().rtc.getAudioTracks().length&&(d.stream().rtc.getAudioTracks()[0].enabled=!d.audio_mute())});
this.screen_mute.subscribe(function(){!d.stream().flash&&d.stream().screen&&0<d.stream().screen.getVideoTracks().length&&(d.stream().screen.getVideoTracks()[0].enabled=!d.screen_mute())});this.stream.subscribe(function(){var a=d.stream_type(),b=!1;d.room.myself()!==d&&(b=!1);0<=a.indexOf("video")?d.video_mute(null===d.video_mute()?!1:d.video_mute()):d.video_mute(null);0<=a.indexOf("audio")?d.audio_mute(null===d.audio_mute()?b:d.audio_mute()):d.audio_mute(null);0<=a.indexOf("screen")?d.screen_mute(null===
d.screen_mute()?!1:d.screen_mute()):d.screen_mute(null)})}E(g,[{key:"rotate",value:function(){var a=this;this.rotation(0>=arguments.length||void 0===arguments[0]||arguments[0]?this.rotation()-90:this.rotation()+90);360!=this.rotation()&&-360!=this.rotation()||this.rotation(0);q["default"].each(this.room.users(),function(b,c){c.msg("rotate",a.rotation())})}},{key:"startScreenShare",value:function(){var a=this;"joined"!=this.screen_status()&&this.room.ensureCallId(function(){a.room.chat&&a.room.chat.app&&
a.room.chat.app.uiCheckUiReload&&a.room.chat.app.uiCheckUiReload(function(c){c||(a.config().notSSL?alert("Screen sharing required https version of website."):g.RTC.getUserMediaStreams("screen",function(c,g,k){if(!c){a.stream({screen:g});a.screen_status("joined");var d={};a.screenCaller=new b.SyncUsersClass(a.room,function(b,c){d[b]&&"standby"===d[b]||a.startCallWith(c,!0,!1,"one_way")},function(b,c){d[b]=c.screen_status();a.stopCallWith(c,!0)},function(a,b){return!0},function(b){return"joined"==a.screen_status()&&
a.screenCaller===b})}},!1,null,a.room))},!0,!1,"webrtc")})}},{key:"startRTCCall",value:function(){var a=this,c=0>=arguments.length||void 0===arguments[0]?!0:arguments[0],d=1>=arguments.length||void 0===arguments[1]?null:arguments[1];c?tagoveApp&&tagoveApp.googleAnalyticscheck("Video call","click","Video Call by the visitor"):tagoveApp&&tagoveApp.googleAnalyticscheck("Phone call","click","Phone Call by the visitor");if("joined"!=this.status()){if(this.sholudWePickCall())return this.sholudWePickCall().cb(c?
"video":"audio");var h=[];q["default"].each(this.room.users(),function(a,b){"standby"!=b.status()&&h.push(b)});if(5<=h.length)return alert("Sorry you can't join this, there are already 5 people in the room, so you can just see the them but you can't share your webcam/voice.");null==d&&(d=this.callback_type());this.room.ensureCallId(function(){a.room.chat.app.uiCheckUiReload(function(k){if(!k){var h=function(){var c={};a.currentCaller=new b.SyncUsersClass(a.room,function(b,e){c[b]&&"standby"===c[b]||
a.startCallWith(e,!1,!1,d)},function(b,d){c[b]=d.status();a.stopCallWith(d,!1)},function(a,b){return!0},function(b){return"joined"==a.status()&&a.currentCaller===b})};a.config().webrtcSupported?g.RTC.getUserMediaStreams(c?"video":"audio",function(b,c,d){if(!b){a.stream({rtc:c});try{a.status("joined")}catch(n){console.error(n)}h()}}):(a.status("joined"),h())}},!0,!1,"webrtc")})}}},{key:"stopScreenCall",value:function(){var a=this,b=0>=arguments.length||void 0===arguments[0]?!0:arguments[0];this.screen_status("standby");
this.stream().screen&&(this.stream().screen.dispose(),this.stream({screen:null}));q["default"].each(this.room.users(),function(c,g){"standby"!==g.screen_status()&&a.stopCallWith(g,!0,b)});this.screenCaller=null;b&&this.room.refreshMyScreenStatus()}},{key:"stopRTCCall",value:function(){var a=this,b=0>=arguments.length||void 0===arguments[0]?!0:arguments[0];tagoveApp&&tagoveApp.googleAnalyticscheck("Call Stop","click","Call end by the visitor");b&&this.room.app.popup_mode_sections&&this.room.app.popup_mode_sections.remove("rtcroom");
this.status("standby");this.stream().rtc&&(this.stream().rtc.dispose(),this.stream({rtc:null}));this.stream().flash&&this.stream({flash:null});q["default"].each(this.room.users(),function(c,g){"standby"!==g.status()&&a.stopCallWith(g,!1,b)});this.currentCaller=null;b&&this.room.refreshMyRTCStatus()}},{key:"startCallWith",value:function(a){var b=1>=arguments.length||void 0===arguments[1]?!1:arguments[1],c=this,r=3>=arguments.length||void 0===arguments[3]?null:arguments[3];b&&"standby"==a.screen_status()&&
a.screen_status("incall");b||"standby"!=a.status()||a.status("incall");null==r&&(r=this.callback_type());var m=function(){var d=0>=arguments.length||void 0===arguments[0]?null:arguments[0],e=1>=arguments.length||void 0===arguments[1]?null:arguments[1],f=function(){var b=h["default"].getRandomSessionId(null,!1)+"";a.stream({flash:b});a.msg("offer",{callType:"flash",call:"@"+b,callback:"one_way",autoStatus:d,autoType:e},function(b){a.status("joined")})};if(!(b||c.config().webrtcSupported&&a.config().webrtcSupported))return f();
a.getConnection(b?"screenOut":"out",function(k,h){(function(k){h();var l="["+(b?"screenCall":"call")+"]["+a.user().name+"][R-0]";Date.now();g.RTC.handleIceCandidates(k,l,function(c){a.msg(b?"candidateScreenIn":"candidateIn",c)},function(a,b){},function(){});(function(){k.addStream(b?c.stream().screen:c.stream().rtc);k.createOffer(function(h){h=g.RTC.lineSettings(h);k.setLocalDescription(new RTCSessionDescription(h),function(){a.msg(b?"screen":"offer",{call:h,callback:r,callType:b?"screen":0<c.stream_type().indexOf("video")?
"video":"audio",autoStatus:d,autoType:e},function(d){"flash"==d?b||(f(),a.getConnection(b?"screenOut":"out",function(a){a&&a.dispose()},!1,!0)):"declined"==d?(alert("User don't want to have a call from you."),c.onMsg(a,"hangup",!1)):"string"==typeof d?(console.error(d),c.stopCallWith(a)):k.setRemoteDescription(new RTCSessionDescription(d),function(){},function(){console.error(arguments)})})},function(){console.error(arguments)})},function(){console.error(arguments)},{offerToReceiveAudio:!0,offerToReceiveVideo:!0})})()})(k)},
!0)},l=b?this.screenCaller:this.currentCaller,e="standby"!=(b?a.screen_status():a.status()),f=a.user().state,p=a.user.subscribe(function(){if(l===(b?c.screenCaller:c.currentCaller)){var d=a.user().state;d!=f&&("offline"!=d&&"online"==d&&e&&m(b?a.screen_status():a.status(),b?"screen":0<=a.stream_type().indexOf("video")?"video":"audio"),f=d)}else p.dispose()}),n=(b?a.screen_status:a.status).subscribe(function(){if(l===(b?c.screenCaller:c.currentCaller)){var d="standby"!=(b?a.screen_status():a.status());
e!==d&&(d&&m(b?a.screen_status():a.status(),b?"screen":0<=a.stream_type().indexOf("video")?"video":"audio"),e=d)}else n.dispose()});this.room.ensureCallId(m)}},{key:"stopCallWith",value:function(a){var b=1>=arguments.length||void 0===arguments[1]?!1:arguments[1],c=2>=arguments.length||void 0===arguments[2]?!0:arguments[2];b?a.screen_status("standby"):a.status("standby");a.stream().rtc&&!b&&a.stream().rtc.dispose();a.stream().screen&&b&&a.stream().screen.dispose();a.msg("hangup",b);try{a.getConnection(b?
"screenOut":"out",function(a){a&&a.dispose()},!1,!0),a.getConnection(b?"screenIn":"in",function(a){a&&a.dispose()},!1,!0)}catch(r){}c&&(b?this.room.refreshMyScreenStatus():this.room.refreshMyRTCStatus())}},{key:"pickUserRTC",value:function(a,b,c){var d=this,h=3>=arguments.length||void 0===arguments[3]?!1:arguments[3];if("flash"===b.callType||this.config().webrtcSupported||h){var k=function(){h||"standby"!=d.status()||d.status("incall");h&&"standby"==d.screen_status()&&d.screen_status("incall");d.room.chat.app.uiCheckUiReload(function(e){if(!e){var f=
"["+(h?"screenPick":"pick")+"]["+a.user().name+"][R-0]";h||"flash"!=b.callType?a.getConnection(h?"screenIn":"in",function(d,e){g.RTC.handleIceCandidates(d,f,function(b){a.msg(h?"candidateScreenOut":"candidateOut",b)},function(a){});d.setRemoteDescription(new RTCSessionDescription(b.call),function(){e();d.createAnswer(function(b){b=g.RTC.lineSettings(b);d.setLocalDescription(b,function(){c({type:"answer",sdp:b.sdp});h?a.screen_status("joined"):a.status("joined")},function(){console.error(arguments)})},
function(){console.error(arguments)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}})},function(){console.error(arguments)})},!0):(d.status("joined"),a.status("joined"),a.stream({flash:b.call}),c("flash"))}},!0,!1,"webrtc")};if(b.autoStatus){if("joined"==b.autoStatus){"video"==b.autoType?this.startRTCCall(!0,"one_way"):"audio"==b.autoType?this.startRTCCall(!1,"one_way"):"screen"==b.autoType&&this.startRTCCall(!1,"one_way");k();return}if("incall"==b.autoStatus){k();return}}this.room.ensureCallId(function(){d.room.chat.app.uiCheckUiReload(function(e){e||
(e=function(e){d.sholudWePickCall({typeText:"flash"==b.callType?"video":b.callType,type:b.callType,from:a.user().name,cb:function(a){d.sholudWePickCall(null);"declined"==a?(c("declined"),e(!1)):e(a)}})},h&&(b.callback="one_way"),h&&"joined"==d.screen_status()&&(b.callback="one_way"),h||"joined"!=d.status()||(b.callback="one_way"),"invite"==b.callback?(k(),e(function(a){!1!==a&&("video"==a?d.startRTCCall(!0,"one_way"):"audio"!=a&&"none"!=a||d.startRTCCall(!1,"one_way"))})):"required"==b.callback?e(function(a){!1!==
a?(k(),"video"==a?d.startRTCCall(!0,"one_way"):"audio"!=a&&"none"!=a||d.startRTCCall(!1,"one_way")):c("declined")}):"one_way"==b.callback&&k())},!0,!1,"webrtc")})}else c("flash")}},{key:"getConnection",value:function(a,b){var d=this,g=3>=arguments.length||void 0===arguments[3]?!1:arguments[3];if(!c["default"].webrtcSupported)return null;var h=this.connections[a];if(2>=arguments.length||void 0===arguments[2]?0:arguments[2]){h&&h[0]&&(h[0].dispose(),h=null);var k=new RTCPeerConnection(c["default"].PeerConnectionConfig,
c["default"].PeerConnectionOptions);k.onaddstream=function(b){b.stream.dispose=function(){console.log("DISPOSING Media streams..");try{b.stream.getTracks().length&&b.stream.getTracks()[0].stop&&b.stream.getTracks().forEach(function(a){a.stop()})}catch(f){}try{b.stream.stop()}catch(f){}if(b.stream.onended)b.stream.onended()};"out"!=a&&("screenIn"==a||"screenOut"==a?d.stream({screen:b.stream}):d.stream({rtc:b.stream}))};k.dispose=function(){try{delete d.connections[a],k.close()}catch(e){}};b(k,function(){var b=
d.connections[a];b&&b[1]&&0<b[1].length&&q["default"].each(b[1],function(a,b){b(k)});d.connections[a]=[k,[]]})}else{h||(h=[null,[]],this.connections[a]=h);if(g&&h&&!h[0])return b(null);h&&h[0]?b(h[0]):h[1]&&h[1].push(b)}}},{key:"remove",value:function(){}},{key:"msg",value:function(a,b){this.room.sendMessage(this,a,b,2>=arguments.length||void 0===arguments[2]?null:arguments[2])}},{key:"onMsg",value:function(a,b,c,g){"video_mute"!=b&&"audio_mute"!=b&&"screen_mute"!=b||!a._stream()||(a._stream()[b]=
c,a._stream.valueHasMutated());"rotate"==b&&(this.logger.log(c),a._stream()&&a.rotation(c));"rtc_full_screen"==b?c?this.room.chat.app.popup_mode_sections.push("rtcroom"):this.room.chat.app.popup_mode_sections.remove("rtcroom"):"screen_full_screen"==b?c?this.room.chat.app.popup_mode_sections.push("screen"):this.room.chat.app.popup_mode_sections.remove("screen"):"hangup"==b?(a.getConnection(c?"screenIn":"in",function(a){a&&a.dispose()},!1,!0),a.getConnection(c?"screenOut":"out",function(a){a&&a.dispose()},
!1,!0),c?(a.screenCaller=null,a.screen_status("standby"),this.room.refreshMyScreenStatus()):(a.currentCaller=null,a.status("standby"),this.room.refreshMyRTCStatus())):"my_config"==b?c[1]&&(b=from.config(),b[c[0]]=c[1],from.config(b),from.config.valueHasMutated()):"offer"==b?this.pickUserRTC(a,c,g,!1):"screen"==b?this.pickUserRTC(a,c,g,!0):"candidateIn"==b?(a.user(),c.candidate&&a.getConnection("in",function(a){a.addIceCandidate(new RTCIceCandidate(c))})):"candidateScreenIn"==b?c.candidate&&a.getConnection("screenIn",
function(a){a.addIceCandidate(new RTCIceCandidate(c))}):"candidateScreenOut"==b?c.candidate&&a.getConnection("screenOut",function(a){a.addIceCandidate(new RTCIceCandidate(c))}):"candidateOut"==b&&c.candidate&&a.getConnection("out",function(b){a.user();b.addIceCandidate(new RTCIceCandidate(c))})}}]);return g}();C["default"]=u;u.RTC=c["default"];B.exports=C["default"]}});
