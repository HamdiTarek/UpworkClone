(function(angular){"use strict";var module=angular.module("bpa-ui.constants",["components.core.psmetrics"]);var trafficRate=Applet.getVar("bpa_ui_psmetrics_traffic_rate");if("undefined"!==typeof trafficRate){module.constant("PSMETRICS_TRAFFIC_RATE",parseFloat(trafficRate))}module.constant("DISBURSEMENT_METHODS_URL_PART","disbursement-methods").constant("TAX_INFO_URL_PART","tax-info").constant("DEPOSIT_METHODS_URL_PART","deposit-methods").constant("ACCOUNTING_ENTITY_KEY","bpa_ui_accounting_entity_id")})(angular);
(function(angular){"use strict";angular.module("bpa-ui.controllers",[])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.controllers").controller("closablePopupController",["$scope","$modalInstance","_injectedProperties",function($scope,$modalInstance,_injectedProperties){$scope.injectedProperties=_injectedProperties;$scope.close=function(){$modalInstance.dismiss()}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.controllers").controller("depositMethodCtrl",["$scope","$location","$window","bpaUrl",function($scope,$location,$window,bpaUrl){var returnUrl=bpaUrl.getMainBillingMethodsPageUri();$scope.cancelUrl=returnUrl;$scope.showTemporaryCharge=false;$scope.callbackObject={success:function(data){if(!data||!data.id){return}if("1"===data.verify){$window.scroll(0,0);$scope.showTemporaryCharge=true}else{document.location=returnUrl}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.controllers").controller("disbursementMethodCtrl",["$scope","$location","$window","bpaUrl",function($scope,$location,$window,bpaUrl){var returnUrl=bpaUrl.getDisbursementMethodsPageUri();$scope.cancelUrl=returnUrl;$scope.showTemporaryCharge=false;$scope.callbackObject={success:function(data){if(!data||!data.id){return}document.location=data.return_to||returnUrl}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.controllers").controller("usUsCtrl",["$scope",function($scope){var returnUrl=Applet.getVar("find_work_home_uri")||"/";$scope.cancelUrl=returnUrl;$scope.showTemporaryCharge=false;$scope.callbackObject={success:function(){document.location=returnUrl}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.controllers").controller("yesNoModalController",["$scope","$modalInstance","_injectedProperties",function($scope,$modalInstance,_injectedProperties){$scope.injectedProperties=_injectedProperties;$scope.ok=function(){$modalInstance.close({success:true})};$scope.cancel=function(){$modalInstance.dismiss()}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories",["bpa-ui.constants"])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaAddBillingMethod",["eoModal","bpaUrl","$http","CreditCards","$templateCache","$document","bpaIovation","bpaSubscriptionEventLogger","DEPOSIT_METHODS_URL_PART",function(eoModal,bpaUrl,$http,CreditCards,$templateCache,$document,bpaIovation,bpaSubscriptionEventLogger,DEPOSIT_METHODS_URL_PART){var availableDataPromise,isModalHidden=false,productChargeAmount;return{show:function(config){isModalHidden=false;return _createModal(config).result},preFetchData:function(){getAvailableDataPromise();CreditCards.preFetchAddForm();preFetchImages()},getTemplateUrl:getTemplateUrl,getAvailableDataPromise:getAvailableDataPromise,isModalHidden:_isModalHidden,setModalHidden:_setModalHidden,setProductChargeAmount:_setProductChargeAmount,removeAddCardFormFromCache:removeAddCardFormFromCache};function _createModal(config){config=config||{};if(typeof config.forcePrimary==="undefined"){config.forcePrimary=1}return eoModal.custom({size:"sm",locals:{config:config},keyboard:false,backdrop:"static",controller:["$scope","$modalInstance","config",_modalController],templateUrl:bpaUrl.resourceUrl(DEPOSIT_METHODS_URL_PART+"/partials/add-billing-method-modal.html")})}function _modalController($scope,$modalInstance,config){$scope.config=config;$scope.addBillingInterface={};$scope.addBillingCallback={success:doSuccess,error:function(){$modalInstance.dismiss()}};$scope.close=function(){if(bpaSubscriptionEventLogger.getMopType()){bpaSubscriptionEventLogger.cancelSubscription()}$scope.addBillingInterface.getPaymentData(function(data){if(data){doSuccess(data)}else{$modalInstance.dismiss()}})};function doSuccess(data){$modalInstance.close({success:true,mopData:data})}}function _setProductChargeAmount(value){productChargeAmount=value}function getAvailableDataPromise(){if(!availableDataPromise){var getBalanceString=productChargeAmount?"?productChargeAmount="+productChargeAmount:"";availableDataPromise=$http.get(bpaUrl.baseUrl(true)+DEPOSIT_METHODS_URL_PART+"/available"+getBalanceString,{cache:true})}return availableDataPromise}function preFetchImages(){$http.get(getTemplateUrl(),{cache:$templateCache}).then(function(response){var node=$document[0].createElement("div");node.innerHTML=response.data;var imgNodes=node.querySelectorAll("img");for(var i=0,l=imgNodes.length;i<l;i++){(new Image).src=imgNodes[i].src}})}function getTemplateUrl(){return bpaUrl.resourceUrl(DEPOSIT_METHODS_URL_PART+"/partials/add-billing-method.html")}function _isModalHidden(){return isModalHidden}function _setModalHidden(value){isModalHidden=value}function removeAddCardFormFromCache(){CreditCards.removeAddFormFromCache()}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaAlert",["$timeout",function($timeout){var alertMessages=[],fatalErrorMessage=null;return{addAlertMessages:_addAlertMessages,addFatalErrorMessage:_addFatalErrorMessage,getAlertMessages:_getAlertMessages,setFatalErrorMessage:_setFatalErrorMessage,closeAlertMessage:_closeAlertMessage,clearMessages:_clearMessages};function _addAlertMessages(messages){$timeout(function(){if(messages&&messages.length>0){alertMessages=alertMessages.concat(messages)}})}function _getAlertMessages(aeRid){if(!aeRid){return alertMessages}var filteredMessages=[],message;for(var i=0,l=alertMessages.length;i<l;i++){message=alertMessages[i];if(message.aeRid==aeRid){filteredMessages.push(message)}}return filteredMessages}function _setFatalErrorMessage(message){fatalErrorMessage=message}function _addFatalErrorMessage(aeRid){alertMessages.push({aeRid:aeRid,type:"danger",message:fatalErrorMessage})}function _closeAlertMessage(index){alertMessages.splice(index,1)}function _clearMessages(aeRid){var filteredMessages=[],message;for(var i=0,l=alertMessages.length;i<l;i++){message=alertMessages[i];if(message.aeRid==aeRid){continue}filteredMessages.push(message)}alertMessages=filteredMessages}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaBankAccountEventLogger",["bpaEventLog",function(bpaEventLog){var flowName;var submitEventObj={sublocation:"add_bank_manual",data:{event_label:"save"}};return{submitSuccess:_submitSuccess,submitFailure:_submitFailure,backToPlaid:_backToPlaid,setFlowName:_setFlowName,logAbaValidationError:_logAbaValidationError};function _submitSuccess(){var eventObj=angular.merge({},submitEventObj,{data:{status:"success",status_message:[]}});_sendEvent(eventObj)}function _submitFailure(errors){var eventObj=angular.merge({},submitEventObj,{data:{status:"failure",status_message:errors}});_sendEvent(eventObj)}function _backToPlaid(){var eventObj=angular.merge({},submitEventObj,{data:{event_label:"back"}});_sendEvent(eventObj)}function _logAbaValidationError(routingNumber){var eventObj=angular.merge({},submitEventObj,{data:{event_label:"invalid routing - "+routingNumber}});_sendEvent(eventObj)}function _setFlowName(name){flowName=name}function _sendEvent(eventObject){var data=eventObject.data||{};if(flowName){data.flow=flowName}bpaEventLog.logEvent("click","add_upm",data,eventObject.sublocation)}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaCachedPostRequest",["$http","$q",function($http,$q){var _cache={};return{post:_post,invalidate:_invalidate};function _getCacheKey(requestConfig){if(typeof requestConfig=="string"){return requestConfig}if(typeof requestConfig=="object"&&requestConfig.hasOwnProperty("url")){var result=requestConfig.url;if(requestConfig.hasOwnProperty("data")){result+=JSON.stringify(requestConfig.data)}return result}return null}function _post(requestConfig){var cacheKey=_getCacheKey(requestConfig);return $q(function(resolve,reject){if(typeof _cache[cacheKey]!="undefined"){resolve(_cache[cacheKey])}else{return $http.post(requestConfig).then(function(response){_cache[cacheKey]=response;resolve(response)},function(response){reject(response)})}})}function _invalidate(requestConfig){var cacheKey=_getCacheKey(requestConfig);if(typeof _cache[cacheKey]!="undefined"){delete _cache[cacheKey]}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaCcEventLogger",["bpaEventLog",function(bpaEventLog){var flowName;var nextPageEventObj={sublocation:"add_card",data:{event_label:"continue"}};var submitEventObj={sublocation:"add_address",data:{event_label:"save"}};return{submitSuccess:submitSuccess,submitFailure:submitFailure,loadingFailure:loadingFailure,nextPageSuccess:nextPageSuccess,nextPageFailure:nextPageFailure,previousPage:previousPage,setFlowName:setFlowName};function submitSuccess(){var eventObj=angular.merge({},submitEventObj,{data:{status:"success",status_message:[]}});sendEvent(eventObj)}function submitFailure(errors){var eventObj=angular.merge({},submitEventObj,{data:{status:"failure",status_message:errors}});sendEvent(eventObj)}function loadingFailure(errors){bpaEventLog.logLoadingFailure("add_upm","add_card",flowName,errors?[errors]:[])}function nextPageSuccess(){var eventObj=angular.merge({},nextPageEventObj,{data:{status:"success",status_message:[]}});sendEvent(eventObj)}function nextPageFailure(errors){var eventObj=angular.merge({},nextPageEventObj,{data:{status:"failure",status_message:errors}});sendEvent(eventObj)}function previousPage(){sendEvent({sublocation:"add_address",data:{event_label:"back"}})}function setFlowName(name){flowName=name}function sendEvent(eventObject){var data=eventObject.data||{};if(flowName){data.flow=flowName}bpaEventLog.logEvent("click","add_upm",data,eventObject.sublocation)}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaClientSubscription",["$http",function($http){var url;return{subscribe:_subscribe,setUrl:_setUrl};function _setUrl(newUrl){url=newUrl}function _subscribe(planId){var date=(new Date).toISOString();return $http.post(url,{planId:planId,isInterstitialFlow:0,interstitialType:0,currentUri:null,referrerUri:null,pageDate:date,ajaxDate:date})}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaDepositMethods",["bpa","bpaAlert","bpaUrl","eoModal","$http","DEPOSIT_METHODS_URL_PART",function(bpa,bpaAlert,bpaUrl,eoModal,$http,DEPOSIT_METHODS_URL_PART){var screenLoading,depositTemplateUrl;return{setScreenLoading:setScreenLoading,isScreenLoading:isScreenLoading,getDepositTemplateUrl:getDepositTemplateUrl,depositMethodsReload:depositMethodsReload,processResponse:processResponse,processFatalErrorInResponse:processFatalErrorInResponse,setUpModal:setUpModal,setPrimaryMop:setPrimaryMop};function setScreenLoading(arg){screenLoading=arg}function isScreenLoading(){return screenLoading}function getDepositTemplateUrl(aeRid,reload){aeRid=aeRid||bpa.getAccountingEntityRid();if(!depositTemplateUrl||reload){depositTemplateUrl=generateDepositTemplateUrl(aeRid)}return depositTemplateUrl}function generateDepositTemplateUrl(aeRid){return aeRid+"/"+DEPOSIT_METHODS_URL_PART+"/list.html"}function processFatalErrorInResponse(aeRid){aeRid=aeRid||bpa.getAccountingEntityRid();bpaAlert.clearMessages(aeRid);bpaAlert.addFatalErrorMessage(aeRid);setScreenLoading(false)}function depositMethodsReload(aeRid){depositTemplateUrl=getDepositTemplateUrl(aeRid,true)+"?"+ +new Date}function processResponse(aeRid,data){if(data){if(data.messages&&data.messages.length>0){bpaAlert.clearMessages(aeRid);bpaAlert.addAlertMessages(data.messages)}if("undefined"===typeof data.status){processFatalErrorInResponse(aeRid)}else if(data.status){depositMethodsReload()}else{setScreenLoading(false)}}else{processFatalErrorInResponse(aeRid)}}function setUpModal(options,resultCallback){var modalInstance=eoModal.custom(options);modalInstance.opened.then(function(){setScreenLoading(false)});modalInstance.result.then(resultCallback,function(){});return modalInstance}function setPrimaryMop(accountId,mopRid){return $http.post(bpaUrl.depositMethodsBaseUrl(accountId)+"/"+mopRid+"/set-primary")}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaEventLog",["oLog","eoModelFactory",function(oLog,eoModelFactory){return{logEvent:logEvent,logLoadingFailure:logLoadingFailure};function logLoadingFailure(location,sublocation,flowName,errors){var data={event_label:"loading",status:"failure",status_message:errors,flow:flowName};logEvent("impression",location,data,sublocation)}function logEvent(eventName,location,data,sublocation){data=data||{};var context=Applet.getVar("bpa_ctx");data.device=context&&context.device_type?context.device_type:"undefined";data.flow=data.flow||"undefined";var eventObject={event:eventName,location:location,data:[data]};if(sublocation){eventObject.sublocation=sublocation}oLog.event(eoModelFactory.get("Event",eventObject))}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaGetBankInfo",["$http","$q","bpaUrl",function($http,$q,bpaUrl){var bankInfoCache={};return{get:_getBankInfo};function _getBankInfo(routingNumber){return $q(function(resolve,reject){if(typeof bankInfoCache[routingNumber]!="undefined"){resolve(bankInfoCache[routingNumber])}else{return $http.get(bpaUrl.baseUrl()+"bank-details/USA/"+routingNumber).then(function(response){if(response.data&&response.data.bank&&response.data.bank.name){bankInfoCache[routingNumber]=response.data.bank;resolve(response.data.bank)}else{reject({code:500,message:"Unexpected response"})}},function(response){reject({code:response.status,message:response.statusText})})}})}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaGtmEvents",["$window",function($window){var dataLayer=angular.isDefined($window.dataLayer)?$window.dataLayer:null,commonFields={event:"billingEvents",eventCategory:"Billing"};return{postSuccessEvent:_postSuccessEvent,postFailureEvent:_postFailureEvent,postCancelEvent:_postCancelEvent,postClickEvent:_postClickEvent};function post(eventData){if(dataLayer){dataLayer.push(angular.extend({},commonFields,eventData))}}function _postSuccessEvent(eventData){post(angular.extend({},{eventLabel:"Success"},eventData))}function _postFailureEvent(eventData){post(angular.extend({},{eventLabel:"Fail"},eventData))}function _postCancelEvent(eventData){post(angular.extend({},{eventLabel:"Cancel"},eventData))}function _postClickEvent(eventLabel,newName){if(eventLabel){post({eventAction:newName&&newName==1?"Click":"click",eventLabel:eventLabel})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaIovation",["$timeout","$http","ExternalScripts","bpaUrl",function($timeout,$http,ExternalScripts,bpaUrl){init();return{getBlackBox:_getBlackBox,updateScope:_setBlackBoxToScope,setBlackBox:_setBlackBox};function init(){if("undefined"!==typeof ioGetBlackbox){return}$http.get(bpaUrl.resourceUrl("iovation/config"),{cache:true}).success(function(data){ExternalScripts.download(data.jsUrl)})}function _setBlackBoxToScope($scope,callback){_setBlackBox($scope.bpaFormData,callback)}function _setBlackBox(obj,callback){_getBlackBox(function(blackbox){obj.iovationBlackBox=blackbox;callback()})}function _getBlackBox(callback){var tryCount=5;if("undefined"===typeof ioGetBlackbox){callback("")}else{checkAndSet()}function checkAndSet(){var blackboxObject=ioGetBlackbox();if(blackboxObject&&blackboxObject.finished&&blackboxObject.blackbox){callback(blackboxObject.blackbox);return}if(--tryCount){$timeout(checkAndSet,2e3)}else{callback("")}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaNetworkErrors",[function(){var urlsWithError={};return{setErrorForUrl:_setErrorForUrl,getErrorForUrl:_getErrorForUrl};function _setErrorForUrl(url,responseCode,responseData){urlsWithError[url]={code:responseCode,data:responseData}}function _getErrorForUrl(url){return urlsWithError[url]}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaPlaidEventLogger",["bpaEventLog",function(bpaEventLog){var flowName;var submitEventObj={sublocation:"add_bank_instant",data:{event_label:"save"}};var wayEventObj={sublocation:"add_bank"};var plaidStatusEventObj={sublocation:"add_bank_instant",data:{event_label:"instantbankstatus"}};return{submitSuccess:submitSuccess,submitFailure:submitFailure,setFlowName:setFlowName,addViaPlaid:addViaPlaid,addViaManual:addViaManual,loadingFailure:loadingFailure,receivePlaidDepositoriesSuccess:receivePlaidDepositoriesSuccess,receivePlaidDepositoriesFailure:receivePlaidDepositoriesFailure};function submitSuccess(){var eventObj=angular.merge({},submitEventObj,{data:{status:"success",status_message:[]}});sendEvent(eventObj)}function submitFailure(errors){var eventObj=angular.merge({},submitEventObj,{data:{status:"failure",status_message:errors}});sendEvent(eventObj)}function loadingFailure(errors){bpaEventLog.logLoadingFailure("add_upm","add_bank_instant",flowName,errors?[errors]:[])}function receivePlaidDepositoriesSuccess(nonZeroCount,zeroCount,negativeBalanceCount){var eventObj=angular.merge({},plaidStatusEventObj,{data:{status:"success with"+"("+nonZeroCount+","+zeroCount+","+negativeBalanceCount+") of accounts"}});sendEvent(eventObj,"impression")}function receivePlaidDepositoriesFailure(errors){var eventObj=angular.merge({},plaidStatusEventObj,{data:{status:"failure",status_message:errors}});sendEvent(eventObj,"impression")}function addViaPlaid(){addWay("Instant")}function addViaManual(){addWay("Manual")}function addWay(verifyType){var eventObj=angular.merge({},wayEventObj,{data:{verify_type:verifyType}});sendEvent(eventObj)}function setFlowName(name){flowName=name}function sendEvent(eventObject,eventType){var data=eventObject.data||{};if(flowName){data.flow=flowName}bpaEventLog.logEvent(eventType?eventType:"click","add_upm",data,eventObject.sublocation)}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("plaid",["bpaVars","bpaUrl","bpaAddBillingMethod","eoModal","eoAuthHelper","$http","$filter","$timeout","$document","bpaPlaidEventLogger","ExternalScripts","DEPOSIT_METHODS_URL_PART",function(bpaVars,bpaUrl,bpaAddBillingMethod,eoModal,eoAuthHelper,$http,$filter,$timeout,$document,bpaPlaidEventLogger,ExternalScripts,DEPOSIT_METHODS_URL_PART){var accounts,accessTokenEncrypted,bankAccounts,hasNetworkError,modalInstance,isPlaidModalHidden,isAddPlaidFormActive,modalParams,formBlocked,isPlaidAccountsEmpty,plaidHandler,isPlaidLoaded=false,plaidScriptLoaded=false;return{receivePlaidDepositories:_receivePlaidDepositories,hasNetworkError:_hasNetworkError,getAccessTokenEncrypted:_getAccessTokenEncrypted,getAccounts:_getAccounts,getBankAccounts:_getBankAccounts,getModal:_getModal,closeModal:_closeModal,setPlaidModalHidden:_setPlaidModalHidden,setAddPlaidFormActive:_setAddPlaidFormActive,setFormBlocked:_setFormBlocked,isPlaidAccountsEmpty:_isPlaidAccountsEmpty,isPlaidLoaded:_isPlaidLoaded,getPlaidHandler:_getPlaidHandler,initPlaid:_initPlaid};function _init(){accounts=[];accessTokenEncrypted=null;bankAccounts="";hasNetworkError=false;modalInstance=null;isPlaidModalHidden=false;isAddPlaidFormActive=false;modalParams=null;formBlocked=false;isPlaidAccountsEmpty=false}function _receivePlaidDepositories(token){var headers=eoAuthHelper.addAuthHelpHeader({});$http.post(bpaUrl.baseUrl(true)+"plaid-depositories",{publicToken:token},{headers:headers}).success(function(data){if(!data.accounts||data.accounts.length===0){_closeModal();isPlaidAccountsEmpty=true;_logFailureEvent()}else{_setFormBlocked(false);accounts=_sortPlaidAccounts(data.accounts);_setBankAccountString(accounts);accessTokenEncrypted=data.accessTokenEncrypted;_logSuccessEvent()}}).error(function(err){_closeModal();hasNetworkError=true;_logFailureEvent()})}function _logFailureEvent(){$timeout(function(){var errors=[];var messages=$document[0].querySelectorAll(".add-plaid-bank-account-errors:not(.ng-hide)");for(var i=0;i<messages.length;i++){errors.push(messages[i].innerText)}bpaPlaidEventLogger.receivePlaidDepositoriesFailure(errors)},1e3)}function _logSuccessEvent(){var nonZeroCount=$filter("filter")(accounts,function(value){return value.balances.available>0}).length;var zeroCount=$filter("filter")(accounts,function(value){return value.balances.available==0}).length;var negativeBalanceCount=accounts.length-nonZeroCount-zeroCount;bpaPlaidEventLogger.receivePlaidDepositoriesSuccess(nonZeroCount,zeroCount,negativeBalanceCount)}function _hasNetworkError(){return hasNetworkError}function _getAccessTokenEncrypted(){return accessTokenEncrypted}function _getAccounts(){return accounts}function _getBankAccounts(){return bankAccounts}function _sortPlaidAccounts(accountsArray){return $filter("orderBy")(accountsArray,"1 * balances.available",true)}function _setBankAccountString(accounts){angular.forEach(accounts,function(value,key){bankAccounts+=value.name+(accounts.length-1!=key?", ":"")})}function _getModal(config,params){_init();modalInstance=_createModal(config,modalParams);modalParams=params;return modalInstance}function _closeModal(){modalInstance.close();bpaAddBillingMethod.setModalHidden(false)}function _createModal(config){return eoModal.custom({size:"sm",locals:{config:config||{}},keyboard:false,backdrop:"static",controller:["$scope","config",_modalController],templateUrl:bpaUrl.resourceUrl(DEPOSIT_METHODS_URL_PART+"/partials/add-billing-method-plaid-modal.html")})}function _modalController($scope,config){$scope.config=config;$scope.isPlaidModalHidden=function(){return isPlaidModalHidden};$scope.isAddPlaidFormActive=function(){return isAddPlaidFormActive};$scope.close=function(){_closeModal()};$scope.isBlocked=function(){return formBlocked};$scope.accountTypes=modalParams.accountTypes;$scope.bpaCommObject=modalParams.bpaCommObject;$scope.callbackObject=modalParams.callbackObject}function _setPlaidModalHidden(value){isPlaidModalHidden=value}function _setAddPlaidFormActive(value){isAddPlaidFormActive=value}function _setFormBlocked(value){formBlocked=value}function _isPlaidAccountsEmpty(){return isPlaidAccountsEmpty}function _isPlaidLoaded(){return isPlaidLoaded}function _getPlaidHandler(){return plaidHandler}function handleLoadingFailure(message,callback){if(callback){callback(message)}bpaPlaidEventLogger.loadingFailure(message)}function _initPlaid(failureCallback){if(!plaidScriptLoaded){$http.get(bpaUrl.resourceUrl("plaid/config"),{cache:true}).success(function(data){if(!data||!data.key){handleLoadingFailure("Plaid configuration response is invalid",failureCallback)}else{ExternalScripts.download(data.script_url,{onload:function(){if(angular.isDefined(Plaid)&&"function"===typeof Plaid.create){plaidScriptLoaded=true;_plaidCreate({clientName:data.client_name,env:data.env,key:data.key,product:["auth"],selectAccount:false})}else{handleLoadingFailure("Plaid API failed to load",failureCallback)}},onerror:function(){handleLoadingFailure("External scripts loading error",failureCallback)}})}}).error(function(){handleLoadingFailure("Plaid configuration loading error",failureCallback)})}}function _plaidCreate(config){plaidHandler=Plaid.create(angular.merge(config,{onLoad:function(){isPlaidLoaded=true},onSuccess:function(token){_receivePlaidDepositories(token);_setFormBlocked(true);_setAddPlaidFormActive(true);_setPlaidModalHidden(false)},onExit:function(error){_closeModal();if(error&&error.code){hasNetworkError=true}}}))}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaSubscriptionEventLogger",["bpaEventLog",function(bpaEventLog){var flowName;var mopType;var submitEventObj={event_label:"planselected"};return{submitSuccess:_submitSuccess,submitFailure:_submitFailure,cancelSubscription:_cancelSubscription,learnmoreSubscription:_learnmoreSubscription,getMopType:_getMopType,setFlowName:_setFlowName,setMopType:_setMopType};function _submitSuccess(){var eventObj=angular.merge({},submitEventObj,{status:"success",status_message:[]});_sendEvent(eventObj)}function _submitFailure(errors){var eventObj=angular.merge({},submitEventObj,{status:"failure",status_message:errors});_sendEvent(eventObj)}function _cancelSubscription(){_sendEvent({event_label:"cancel"})}function _learnmoreSubscription(){_sendEvent({event_label:"learnmore"})}function _getMopType(){return mopType}function _setFlowName(name){flowName=name}function _setMopType(type){mopType=type}function _sendEvent(data){if(flowName){data.flow=flowName}if(mopType){data.upm=mopType}bpaEventLog.logEvent("click","add_upm",data)}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaVat",["$http","bpaUrl","TAX_INFO_URL_PART",function($http,bpaUrl,TAX_INFO_URL_PART){var _flashMessagesEnabled=false;return{enableFlashMessages:_enableFlashMessages,save:_saveVatInfo,skip:_skipVatInfo,remove:_removeVatInfo};function _enableFlashMessages(){_flashMessagesEnabled=true}function _postRequest(postData){if(_flashMessagesEnabled){postData["flashMessagesEnabled"]=true}return $http.post(bpaUrl.baseUrl()+TAX_INFO_URL_PART+"/submit-vat",{vat_info:postData})}function _saveVatInfo(vatNumber){return _postRequest({vatId:vatNumber})}function _skipVatInfo(){return _postRequest({vatSkipped:true})}function _removeVatInfo(){return $http.post(bpaUrl.baseUrl()+TAX_INFO_URL_PART+"/remove-vat",{})}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaVerifyModal",["eoModal","bpaUrl","$q","$http","bpaNetworkErrors",function(eoModal,bpaUrl,$q,$http,bpaNetworkErrors){var errorTemplate='<div class="modal-body">{{ errorMessage }}</div>'+'<div class="modal-footer">'+'<button class="btn btn-primary" ng-click="cancel()">OK</button>'+"</div>",template='<div data-eo-block="{{!modalReady}}" ng-hide="modalReady" class="p-xlg-top-bottom">&nbsp;</div>'+'<div ng-include="modalUrl" onload="modalContentLoaded()" ng-show="modalReady"></div>'+'<div ng-show="errorMessage">'+errorTemplate+"</div>";return{show:_show};function _show(callbacks){return eoModal.custom({locals:{_callbacks:callbacks},keyboard:false,backdrop:"static",controller:["$scope","$window","$modalInstance","$timeout","_callbacks",_modalController],template:template})}function _modalController($scope,$window,$modalInstance,$timeout,callbacks){var refreshAnchor=Date.now(),modalUrl=bpaUrl.formUrl("verify-payment/partial/modal");setModalUrl();$scope.screenToShow="choose";$scope.addPaymentInterface={};$scope.isCurrentScreen=function(screen){return screen===$scope.screenToShow};$scope.addPaymentCallback={success:_addPaymentSuccess,beforeSubmit:_beforeSubmit,networkError:_networkError};$scope.verifyCallback={success:_verifySuccess,networkError:_networkError};$scope.returnUrl=getUrlFromInterface("getReturnUrl");$scope.cancelUrl=getUrlFromInterface("getCancelUrl");$scope.errorUrl=getUrlFromInterface("getErrorUrl");$scope.modalNotice=function(){if(callbacks&&callbacks.getNoticeTemplate){return callbacks.getNoticeTemplate()}return"bpaVerifyModalNotice.html"};$scope.cancel=function(){if(callbacks&&callbacks.cancel){callbacks.cancel($modalInstance)}else{$modalInstance.dismiss()}};$scope.showVerify=function(){$scope.screenToShow="verify";rePosition()};$scope.showChoose=function(){if($scope.mopRid){setModalUrl(true);$scope.mopRid=null}$scope.screenToShow="choose";rePosition()};$scope.isBlocked=function(){if($scope.$$childTail&&$scope.$$childTail.verifyInterface&&$scope.$$childTail.verifyInterface.isBlocked){return $scope.$$childTail.verifyInterface.isBlocked()}return false};$scope.modalContentLoaded=function(){var networkError=bpaNetworkErrors.getErrorForUrl($scope.modalUrl);if(networkError){if(networkError.data&&networkError.data.errorMessage){$scope.errorMessage=networkError.data.errorMessage}else{_networkError(networkError.code);return}}$scope.modalReady=true;rePosition()};function _beforeSubmit(submit){if(callbacks&&callbacks.beforePaymentSubmit){callbacks.beforePaymentSubmit(submit,$scope.addPaymentInterface)}else{submit()}}function _addPaymentSuccess(responseData){if("1"===responseData.verify){$scope.mopRid=responseData.id;$scope.showVerify()}else{_verifySuccess()}}function _verifySuccess(){if(callbacks&&callbacks.success){callbacks.success()}$modalInstance.close()}function _networkError(code){if(callbacks&&callbacks.networkError){callbacks.networkError(code)}}function getUrlFromInterface(functionName){if(callbacks&&callbacks[functionName]){return callbacks[functionName]()}return $window.location.href}function setModalUrl(refresh){if(refresh){refreshAnchor=Date.now()}$scope.modalReady=false;$scope.modalUrl=modalUrl+"?"+refreshAnchor}function rePosition(){$timeout(function(){angular.element($window).triggerHandler("resize")})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpaVerifyMopEventLogger",["bpaEventLog",function(bpaEventLog){var flowName;return{submitSuccess:_submitSuccess,submitFailure:_submitFailure,setFlowName:_setFlowName};function _submitSuccess(){_sendEvent("success")}function _submitFailure(errors){_sendEvent("failure",errors)}function _setFlowName(name){flowName=name}function _sendEvent(status,statusMessage){var data={event_label:"verify",status:status,status_message:statusMessage||[]};if(flowName){data.flow=flowName}bpaEventLog.logEvent("click","add_upm",data,"verify_card")}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("bpa",["$q","$http","bpaUrl","bpaVars","ACCOUNTING_ENTITY_KEY",function($q,$http,bpaUrl,bpaVars,ACCOUNTING_ENTITY_KEY){var paymentDataCache={};return{setAccountingEntityRid:setAccountingEntityRid,getAccountingEntityRid:getAccountingEntityRid,checkMethodOfPayment:checkMethodOfPayment,getMethodOfPaymentInfo:getMethodOfPaymentInfo,setMethodOfPaymentInfo:setMethodOfPaymentInfo,NOT_EXISTS:_notExistsCheckRule,IS_CC:_isCreditCardCheckRule,IS_ACH:_isAchCheckRule,VERIFIED:_isVerifiedCheckRule,WAIT_VERIFICATION:_isWaitForVerificationCheckRule};function setAccountingEntityRid(aeRid){bpaVars.set(ACCOUNTING_ENTITY_KEY,aeRid)}function getAccountingEntityRid(){return bpaVars.get(ACCOUNTING_ENTITY_KEY)}function checkMethodOfPayment(rules,mopRid){var deferred=$q.defer();getMethodOfPaymentInfo(mopRid,function(data){var ruleName=checkMopRules(rules,data);if(ruleName){deferred.resolve(ruleName)}else{deferred.reject("no_match")}},function(reason){deferred.reject(reason)});return deferred.promise}function getMethodOfPaymentInfo(mopRid,onSuccessCallback,onErrorCallback){if(paymentDataCache[mopRid]){processPaymentData(paymentDataCache[mopRid],onSuccessCallback);return}var url=bpaUrl.baseUrl(true)+"mop-info";if(mopRid){url+="/"+mopRid}$http.get(url).then(function(response){processPaymentData(response.data,onSuccessCallback)},function(response){if(onErrorCallback){onErrorCallback(401===response.status||403===response.status?"access_denied":"network_error")}})}function processPaymentData(data,callback){if(data){data.verification_status=data.verification;data.billing_address=data.billing_address||{}}callback(data)}function setMethodOfPaymentInfo(data){paymentDataCache[data.id]=data}function checkMopRules(rules,data){var ruleName="",rule,name;for(name in rules){rule=rules[name];if(!Array.isArray(rule)){continue}if(!rule.length){continue}if(checkMopRule(rule,data)){ruleName=name;break}}return ruleName}function checkMopRule(rule,data){for(var i=0,l=rule.length;i<l;i++){if("function"!==typeof rule[i]){return false}if(!rule[i](data)){return false}}return true}function _isVerifiedCheckRule(data){return"verified"===data.verification_status&&data.is_active}function _isWaitForVerificationCheckRule(data){return"in_progress"===data.verification_status}function _isCreditCardCheckRule(data){return"CC"===data.type}function _isAchCheckRule(data){return"ACH_DEPOSIT"===data.type}function _notExistsCheckRule(data){return"undefined"===typeof data.type}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("cookieManager",["$cookies",function($cookies){return{put:_put};function _put(key,value,params){params=params?params:{};var options={};options.path=params.path?params.path:"/";options.domain=params.domain?params.domain:Applet.getVar("cookie_domain");options.secure=params.secure?params.secure:Applet.getVar("cookie_secure");if(params.expires){options.expires=params.expires}$cookies.put((Applet.getVar("cookie_prefix")||"")+key,value,options)}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.factories").factory("ExternalScripts",["$document",function($document){var readyStatus=1,errorStatus=2,initStatus=3,downloadStatus={},callbacksQueue={},statuses={},errorCallbacks={},readyCallbacks={};return{download:_download,setReady:_setReady,setError:_setError,addReadyCallback:_addReadyCallback,addErrorCallback:_addErrorCallback,isGroupReady:_isGroupReady};function _download(src,callbacks,attrs){callbacks=callbacks||{};if(callbacksQueue[src]){callbacksQueue[src].push(callbacks)}else{callbacksQueue[src]=[callbacks]}var status=downloadStatus[src];if("undefined"!==typeof status){if(initStatus!==status){_runCallback(src,downloadStatus[src])}return}downloadStatus[src]=initStatus;var scriptNode=$document[0].createElement("script");scriptNode.onload=function(){_runCallback(src,readyStatus)};scriptNode.onerror=function(){_runCallback(src,errorStatus)};scriptNode.setAttribute("src",src);for(var attr in attrs){scriptNode.setAttribute(attr,attrs[attr])}$document[0].head.appendChild(scriptNode)}function _runCallback(src,status){var callbackName=readyStatus===status?"onload":"onerror",callbacks=callbacksQueue[src];downloadStatus[src]=status;for(var i=0,l=callbacks.length;i<l;i++){if(callbacks[i][callbackName]){callbacks[i][callbackName]()}}callbacksQueue[src]=[]}function _setReady(name){_setStatus(name,readyStatus,readyCallbacks)}function _setError(name){_setStatus(name,errorStatus,errorCallbacks)}function _setStatus(name,status,callbacks){statuses[name]=status;var callbacksArray=callbacks[name]||[];for(var i=0,l=callbacksArray.length;i<l;i++){callbacksArray[i]()}}function _addReadyCallback(name,callback){_setCallback(name,readyStatus,readyCallbacks,callback)}function _addErrorCallback(name,callback){_setCallback(name,errorStatus,errorCallbacks,callback)}function _isGroupReady(name){return"undefined"!==typeof statuses[name]}function _setCallback(name,status,callbacks,callback){if(statuses[name]===status){callback()}else{var callbacksArray=callbacks[name]||[];callbacksArray.push(callback);callbacks[name]=callbacksArray}}}]).factory("CreditCards",["ExternalScripts","bpaVars","bpaUrl","$templateCache","$http","$document",function(ExternalScripts,bpaVars,bpaUrl,$templateCache,$http,$document){var ccLib,currentCard=null,startTime=Date.now(),changeCallbacks=[],cards=[{type:"visa",pattern:/^4/,length:[13,14,15,16],cvcLength:[3],currenciesAllowed:true,validate:validateCard},{type:"mastercard",pattern:/^5[1-5]/,binrange:[[2221,2720]],length:[16],cvcLength:[3],currenciesAllowed:true,validate:validateCard},{type:"amex",pattern:/^3[47]/,length:[15],cvcLength:[3,4],currenciesAllowed:true,validate:validateCard},{type:"discover",pattern:/^(6011|64|65)/,length:[16,17,18,19],cvcLength:[3],currenciesAllowed:false,validate:function(number){return this.isEnabled()&&validateCard.call(this,number)},isEnabled:function(){return bpaVars.get("discoverCardsEnabled")==="1"}}];return{init:_init,tokenize:_tokenize,getValidationStatus:_getValidationStatus,getCvvLength:_getCvvLength,addChangeCallback:_addChangeCallback,isReady:_isReady,updateNumber:_updateNumber,getAddFormUrl:_getAddFormUrl,preFetchAddForm:_preFetchAddForm,removeAddFormFromCache:_removeAddFormFromCache,getServicesState:_getServicesState,getAvailableCreditCards:getAvailableCreditCards,getCurrentCard:getCurrentCard};function getAvailableCreditCards(){return cards.filter(function(card){return typeof card.isEnabled!=="function"||card.isEnabled()}).map(function(card){return card.type})}function validateCard(number){if(this.pattern.test(number)){return true}if(this.binrange){for(var i=0,l=this.binrange.length;i<l;i++){var start=this.binrange[i][0],end=this.binrange[i][1],binLength=Math.max(start.toString().length,end.toString().length),bin=number.substr(0,binLength)*1;if(start<=bin&&end>=bin){return true}}}return false}function _init(ccInputId){ExternalScripts.addReadyCallback("add-credit-card",function(){ccLib=new CreditCardLib(ccInputId,getAvailableCreditCards());for(var i=0,l=changeCallbacks.length;i<l;i++){ccLib.addChangeCallback(changeCallbacks[i])}changeCallbacks=[]})}function _addChangeCallback(callback){if(_isMesInitialized()){ccLib.addChangeCallback(callback)}else{changeCallbacks.push(callback)}}function _tokenize(data,callback){_checkLibAvailable();var retTokens={};_adyenTokenize(retTokens,data,function(retTokens,error){if(!_isMesInitialized()||currentCard!==null&&currentCard.type==="discover"){callback(retTokens,error);return}ccLib.tokenize(data.expirationMonth,data.expirationYear,function(token,error){if(!token){callback(retTokens,error);return}retTokens.mes=token;callback(retTokens,error)})})}function _getServicesState(){return{mes:{enabled:_isMesEnabled(),initialized:_isMesInitialized()},adyen:_getAdyenState()}}function _getAdyenState(){var state={present:"undefined"!==typeof adyen};if(state.present){state.cse_available="undefined"!==typeof adyen.cse&&adyen.cse.available;state.has_function="function"===typeof adyen.createEncryption}state.initialized=state.present&&state.cse_available&&state.has_function;return state}function _isAdyenInitialized(){return _getAdyenState().initialized}function _isMesInitialized(){return"undefined"!==typeof ccLib}function _isMesEnabled(){return bpaVars.get("mesEnabled")==="1"}function _adyenTokenize(retTokens,data,callback){var expiryYear=data.expirationYear;if(expiryYear.length===2){var curYear=(new Date).getFullYear().toString();expiryYear=curYear.substr(0,2)+expiryYear}var serverTime=new Date(Date.now()-startTime+Date.parse(bpaVars.get("formGenerationDate"))),cseInstance=adyen.createEncryption({}),cardData={number:data.ccNumber.replace(/\D/g,""),cvc:data.cvv2.replace(/\D/g,""),holderName:data.firstName+" "+data.lastName,expiryMonth:data.expirationMonth,expiryYear:expiryYear,generationtime:serverTime.toISOString()},token=null,error=null;try{token=cseInstance.encrypt(cardData);if(token){retTokens.adyen=token}else{error="Adyen encryption failed"}}catch(e){error=e.message||e}callback(retTokens,error)}function _getValidationStatus(){return _isMesInitialized()?ccLib.getValidationStatus():{}}function _getCvvLength(){if(_isAdyenInitialized()){var card=getCurrentCard();return card?card.cvcLength:null}else if(_isMesInitialized()){return ccLib.getCvvLength()}else{return null}}function _isReady(){return _isAdyenInitialized()&&(_isMesInitialized()||!_isMesEnabled())}function _checkLibAvailable(){if(!_isReady()){throw"Init must be called first"}}function getCurrentCard(){return currentCard}function _updateNumber(num){var len=cards.length,i,card;num=(num+"").replace(/\D/g,"");currentCard=null;for(i=0;i<len;i++){card=cards[i];if(card.validate(num)){currentCard=card;break}}return currentCard}function _preFetchAddForm(){var isModern=true,templateName=bpaUrl.getTemplateCacheName(getAddFormTemplateName(isModern));if(!bpaUrl.isTemplateExists(templateName)){$http.get(_getAddFormUrl(isModern)).then(function(response){$templateCache.put(templateName,response.data);preFetchExternalScripts(response.data)})}}function preFetchExternalScripts(formHtmlData){var node=$document[0].createElement("div");node.innerHTML=formHtmlData;var scriptGroupNode=node.querySelector("bpa-external-scripts-group"),scriptNodes=scriptGroupNode.querySelectorAll("bpa-external-script"),scriptGroupName=scriptGroupNode.getAttribute("name"),scriptsCount=scriptNodes.length;for(var i=0,l=scriptsCount;i<l;i++){ExternalScripts.download(scriptNodes[i].getAttribute("src"),{onload:function(){scriptsCount--;if(0===scriptsCount){ExternalScripts.setReady(scriptGroupName)}},onerror:function(){ExternalScripts.setError(scriptGroupName)}})}}function _getAddFormUrl(isModern){return bpaUrl.formUrl(getAddFormTemplateName(isModern))}function getAddFormTemplateName(isModern){return(isModern?"modern-":"")+"add-credit-card"}function _removeAddFormFromCache(){var isModern=true,templateName=bpaUrl.getTemplateCacheName(getAddFormTemplateName(isModern));$templateCache.remove(templateName)}}]).factory("bpaVars",function(){var data={};return{get:_get,set:_set};function _get(key){return data[key]||Applet.getVar(key)}function _set(key,value){data[key]=value}}).factory("bpaUrl",["$location","$document","$templateCache","bpaVars","ACCOUNTING_ENTITY_KEY","DISBURSEMENT_METHODS_URL_PART","DEPOSIT_METHODS_URL_PART",function($location,$document,$templateCache,bpaVars,ACCOUNTING_ENTITY_KEY,DISBURSEMENT_METHODS_URL_PART,DEPOSIT_METHODS_URL_PART){return{urlSetAe:_urlSetAe,formUrl:_formUrl,baseUrl:_baseUrl,resourceUrl:_resourceUrl,absoluteUrl:_absoluteUrl,isTemplateExists:_isTemplateExists,getTemplateCacheName:_getTemplateCacheName,getMainBillingMethodsPageUri:_getMainBillingMethodsPageUri,getDisbursementMethodsPageUri:_getDisbursementMethodsPageUri,disbursementMethodsActionUrl:_disbursementMethodsActionUrl,depositMethodsBaseUrl:_depositMethodsBaseUrl};function _urlSetAe(url){var aeRid=_getAeRid();return url.replace("/00000/",aeRid?"/"+aeRid+"/":"/")}function _formUrl(formName){formName=_getTemplateCacheName(formName);return _isTemplateExists(formName)?formName:_baseUrl(true)+formName}function _getTemplateCacheName(formName){return formName+".html"}function _resourceUrl(resource,params,useAeRid){if(angular.isArray(resource)&&resource.length>1){if(_isTemplateExists(resource[1])){return resource[1]}else{resource=resource[0]}}resource=resource.replace(/^\/+/,"");return _baseUrl(useAeRid)+resource+_buildQueryString(params,true)}function _baseUrl(useAeRid){var aeRid=_getAeRid(),url=_getJsVar("bpa_ui_base_url")+"/";if(useAeRid&&aeRid){url+=aeRid+"/"}return url}function _getAeRid(){return bpaVars.get(ACCOUNTING_ENTITY_KEY)}function _getMainBillingMethodsPageUri(){return _getJsVar("bpa_ui_billing_methods_uri")}function _getDisbursementMethodsPageUri(){return _getJsVar("bpa_ui_disbursement_methods_uri")}function _isTemplateExists(templateId){var node=$document[0].getElementById(templateId);return node&&"text/ng-template"===node.getAttribute("type")&&"script"===node.nodeName.toLowerCase()||!!$templateCache.get(templateId)}function _getJsVar(varName){var res=Applet.getVar(varName);if(!res){throw new Error("Please check app config, "+varName+" not defined in js_vars")}return res}function _buildQueryString(params,usePrefix){var prefix=!!usePrefix?"?":"";var parts=[];params=params||{};for(var key in params){if(params.hasOwnProperty(key)){parts.push(encodeURIComponent(key)+"="+encodeURIComponent(params[key]))}}return parts.length>0?prefix+parts.join("&"):""}function _absoluteUrl(url){if(url.length&&"/"!==url[0]){return url}var absolutePart=$location.protocol()+"://"+location.host;url=url.replace(/^\/+/,"/");return absolutePart+url}function _disbursementMethodsActionUrl(aeRid,action,stripBase){return(stripBase?"/":_baseUrl(false))+(aeRid?aeRid+"/":"")+DISBURSEMENT_METHODS_URL_PART+(action?"/"+action:"")}function _depositMethodsBaseUrl(accountId,relative){return(relative?"/":_baseUrl(false))+(accountId?accountId:"")+"/"+DEPOSIT_METHODS_URL_PART}}]).factory("bpaFormMode",[function(){var _stubMode=document.querySelectorAll(".js-bpa-mode-switcher.js-mode-stub");_stubMode=!!(_stubMode&&_stubMode.length);return{isStub:_stubMode,isNormal:!_stubMode}}]).factory("bpaBlockMode",[function(){return{lockSubmit:1,lockScreen:2,preventLeave:4,lockAll:7}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives",["bpa-ui.factories","ngCookies","components.core.select","components.core.templates"]).directive("appVersion",["version",function(version){return function(scope,element,attrs){element.text(version)}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("addBillingMethod",["bpaAddBillingMethod","bpaAlert","bpaUrl","bpaVars","bpa","plaid","bpaEventLog","bpaPlaidEventLogger","bpaSubscriptionEventLogger","bpaBankAccountEventLogger","$http","$timeout","$templateCache","$document","ACCOUNTING_ENTITY_KEY",function(bpaAddBillingMethod,bpaAlert,bpaUrl,bpaVars,bpa,plaid,bpaEventLog,bpaPlaidEventLogger,bpaSubscriptionEventLogger,bpaBankAccountEventLogger,$http,$timeout,$templateCache,$document,ACCOUNTING_ENTITY_KEY){return{restrict:"E",scope:{callbackObject:"=?",interfaceObject:"=?",skipVerification:"<",forcePrimary:"@",returnPaymentData:"<",formLockSelector:"@",ccFormLockSelector:"@",productChargeAmount:"@",flowName:"@",enableSubscription:"<"},templateUrl:bpaAddBillingMethod.getTemplateUrl(),controller:function($scope){var formBlocked=true,isTemplateLoaded=false,isInited=false,heightIntervalWatcher,paypalErrorMessage,plaidLoadingFailure=false,paymentOptionNodes={},paymentMethodLoaded={},methodsAppearanceOrder=[],orderedAvailableMethods=[],isManualBankAccountShown=false;bpaAddBillingMethod.setProductChargeAmount($scope.productChargeAmount);$scope.hasPaypalError=false;$scope.paypalLoadingFailure=false;$scope.mode=null;$scope.verificationMopRid=null;if(typeof $scope.forcePrimary==="undefined"){$scope.forcePrimary=1}if(!$scope.flowName){$scope.flowName="BPA:undefined"}bpaPlaidEventLogger.setFlowName($scope.flowName);bpaSubscriptionEventLogger.setFlowName($scope.flowName);bpaBankAccountEventLogger.setFlowName($scope.flowName);if(!$scope.formLockSelector){$scope.formLockSelector="#bpa-add-primary-payment"}if(!$scope.ccFormLockSelector){$scope.ccFormLockSelector="#bpa-cc-form-lock"}setupInterfaceObject();$scope.$on("$destroy",function(){clearInterval(heightIntervalWatcher)});bpaAddBillingMethod.getAvailableDataPromise().then(function(response){$scope.availableMethods=response.data;init()},function(){bpaAlert.addFatalErrorMessage(bpaVars.get(ACCOUNTING_ENTITY_KEY));doError()});$scope.templateLoaded=function(){isTemplateLoaded=true;init()};$scope.cancelVerification=function(){logEvent("click",{event_label:"doitlater"},"verify_card");doSuccess($scope.verificationMopRid,false,$scope.mode)};$scope.cancelSubscription=function(){bpaSubscriptionEventLogger.cancelSubscription();doSuccess($scope.subscriptionInfo.id,true,$scope.mode)};$scope.isActive=function(mode){return $scope.mode===mode};$scope.isBlocked=function(){return formBlocked||verificationFormIsBlocked()||subscriptionFormIsBlocked()||bankAccountFormIsBlocked()};$scope.isManualBankAccountShown=function(){return isManualBankAccountShown||!isPlaidEnabled()||plaidLoadingFailure};$scope.hasPlaid=function(){return isPlaidEnabled()&&!plaidLoadingFailure};$scope.addMethod=function(methodType){methodsAppearanceOrder.push(methodType);if("CC"!==methodType&&"ACH_DEPOSIT"!==methodType){setPaymentMethodLoaded(methodType)}};$scope.hasMethod=function(methodType){return $scope.availableMethods&&typeof $scope.availableMethods[methodType]!=="undefined"};$scope.useBalance=function(){doSuccess(null,true,"BALANCE")};$scope.ccCallbackObject={success:function(response){if(!response){doError();return}commonSuccessProcessing(response);var verificationInProgress=response.verify==="1";if(verificationInProgress){if($scope.skipVerification){doSuccess(response.id,false,"CC")}else{$scope.verificationMopRid=response.id}}else if(!$scope.subscriptionInfo){doSuccess(response.id,true,"CC")}},pageChanged:function(){if($scope.isActive("CC")){$timeout(function(){startPaymentHeightWatcher("CC")},400)}setPaymentMethodLoaded("CC")},error:function(response){if(response.anotherBillingMethodSuggestion){$scope.creditCardInterface.previousPage()}}};function setPaymentMethodLoaded(methodType){paymentMethodLoaded[methodType]=true;init()}function init(){if(!isInited&&isTemplateLoaded&&$scope.availableMethods){for(var methodType in $scope.availableMethods){if(!paymentMethodLoaded[methodType]){return}}formBlocked=false;$scope.mode=fillOrderedAvailableMethods();$timeout(function(){var nodes=$document[0].querySelectorAll(".bpa-add-primary-payment .bpa-hide-loading");for(var i=0,l=nodes.length;i<l;i++){nodes[i].classList.remove("bpa-hide-loading")}startPaymentHeightWatcher($scope.mode)},300);$timeout(function(){logEvent("impression",{selected_upm:$scope.mode})});isInited=true}}$scope.plaidCallbackObject={blockForm:function(){formBlocked=true},unblockForm:function(){formBlocked=false},success:function(response){formBlocked=false;if(!response){doError();return}plaid.closeModal();commonSuccessProcessing(response);if(!$scope.subscriptionInfo){doSuccess(response.id,true,"ACH_DEPOSIT")}},error:function(){plaid.setFormBlocked(false)},showManual:function(){isManualBankAccountShown=true},loadingFailure:function(){plaidLoadingFailure=true}};$scope.ppCallbackObject={init:function(){setPayPalError(false)},success:function(messages,mopData){formBlocked=false;commonSuccessProcessing({messages:messages,mod_data:mopData});doSuccess(mopData.id,true,"PAYPAL_DEPOSIT")},authorize:function(){formBlocked=true},error:function(message){formBlocked=false;setPayPalError(true,message)},loadingFailure:function(){formBlocked=false;$scope.paypalLoadingFailure=true},cancel:function(){formBlocked=false}};function setPayPalError(hasError,message){$scope.hasPaypalError=hasError;paypalErrorMessage=message}$scope.verifyCallbackObject={success:function(response){commonSuccessProcessing(response);if(!$scope.subscriptionInfo){doSuccess($scope.verificationMopRid,true,"CC")}}};$scope.baCallbackObject={success:function(response){if(!response){doError();return}commonSuccessProcessing(response);var verificationInProgress=response.verify==="1";if(verificationInProgress){doSuccess(response.id,false,"ACH_DEPOSIT")}else if(!$scope.subscriptionInfo){doSuccess(response.id,true,"ACH_DEPOSIT")}},pageChanged:function(){if($scope.isActive("ACH_DEPOSIT")){$timeout(function(){startPaymentHeightWatcher("ACH_DEPOSIT")},400)}setPaymentMethodLoaded("ACH_DEPOSIT")},showPlaid:function(){isManualBankAccountShown=false}};$scope.subscriptionCallbackObject={success:function(response){doSuccess($scope.subscriptionInfo.id,true,$scope.mode)}};$scope.$watch("mode",function(toMethod,fromMethod){if(fromMethod&&toMethod!==fromMethod){logEvent("click",{event_label:"changeupm",from_upm:fromMethod,to_upm:toMethod});var fromNodes=getPaymentOptionNodes(fromMethod);fromNodes.container.style.height="0";startPaymentHeightWatcher(toMethod)}});$scope.paypalGetError=function(defaultMessage){return paypalErrorMessage||defaultMessage};function commonSuccessProcessing(response){addMessages(response.messages);if(response.mop_data){bpa.setMethodOfPaymentInfo(response.mop_data)}if($scope.enableSubscription&&response.subscription_plan){var mopType=response.mop_data?response.mop_data.type:$scope.mode;bpaSubscriptionEventLogger.setMopType(mopType);$scope.subscriptionInfo={id:response.id||$scope.verificationMopRid,primary:response.primary,plan:response.subscription_plan,type:mopType}}}function setupInterfaceObject(){if(!$scope.interfaceObject){$scope.interfaceObject={}}$scope.interfaceObject.isSubscriptionFormActive=function(){return $scope.subscriptionInfo&&$scope.subscriptionInfo.id};$scope.interfaceObject.isAddPaymentFormActive=function(){return null===$scope.verificationMopRid&&!$scope.interfaceObject.isSubscriptionFormActive()};$scope.interfaceObject.isVerificationFormActive=function(){return null!==$scope.verificationMopRid&&!$scope.interfaceObject.isSubscriptionFormActive()};$scope.interfaceObject.isModalHidden=function(){return bpaAddBillingMethod.isModalHidden()};$scope.interfaceObject.getPaymentData=function(callback){if($scope.verificationMopRid){fetchPaymentData($scope.verificationMopRid,false,$scope.mode,callback)}else{callback(null)}}}function verificationFormIsBlocked(){return $scope.verificationMopRid&&$scope.verifyInterface&&$scope.verifyInterface.isBlocked&&$scope.verifyInterface.isBlocked()}function subscriptionFormIsBlocked(){return $scope.subscriptionInfo&&$scope.subscriptionInterface&&$scope.subscriptionInterface.isBlocked&&$scope.subscriptionInterface.isBlocked()}function bankAccountFormIsBlocked(){return $scope.bankAccountInterface&&$scope.bankAccountInterface.isBlocked&&$scope.bankAccountInterface.isBlocked()}function startPaymentHeightWatcher(methodType){adjustPaymentOptionHeight(methodType);clearInterval(heightIntervalWatcher);heightIntervalWatcher=setInterval(function(){adjustPaymentOptionHeight(methodType)},300)}function adjustPaymentOptionHeight(methodType){if(!isTemplateLoaded){return}var nodes=getPaymentOptionNodes(methodType);if(!nodes){return}if(0===nodes.content.clientHeight){return}var contentHeight=nodes.content.clientHeight+"px";if(contentHeight!==nodes.container.style.height){nodes.container.style.height=contentHeight}}function getPaymentOptionNodes(methodType){if(!paymentOptionNodes[methodType]){var containerNode=$document[0].querySelector("#bpa-method-"+methodType+" .bpa-collapsed"),contentNode;if(containerNode){contentNode=containerNode.querySelector(".bpa-content");paymentOptionNodes[methodType]={container:containerNode,content:contentNode}}}return paymentOptionNodes[methodType]}function fillOrderedAvailableMethods(){orderedAvailableMethods=[];methodsAppearanceOrder.forEach(function(methodType){if($scope.hasMethod(methodType)){orderedAvailableMethods.push(methodType)}});return orderedAvailableMethods.length?orderedAvailableMethods[0]:""}function doSuccess(mopRid,verified,type){if($scope.callbackObject&&$scope.callbackObject.success){fetchPaymentData(mopRid,verified,type,$scope.callbackObject.success)}}function fetchPaymentData(mopRid,verified,type,callback){if(!$scope.returnPaymentData){callback({mopRid:mopRid,verified:verified,type:type});return}bpa.getMethodOfPaymentInfo(mopRid,function(extendedMopData){if("object"!==typeof extendedMopData||!extendedMopData){doError()}else if(extendedMopData.type){callback(extendedMopData)}else{doError()}},function(){doError()})}function doError(){if($scope.callbackObject&&$scope.callbackObject.error){$scope.callbackObject.error()}}function logEvent(eventName,data,sublocation){data=data||{};data.flow=$scope.flowName;bpaEventLog.logEvent(eventName,"add_upm",data,sublocation)}function addMessages(messages){if(messages&&messages.length>0){bpaAlert.addAlertMessages(messages)}}function isPlaidEnabled(){return $scope.hasMethod("ACH_DEPOSIT")&&!!$scope.availableMethods["ACH_DEPOSIT"].plaidEnabled}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("addPaypalForm",["bpaUrl","bpaBlockMode",function(bpaUrl,bpaBlockMode){return{restrict:"E",scope:{returnUrl:"@",cancelUrl:"@",errorUrl:"@",forcePrimary:"@"},require:"bpaBaseForm",templateUrl:bpaUrl.resourceUrl(["/resources/html/add-paypal.partial.html","add-paypal.partial.html"]),link:function($scope,element,attr,bpaBaseForm){bpaBaseForm.init($scope,element,"paypal").setSubmit(_submit).setIsValid(_isValid).setIsAboutToRedirect(_isAboutToRedirect);if(element[0].querySelector(".bpa-flash-messages")){bpaBaseForm.setNeedAttention()}function _submit(){var fallbackUrl=location.href,args={returnUrl:$scope.returnUrl||fallbackUrl,cancelUrl:$scope.cancelUrl||fallbackUrl,errorUrl:$scope.errorUrl||fallbackUrl};if($scope.forcePrimary){args.forcePrimary="1"}bpaBaseForm.setSubmitLock("PayPal",bpaBlockMode.lockSubmit);document.location=bpaUrl.resourceUrl("/billing-agreement/create",args,true)}function _isValid(){return true}function _isAboutToRedirect(){return true}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("addPrimaryPaymentButton",["bpaUrl","bpa","bpaAddBillingMethod",function(bpaUrl,bpa,bpaAddBillingMethod){return{scope:{callbacks:"=?",buttonClass:"@",buttonLabel:"@",productChargeAmount:"@",flowName:"@"},templateUrl:bpaUrl.baseUrl()+"add-primary-method/add-button",link:function($scope){bpaAddBillingMethod.setProductChargeAmount($scope.productChargeAmount);$scope.isError=false;getMopInfo();$scope.click=function(){runCallback("click");bpaAddBillingMethod.show({flowName:$scope.flowName,forcePrimary:1}).then(onModalClose,onModalClose)};function onModalClose(data){runCallback("close");getMopInfo()}$scope.isVerificationInProgress=function(){return $scope.paymentData&&"in_progress"===$scope.paymentData.verification};$scope.isPrimaryPayment=function(){return!!$scope.paymentData};$scope.getAddButtonLabel=function(defaultLabel){return $scope.buttonLabel||defaultLabel};$scope.getAddButtonClass=function(defaultClass){return $scope.buttonClass||defaultClass};$scope.getPaymentIconClass=function(){if($scope.paymentData){switch($scope.paymentData.type){case"CC":var baseClass="bpa-cards-icon-img bpa-cards-icon bpa-primary-payment-icon bpa-cards-icon-";return baseClass+getCardIconClass($scope.paymentData.card_type);case"PAYPAL_DEPOSIT":return"bpa-primary-payment-icon bpa-payment-icon-paypal"}}return""};function getCardIconClass(cardType){switch(cardType){case"Visa":return"visa";case"MasterCard":return"mastercard";case"American Express":return"amex"}return""}function getMopInfo(){$scope.isLoading=true;bpa.getMethodOfPaymentInfo(null,function(data){if("object"!==typeof data||!data){runCallback("error")}else if(data.type){$scope.paymentData=data;runCallback("success",data)}else{bpaAddBillingMethod.preFetchData()}$scope.isLoading=false},function(reason){$scope.isLoading=false;$scope.isError=true;runCallback("error",reason)})}function runCallback(callbackName,data){if($scope.callbacks&&$scope.callbacks[callbackName]){$scope.callbacks[callbackName](data)}}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("addPrimaryPayment",["bpaUrl","bpaFormMode",function(bpaUrl,formMode){var wrapperController=null,templateUrl=getTemplateUrl();var struct={restrict:"E",scope:{returnUrl:"@",cancelUrl:"@",errorUrl:"@",callbackObject:"=?",isSubmited:"=?",commObject:"=",hideControls:"=?",lockOnSubmit:"@",mode:"=?",colFieldsClass:"@",showErrorNotification:"@",validateOnSubmit:"=?",embedMode:"@",useBalanceStub:"@"},require:"bpaBaseForm",link:function($scope,element,attr,bpaBaseForm){if(!bpaBaseForm.templateIsOk(templateUrl)){return}bpaBaseForm.init($scope,element,"addPrimaryPayment").setSubmit(null).setNeedAttentionCallback(_needAttentionCallback);if(!$scope.mode){$scope.mode="credit_card"}if("undefined"==typeof $scope.validateOnSubmit){$scope.validateOnSubmit=true}if(!$scope.embedMode){$scope.embedMode="fullpage"}$scope.embedModePage="fullpage"===$scope.embedMode;$scope.isPayPalFormActive=function(){return"paypal"==$scope.mode};$scope.isCreditCardFormActive=function(){return"credit_card"==$scope.mode};$scope.isUseBalanceFormActive=function(){return"use_balance"==$scope.mode};if($scope.commObject){populateCommObject()}function _needAttentionCallback(formName){$scope.mode=formName}function populateCommObject(){if(formMode.isStub){extendCommObject(bpaBaseForm);return}$scope.commObject.isChooseAvailable=function(){return!!$scope.chooseAvailable};$scope.commObject.getActiveFormName=function(){return $scope.mode};bpaBaseForm.addActiveFormCallback=function(activeForm){extendCommObject(activeForm)};$scope.$watch("mode",watchMode)}function watchMode(){var activeForm=bpaBaseForm.getActiveChildForm();if(!activeForm){return}extendCommObject(activeForm)}function extendCommObject(activeForm){angular.extend($scope.commObject,activeForm.getInterfaceObject())}}};if(!formMode.isStub){struct.templateUrl=templateUrl}return struct;function getTemplateUrl(){var productChargeAmount=Applet.getVar("productChargeAmount");return bpaUrl.resourceUrl(["resources/html/add-primary-payment.partial.html","add-primary-payment.html"],typeof productChargeAmount!="undefined"&&parseFloat(productChargeAmount)>0?{productChargeAmount:parseFloat(productChargeAmount)}:{})}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bankAccountForm",["bpaUrl","eoModal","$timeout","$document","bpaIovation","bpaBankAccountEventLogger",function(bpaUrl,eoModal,$timeout,$document,bpaIovation,bpaBankAccountEventLogger){return{restrict:"E",scope:{cancelUrl:"@",removeMopUrl:"@",recordId:"@",mopType:"@",isModern:"@",forcePrimary:"@",aeType:"@",modeUsUs:"@",enableBackButton:"<",callbackObject:"<"},require:"bpaBaseForm",templateUrl:function(tElement,tAttr){var formType=tAttr.mopType&&tAttr.mopType=="deposit"?"bank-account-form":"direct-deposit-form";var urlPrefix="";if("1"==tAttr.isModern){urlPrefix="modern-"}return(tAttr.recordId?bpaUrl.formUrl("edit-"+formType)+"/"+tAttr.recordId:bpaUrl.formUrl(urlPrefix+"add-"+formType))+"?"+Math.random()},link:function($scope,element,attr,bpaBaseForm){bpaBaseForm.init($scope,element,"ach").setSubmit(_submit);bpaBaseForm.setEventLogger(bpaBankAccountEventLogger);if("1"!=$scope.isModern){bpaBankAccountEventLogger.setFlowName("BPA:"+$scope.aeType+":"+($scope.modeUsUs?"us_us":"deposit"===$scope.mopType?"deposit_methods":"disbursement_methods"))}$scope.commObject=bpaBaseForm.getInterfaceObject();$scope.commObject.isBlocked=isBlocked;if($scope.mopType!="deposit"){bpaBaseForm.setRemoveAction(_removeMop)}if(element[0].querySelector(".bpa-flash-messages")){bpaBaseForm.setNeedAttention()}function _submit(callbackObject){if($scope.ach_form.$valid){$scope.bpaFormData.forcePrimary=$scope.forcePrimary;bpaIovation.updateScope($scope,function(){bpaBaseForm.sendFormData($scope.bpaFormData,callbackObject)})}}$scope.revalidateRoutingNumber=function(){bpaBaseForm.revalidateField("routingNumber")};$scope.backToPlaid=function(){runCallback("showPlaid");bpaBankAccountEventLogger.backToPlaid()};function _removeMop(callbackObject){eoModal.custom({locals:{_injectedProperties:{}},keyboard:false,controller:"yesNoModalController",templateUrl:"removalWarning.html"}).result.then(function(){if($scope.removeMopUrl){document.location=$scope.removeMopUrl}},function(){})}function runCallback(callbackName,message,data){if($scope.callbackObject[callbackName]){$timeout(function(){$scope.callbackObject[callbackName](message,data)})}}function isBlocked(){return bpaBaseForm.isScreenLocked("form")}var errorFunc=$scope.callbackObject.error;$scope.callbackObject.error=function(){$timeout(function(){var routingNumberCtrl=bpaBaseForm.getCtrlByModelName("routingNumber");if(routingNumberCtrl.$invalid&&routingNumberCtrl.$viewValue){bpaBankAccountEventLogger.logAbaValidationError(routingNumberCtrl.$viewValue)}});if(errorFunc){errorFunc()}}},controller:["$scope",function($scope){$scope.accountHint={class:"hint-check",text:"&nbsp;<br />&nbsp;",update:function(event){if(event.type=="blur"){$scope.accountHint.class="hint-check";$scope.accountHint.text="&nbsp;<br />&nbsp;"}else if(event.type=="focus"){var element=angular.element(event.target);$scope.accountHint.text=element.attr("data-account-hint-text");$scope.accountHint.class=element.attr("data-account-hint-class")}}};$scope.bankInfo={}}]}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bankAccountPlaidForm",["bpaUrl","plaid","bpaAddBillingMethod","$timeout","bpaVars","bpaPlaidEventLogger","$http","DEPOSIT_METHODS_URL_PART",function(bpaUrl,plaid,bpaAddBillingMethod,$timeout,bpaVars,bpaPlaidEventLogger,$http,DEPOSIT_METHODS_URL_PART){return{restrict:"E",scope:{accountTypes:"<",forcePrimary:"@",processingFee:"<",bpaCommObject:"=?",callbackObject:"<"},templateUrl:bpaUrl.resourceUrl(DEPOSIT_METHODS_URL_PART+"/partials/bank-account-plaid.html"),link:function($scope){var plaidMaxLoadIteration=20,plaidLoadIteration=0,networkError=false;function openPlaidThirdPartyModal(){if(plaid.isPlaidLoaded()){plaid.setPlaidModalHidden(true);plaid.getPlaidHandler().open()}else{if(plaidLoadIteration===plaidMaxLoadIteration){plaidLoadIteration=0;networkError=true}else{$timeout(openPlaidThirdPartyModal,1e3)}plaidLoadIteration++}}function runCallback(callbackName,message,data){if($scope.callbackObject[callbackName]){$timeout(function(){$scope.callbackObject[callbackName](message,data)})}}$scope.initPlaid=function(){runCallback("blockForm");var modalInstance=plaid.getModal({},{accountTypes:$scope.accountTypes,bpaCommObject:$scope.bpaCommObject,callbackObject:$scope.callbackObject,forcePrimary:$scope.forcePrimary});modalInstance.opened.then(function(){$timeout(function(){runCallback("unblockForm");bpaAddBillingMethod.setModalHidden(true);$timeout(function(){openPlaidThirdPartyModal()},2e3);if(networkError){plaid.closeModal()}})});bpaPlaidEventLogger.addViaPlaid()};$scope.showManual=function(){runCallback("showManual");bpaPlaidEventLogger.addViaManual()};$scope.isNetworkError=function(){return plaid.hasNetworkError()||networkError};$scope.isPlaidAccountsEmpty=function(){return plaid.isPlaidAccountsEmpty()};plaid.initPlaid(function(){$scope.loadingFailure=true;bpaPlaidEventLogger.addViaManual();runCallback("loadingFailure")})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bankAccountPlaidModalForm",["bpaUrl","bpaIovation","plaid","bpaPlaidEventLogger",function(bpaUrl,bpaIovation,plaid,bpaPlaidEventLogger){return{restrict:"E",scope:{accountTypes:"<",forcePrimary:"@"},require:"bpaBaseForm",templateUrl:function(){return bpaUrl.baseUrl(true)+"add-plaid-bank-account-form.html"},link:function($scope,element,attr,bpaBaseForm){init();bpaBaseForm.setEventLogger(bpaPlaidEventLogger);function init(){bpaBaseForm.init($scope,element,"plaidForm").setSubmit(_submit)}var isSubmitAttempt=false;$scope.commObject=bpaBaseForm.getInterfaceObject();$scope.bpaFormData={combinedAccount:[],bankAccount:null};if(typeof $scope.primaryStatusCheck!=="undefined"){$scope.bpaFormData.primaryStatus=$scope.primaryStatusCheck}$scope.$watch("bpaFormData.bankAccount",function(oldValue,newValue){if(newValue!==oldValue){$scope.setSubmitAttempt(false);$scope.plaidForm.radioGroup.$setPristine()}});$scope.getBankAccountString=function(){return plaid.getBankAccounts()};$scope.getAccounts=function(){return plaid.getAccounts()};$scope.isAccountsLoaded=function(){return plaid.getAccounts().length>0};$scope.isSubmitAttempt=function(){return isSubmitAttempt};$scope.setSubmitAttempt=function(value){isSubmitAttempt=value};function _submit(callbackObject){plaid.setFormBlocked(true);$scope.setSubmitAttempt(false);var currentBankAccount=plaid.getAccounts()[$scope.bpaFormData.bankAccount];var submitData={routingNumberEncrypted:currentBankAccount.routingEncrypted,accountNumberEncrypted:currentBankAccount.accountEncrypted,accountType:currentBankAccount.subtype,ownerType:$scope.bpaFormData.combinedAccount[$scope.bpaFormData.bankAccount],beneficiaryName:$scope.bpaFormData.beneficiaryName,plaidAccountId:currentBankAccount.accountId,plaidAccessTokenEncrypted:plaid.getAccessTokenEncrypted(),primaryStatus:$scope.forcePrimary?"1":$scope.bpaFormData.primaryStatus?"1":"0"};bpaIovation.setBlackBox(submitData,function(){bpaBaseForm.sendFormData(submitData,callbackObject)})}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bankAccountTemporaryDeposits",function(){return{restrict:"E",scope:{gotItUrl:"@"},templateUrl:"bpaBankAccountTemporaryDeposits.html"}})})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaAbaValidate",["$q","bpaGetBankInfo","$parse",function($q,bpaGetBankInfo,$parse){return{restrict:"A",require:"ngModel",link:function($scope,element,attr,ngModel){var bankInfoModel=$parse(attr.bankInfoModel),validationError;function initValidationErrorPromise(){if(!validationError||validationError.promise.$$state.status!=0){validationError=$q.defer()}}ngModel.$asyncValidators.bpaAbaValidate=function(modelValue){return $q(function(resolve,reject){initValidationErrorPromise();bpaGetBankInfo.get(modelValue).then(function(bankInfo){bankInfoModel.assign($scope,bankInfo);resolve();validationError.resolve()},function(rejection){if(rejection.code==404){reject();validationError.resolve();bankInfoModel.assign($scope,{})}else{resolve();validationError.reject();bankInfoModel.assign($scope,null)}})})};ngModel.$asyncValidators.bpaAbaValidationError=function(){initValidationErrorPromise();return validationError.promise}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaAlertMessages",["bpaAlert",function(bpaAlert){return{scope:{messagesFromJson:"=",currentAe:"<",fatalErrorMessage:"@"},templateUrl:"alertMessagesTpl.html",link:function($scope,element,attr){bpaAlert.setFatalErrorMessage($scope.fatalErrorMessage);bpaAlert.addAlertMessages($scope.messagesFromJson);$scope.getAlertMessages=function(){return bpaAlert.getAlertMessages($scope.currentAe)};$scope.closeAlert=function(index){bpaAlert.closeAlertMessage(index)}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaAmountInput",[function(){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){var pattern=/^[0-9]+[.,][0-9]{2}$/;ctrl.$validators.bpaMin=function(value){if("undefined"===typeof value){return true}value=_parseFloat(value);if(isNaN(value)){return false}return value>0};ctrl.$validators.bpaPattern=function(value){if("undefined"===typeof value){return true}return pattern.test(value)};ctrl.$parsers.push(function(value){return value&&value.replace?value.replace(",","."):value});function _parseFloat(value){if(!value&&0!==value){return NaN}return parseFloat(value)}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaAsyncIndicator",["$compile",function($compile){var uniqueId=0;return{restrict:"A",link:function($scope,element,attrs){if(element.hasClass("bpa-has-async-indicator")){return}var scopeVarName="isBpaAsyncPerformed"+ ++uniqueId;$scope[scopeVarName]=false;var indicatorElement=angular.element('<div data-ng-show="'+scopeVarName+'" class="bpa-indicator-anchor no-hide-animation">'+'<span class="glyphicon air-icon-loading bpa-indicator-icon" '+'aria-hidden="true"></span>'+"</div>");element.after(indicatorElement);element.addClass("bpa-has-async-indicator");$compile(indicatorElement)($scope);$scope.$watch(attrs.bpaAsyncIndicator,function(value){$scope[scopeVarName]=!!value})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaBindCompile",["$compile","$parse","$sanitize",function($compile,$parse,$sanitize){return{restrict:"A",link:function($scope,element,attrs){var getter=$parse(attrs.bpaBindCompile);$scope.$watch(function(){return getter($scope)},function(value){element.html(value&&$sanitize(value.toString()));$compile(element.contents())($scope)})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaCardNumberFormat",["CreditCards","$document","$timeout",function(CreditCards,$document,$timeout){return{restrict:"A",require:"ngModel",link:function($scope,element,attr,ctrl){var currentElementIdAttr="data-bpa-card-format-id";buildElement(element);ctrl.$parsers.push(function(value){setCardIcon(value);formatNumber(value);return value});function buildElement(element){var currentElementId=element.attr(currentElementIdAttr);if("undefined"===typeof currentElementId){$timeout(addIcons);currentElementId=getCurrentElementId();element.attr({maxlength:"19",type:"tel",inputmode:"numeric",autocomplete:"cc-number",autocompletetype:"cc-number","x-autocompletetype":"cc-number","data-bpa-card-format-id":currentElementId});element.addClass("bpa-card-icon")}element.cardIconNode=getCardIconNode(currentElementId)}function addIcons(){var cards=CreditCards.getAvailableCreditCards();for(var i=0,l=cards.length;i<l;i++){addIconNode("bpa-cards-icon bpa-cards-icon-"+cards[i]+" bpa-card-icon-list")}addIconNode("bpa-card-lock-icon")}function getCurrentElementId(){var nodes=$document[0].querySelectorAll("input["+currentElementIdAttr+"]"),id=0;for(var i=0,l=nodes.length;i<l;i++){id=Math.max(1*nodes[i].getAttribute(currentElementIdAttr),id)}return nodes.length?id+1:id}function getCardIconNode(currentElementId){var cardIconNodeId="bpa-cards-icon-"+currentElementId,node=$document[0].getElementById(cardIconNodeId);if(!node){node=addIconNode("bpa-cards-icon",true);node.setAttribute("id",cardIconNodeId)}return node}function setCardIcon(value){var card=CreditCards.updateNumber(value),cardClass=card?"bpa-cards-icon-"+card.type:"";setIconNodeClass(element.cardIconNode,"bpa-cards-icon  "+cardClass)}function formatNumber(originalValue){var start=element[0].selectionStart,end=element[0].selectionEnd,spaceLessValue=originalValue.replace(/ \s*/g,""),formatedValue="",part;part=spaceLessValue.substr(i,4);formatedValue+=part;for(var i=4;i<spaceLessValue.length;i+=4){part=spaceLessValue.substr(i,4);if(part.length){formatedValue+=" "+part}}end+=calcCursorPos(originalValue,formatedValue,end);start+=calcCursorPos(originalValue,formatedValue,start);element.val(formatedValue);element[0].setSelectionRange(start,end)}function calcCursorPos(originalValue,formatedValue,pos){return countSpaces(formatedValue,pos)-countSpaces(originalValue,pos)}function countSpaces(value,endPos){var spacesCount=0,spacePosition=-1;do{spacePosition=value.indexOf(" ",spacePosition+1)}while(spacePosition!=-1&&spacePosition<endPos&&++spacesCount);return spacesCount}function addIconNode(classString,before){var node=element[0],iconNode=document.createElement("span"),parentNode=node.parentNode;setIconNodeClass(iconNode,classString);parentNode.insertBefore(iconNode,before?node:node.nextSibling);return iconNode}function setIconNodeClass(iconNode,classString){iconNode.setAttribute("class","bpa-cards-icon-img "+classString)}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaCardNumber",["CreditCards",function(CreditCards){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){var validateKey=null;ctrl.$parsers.push(function(value){var card=CreditCards.updateNumber(value);validateKey=validate(value,card);return value});ctrl.$validators.required=function(){return validateKey!=="required"};ctrl.$validators.bpaCcType=function(){return validateKey!=="bpaCcType"};ctrl.$validators.bpaCcNumber=function(){return validateKey!=="bpaCcNumber"};ctrl.$validators.bpaCcFormat=function(){return validateKey!=="bpaCcFormat"};function validate(value,card){if(!value){return"required"}value=(value+"").replace(/\D/g,"");if(!/^\d+$/.test(value)){return"bpaCcType"}if(!card){return"bpaCcType"}if(-1===card.length.indexOf(value.length)){return"bpaCcNumber"}if(!(false===card.luhn||luhnCheck(value))){return"bpaCcFormat"}return null}function luhnCheck(num){var digit,odd=true,sum=0,i,len,digits=(num+"").split("").reverse();for(i=0,len=digits.length;i<len;i++){digit=digits[i];digit=parseInt(digit,10);if(odd=!odd){digit*=2}if(digit>9){digit-=9}sum+=digit}return sum%10===0}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaCardPhone",[function(){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){ctrl.$validators.phoneFormat=function(value){if(!value){return true}if(/^[0-9()\-.\s]+$/.test(value)){return value.replace(/\D/g,"").length===10}return false}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaVatGroup",function(){return{scope:{bpaVatGroup:"@",formatCorrectnessFlag:"=",vatModel:"="},restrict:"A",controller:function($scope){this.isStrict=function(){return"strict"===$scope.bpaVatGroup};this.setCorrectness=function(flag){$scope.formatCorrectnessFlag=flag};this.setVatValue=function(value){$scope.vatModel=value}}}}).directive("bpaCheckVatFormat",function(){return{restrict:"A",require:["ngModel","^^bpaVatGroup"],link:function($scope,element,attr,ctrl){var ngModel=ctrl[0],bpaVatGroup=ctrl[1],vatRegex=new RegExp(attr.vatPattern.replace(/^\/(.*)\/$/,"$1")),vatOnlyDigitsRegex=/[^0-9]/g,minDigitsCount=parseInt(attr.minDigitsCount),formatIsValid=false;$scope.inputController=ngModel;if(!isNaN(minDigitsCount)){ngModel.$validators.vatDigits=function(){return!ngModel.$viewValue||minDigitsCount<=ngModel.$viewValue.replace(vatOnlyDigitsRegex,"").length}}ngModel.$validators.vatFormat=function(){formatIsValid=ngModel.$viewValue&&vatRegex.test(ngModel.$viewValue);return bpaVatGroup.isStrict()?formatIsValid:true};$scope.$watch(attr.ngModel,function(value){bpaVatGroup.setVatValue(value);bpaVatGroup.setCorrectness(ngModel.$valid&&formatIsValid)})}}})})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaExternalScriptsGroup",["ExternalScripts","$timeout",function(ExternalScripts,$timeout){return{restrict:"E",require:"bpaExternalScriptsGroup",link:function($scope,element,attr,group){group.setName(attr.name)},controller:function($scope){var counter=0,isError=false,name,self=this,timeoutHandler=null;this.setName=function(_name){name=_name};this.registerScript=function(){counter++;_clearTimeout();timeoutHandler=$timeout(self.setError,3e4)};this.setScriptReady=function(){counter--;if(!counter){_clearTimeout();ExternalScripts.setReady(name)}};this.setError=function(){if(isError||!counter){return}isError=true;ExternalScripts.setError(name)};function _clearTimeout(){if(timeoutHandler){$timeout.cancel(timeoutHandler)}}}}}]).directive("bpaExternalScript",["ExternalScripts",function(ExternalScripts){return{restrict:"E",require:"?^^bpaExternalScriptsGroup",link:function($scope,elem,attr,group){if(!attr.src){throw'"src" is mandatory attribute for bpaExternalScript'}if(group){group.registerScript()}ExternalScripts.download(attr.src,{onload:function(){if(group){group.setScriptReady()}},onerror:function(){if(group){group.setError()}}})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaFormControls",["bpaUrl",function(bpaUrl){return{restrict:"E",templateUrl:bpaUrl.resourceUrl(["/resources/html/form-controls.partial.html","form-controls.partial.html"]),require:"^^bpaBaseForm",scope:{submitLabel:"@",cancelUrl:"@",showRemoveButton:"@"},link:function($scope,element,attr,bpaBaseForm){$scope.commObject=bpaBaseForm.getInterfaceObject()}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaFormPage",function(){return{restrict:"E",transclude:true,scope:{pageId:"="},require:["^^bpaBaseForm","bpaFormPage"],compile:function(){return{pre:function($scope,element,attr,controllers){var parentForm=controllers[0],pageCtrl=controllers[1];if(!parentForm){throw new Error("bpa-form-page should be used only inside bpa-base-form")}pageCtrl.init($scope.pageId,parentForm);parentForm.addFormPage($scope.pageId,pageCtrl);$scope.isPageVisible=function(){return pageCtrl.isVisible()}}}},controller:function(){var _pageId,_parentForm;this.init=function(pageId,parentForm){_pageId=pageId;_parentForm=parentForm};this.getPageId=function(){return _pageId};this.isVisible=function(){return _parentForm.isPageVisible(_pageId)};this.isValid=function(){return _parentForm.validateFormPageById(_pageId)};this.addController=function(control){_parentForm.addControllerToPage(_pageId,control)}},template:'<div data-ng-transclude data-ng-show="isPageVisible()" class="bpa-form-page"></div>'}})})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaMethodsPageLink",["$window","$injector",function($window,$injector){return{restrict:"C",scope:{href:"@"},link:function($scope,element){if($window.location.pathname===$scope.href&&getClosestParent(element[0],"modal-dialog")!==null&&$injector.has("$modalStack")){var $modalStack=$injector.get("$modalStack");element.on("click",function(event){event.preventDefault();event.stopPropagation();$modalStack.dismissAll();if($window.scrollTo){$window.scrollTo(0,0)}})}}}}]);function getClosestParent(element,className){for(;element;element=element.parentNode){if(element.classList.contains(className)){return element}}return null}})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaPaypalButton",["ExternalScripts","bpaIovation","bpaUrl","$compile","$http","$timeout","bpaEventLog",function(ExternalScripts,bpaIovation,bpaUrl,$compile,$http,$timeout,bpaEventLog){return{restrict:"E",scope:{size:"@",color:"@",shape:"@",label:"@",callbacks:"=?",forcePrimary:"@",flowName:"@"},link:function($scope,element){var createUrl,nodeId="_bpaPayPalElement";$scope.callbacks=$scope.callbacks||{};element[0].setAttribute("id",nodeId);$http.get(bpaUrl.resourceUrl("paypal/config"),{cache:true}).success(function(data){if(!data||!data.key){loadingFailureCallback("Paypal configuration response is invalid")}createUrl=data.createUrl;var attrs={};attrs["data-version-"+data.version]="";ExternalScripts.download(data.url,{onload:function(){if(angular.isDefined(paypal)&&angular.isDefined(paypal.Button)){renderPayPalButton(nodeId,data.env,data.key)}else{loadingFailureCallback("Paypal API failed to load")}},onerror:function(){loadingFailureCallback("External scripts loading error")}},attrs)}).error(function(){loadingFailureCallback("Paypal configuration loading error")});function renderPayPalButton(nodeId,env,key){if(paypal.Button.props&&paypal.Button.props.payment){paypal.Button.props.payment.timeout=1e5}paypal.Button.render({env:env,client:{production:key,sandbox:key},locale:"en_US",payment:payment,commit:true,onAuthorize:authorize,onCancel:cancel,logLevel:"error",style:{size:$scope.size||"responsive",color:$scope.color||"blue",shape:$scope.shape||"rect",label:$scope.label||"pay"}},"#"+nodeId)}function payment(resolve,reject){logEvent("click");runCallback("init");var args={};if($scope.forcePrimary){args.forcePrimary=$scope.forcePrimary}$http.post(bpaUrl.urlSetAe(createUrl),args).success(function(data){if(!data){errorCallback();return reject(new Error("no data"))}if(!data.agreement_key||!data.status){var message=data.messages&&data.messages.length?data.messages[0].message:undefined;errorCallback(message);return reject(new Error(message))}resolve(data.agreement_key)}).error(function(err){errorCallback();reject(new Error(err))})}function authorize(data){runCallback("authorize");bpaIovation.getBlackBox(function(blackbox){accept(data.returnUrl,{iovationBlackBox:blackbox})})}function accept(acceptUrl,postData){$http.post(acceptUrl,postData).success(function(data){if(!data){return errorCallback()}if(!data.status){var message=data.messages&&data.messages.length?data.messages[0].message:undefined;return errorCallback(message)}logImpressionEvent("success");runCallback("success",data.messages,data.mop_data)}).error(function(err){errorCallback()})}function cancel(){logImpressionEvent("cancel");runCallback("cancel")}function errorCallback(message){logImpressionEvent("failure",message);runCallback("error",message)}function loadingFailureCallback(message){logImpressionEvent("failure",message,"loading");runCallback("loadingFailure")}function logImpressionEvent(status,message,label){var data={event_label:label||"paypalstatus",status:status,status_message:message?[message]:[]};logEvent("impression",data)}function logEvent(eventName,data){data=data||{};data.flow=$scope.flowName;bpaEventLog.logEvent(eventName,"add_upm",data,"add_paypal")}function runCallback(callbackName,message,data){if($scope.callbacks[callbackName]){$timeout(function(){$scope.callbacks[callbackName](message,data)})}}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaRoutingNumber",[function(){return{restrict:"A",link:function($scope,element){var updateOnEvent="updateEvent";var routingNumberLength=9;element.on("input",function(){var length=element.val().length;if(length>routingNumberLength-1){element.triggerHandler(updateOnEvent)}})}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaSetLocation",["$window","$location",function($window,$location){return{restrict:"E",scope:{location:"@",reload:"@"},link:function($scope){if($scope.reload){$window.location=$scope.location}else{$location.path($scope.location)}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaShowBankInfo",function(){function _addressToHtml(bankInfo){return[bankInfo.city,bankInfo.district&&bankInfo.district!="-"?bankInfo.district:"",bankInfo.state!=bankInfo.city?bankInfo.state:"",bankInfo.zip!="-"?bankInfo.zip:"",bankInfo.country||(bankInfo.country_code2=="US"?"UNITED STATES":"")].filter(function(v){return v||null}).join(", ")}return{restrict:"E",templateUrl:"bpaShowBankInfo.html",scope:{bankInfo:"="},link:function($scope,element,attr){$scope.getAddress=function(){return _addressToHtml($scope.bankInfo.info)}}}})})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaVar",["bpaVars",function(bpaVars){return{restrict:"E",scope:{key:"@",value:"@"},link:function($scope){bpaVars.set($scope.key,$scope.value)}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("choiceModelInit",["$parse",function($parse){return{restrict:"A",link:function($scope,element,attr){if(attr.ngModel){var model=$parse(attr.ngModel);model.assign($scope,element[0].value)}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("clientPlanSubscription",["bpa","bpaUrl","bpaVars","bpaClientSubscription","$filter","bpaDepositMethods","bpaSubscriptionEventLogger","DEPOSIT_METHODS_URL_PART","ACCOUNTING_ENTITY_KEY",function(bpa,bpaUrl,bpaVars,bpaClientSubscription,$filter,bpaDepositMethods,bpaSubscriptionEventLogger,DEPOSIT_METHODS_URL_PART,ACCOUNTING_ENTITY_KEY){var _templateUrl=bpaUrl.resourceUrl(DEPOSIT_METHODS_URL_PART+"/partials/client-plan-subscription-form.html");return{restrict:"E",require:"bpaBaseForm",scope:{subscriptionInfo:"=?",callbackObject:"=?",flowName:"@",subscriptionUrl:"@"},templateUrl:_templateUrl,link:function($scope,element,attr,baseForm){var isBlocked=true;init();$scope.$watch("subscriptionInfo",function(subscriptionInfo){if(typeof subscriptionInfo==="undefined"){return}isBlocked=false});$scope.getSubscriptionFee=function(){return $scope.subscriptionInfo&&$scope.subscriptionInfo.plan&&$scope.subscriptionInfo.plan.fee?$filter("number")($scope.subscriptionInfo.plan.fee,2)+"%":""};$scope.getBenefitAmount=function(){if($scope.subscriptionInfo&&$scope.subscriptionInfo.plan&&$scope.subscriptionInfo.plan.fee){return $scope.subscriptionInfo.plan.price*100/$scope.subscriptionInfo.plan.fee}return 0};$scope.learnmoreSubscription=function(){bpaSubscriptionEventLogger.learnmoreSubscription()};function init(){baseForm.init($scope,element,"clientPlanSubscription").setSubmit(_submit).setIsValid(function(){return!!$scope.subscriptionInfo});bpaClientSubscription.setUrl($scope.subscriptionUrl);baseForm.setEventLogger(bpaSubscriptionEventLogger);var interfaceObject=baseForm.getInterfaceObject();interfaceObject.isBlocked=_isBlocked}function _isBlocked(){return isBlocked||baseForm.isScreenLocked("form")}function _submit(callbackObject){isBlocked=true;if(!$scope.subscriptionInfo.primary){bpaDepositMethods.setPrimaryMop(bpaVars.get(ACCOUNTING_ENTITY_KEY),$scope.subscriptionInfo.id).then(function(response){if(response.data&&!response.data.status){doError()}else{doSubscription(callbackObject)}},function(){doError()})}else{doSubscription(callbackObject)}}function doSubscription(callbackObject){bpaClientSubscription.subscribe($scope.subscriptionInfo.plan.product_id).then(function(){isBlocked=false;if(callbackObject&&callbackObject.success){callbackObject.success();bpaSubscriptionEventLogger.submitSuccess()}},function(){doError()})}function doError(){baseForm.addStandardError();isBlocked=false}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("depositMethods",["$location","$http","$templateCache","bpa","bpaUrl","bpaAlert","DEPOSIT_METHODS_URL_PART","bpaAddBillingMethod","bpaDepositMethods",function($location,$http,$templateCache,bpa,bpaUrl,bpaAlert,DEPOSIT_METHODS_URL_PART,bpaAddBillingMethod,bpaDepositMethods){return{scope:{currentAe:"<",aeType:"@"},templateUrl:"depositMethodsTpl.html",link:function($scope,element,attr){bpaDepositMethods.setScreenLoading(false);bpa.setAccountingEntityRid($scope.currentAe);bpaAddBillingMethod.preFetchData();if("add-payment-method"==$location.hash()){showAddMopModal()}function setPrimaryRequest(aeRid,rid){bpaDepositMethods.setPrimaryMop(aeRid,rid).success(function(data){bpaDepositMethods.processResponse(aeRid,data)}).error(function(){bpaDepositMethods.processFatalErrorInResponse(aeRid)})}function depositMethodsActionUrl(accountId,action,mopRid){return bpaUrl.depositMethodsBaseUrl(accountId)+"/"+mopRid+"/"+action}function showAddMopModal(){bpaAddBillingMethod.show({flowName:"BPA:"+$scope.aeType+":deposit_methods",enableSubscription:true,forcePrimary:0}).then(onAddMopModalClose,onAddMopModalClose)}function onAddMopModalClose(){bpaDepositMethods.setScreenLoading(true);bpaDepositMethods.depositMethodsReload()}$scope.$watch("currentAe",function(oldAe,newAe){if(oldAe!=newAe){bpaAddBillingMethod.removeAddCardFormFromCache();bpaDepositMethods.setScreenLoading(true);bpaDepositMethods.depositMethodsReload()}});$scope.getDepositTemplateUrl=function(){return bpaDepositMethods.getDepositTemplateUrl()};$scope.templateLoaded=function(){bpaDepositMethods.setScreenLoading(false)};$scope.setPrimary=function(aeRid,rid,canBeSetAsPrimaryByUser,primaryMopSubscribedForClient,mopRelatedToSubscription){if(canBeSetAsPrimaryByUser==1){bpaDepositMethods.setScreenLoading(true);if(primaryMopSubscribedForClient==1&&mopRelatedToSubscription==0){bpaDepositMethods.setUpModal({locals:{_injectedProperties:{}},size:"sm",keyboard:false,backdrop:"static",controller:"yesNoModalController",templateUrl:"changePrimaryWarning.html"},function(result){if(result&&result.success){bpaDepositMethods.setScreenLoading(true);setPrimaryRequest(aeRid,rid)}})}else{setPrimaryRequest(aeRid,rid)}}};$scope.showAddMopModal=function(){showAddMopModal()};$scope.deleteMop=function(aeRid,rid,removeText){bpaDepositMethods.setScreenLoading(true);bpaDepositMethods.setUpModal({locals:{_injectedProperties:{remove:removeText}},size:"sm",keyboard:false,backdrop:"static",controller:"yesNoModalController",templateUrl:"deleteMopWarning.html"},function(result){if(result&&result.success){bpaDepositMethods.setScreenLoading(true);$http.post(depositMethodsActionUrl(aeRid,"remove",rid)).success(function(data){bpaDepositMethods.processResponse(aeRid,data)}).error(function(){bpaDepositMethods.processFatalErrorInResponse(aeRid)})}})}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("financialAccountSelector",["$http","cookieManager","bpaUrl",function($http,cookieManager,bpaUrl){return{scope:{currentAe:"@",collection:"@",cookie:"@",callback:"&"},templateUrl:"financialAccountSelectorTpl.html",link:function($scope,element,attr){var cookie=$scope.cookie,currentAe=$scope.currentAe,collection=$scope.collection;$scope.change=function(){_setSelectedAeCookie();$scope.callback({id:$scope.selectedAe.id,label:$scope.selectedAe.label})};if(collection&&cookie&&currentAe){var decodedCollection=angular.fromJson(collection);if(Object.keys(decodedCollection).length>1){$scope.aeCollection=_fillDropdownArray(currentAe,decodedCollection)}}else{$http.get(bpaUrl.resourceUrl("/financial-account-selector/fetch")).success(function(data){if(Object.keys(data.collection).length>1){cookie=data.cookie;currentAe=data.currentAe;$scope.aeCollection=_fillDropdownArray(currentAe,data.collection)}})}function _setSelectedAeCookie(){var date=new Date;date.setDate(date.getDate()+30);cookieManager.put(cookie,$scope.selectedAe.id,{expires:date})}function _fillDropdownArray(currentAe,collection){var aeArray=[];angular.forEach(collection,function(value,key){aeArray.push({id:key,label:value})});$scope.selectedAe={id:currentAe,label:collection[currentAe]};return aeArray}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("mpesaForm",["bpaUrl","eoModal","bpaIovation","$timeout",function(bpaUrl,eoModal,bpaIovation,$timeout){return{restrict:"E",scope:{cancelUrl:"@",removeMopUrl:"@",recordId:"@"},require:"bpaBaseForm",templateUrl:function(tElement,tAttr){var formType="mpesa-form",url=tAttr.recordId?bpaUrl.formUrl("edit-"+formType):bpaUrl.formUrl("add-"+formType);if(url&&"/"===url[0]){if(tAttr.recordId){url+="/"+tAttr.recordId}url+="?"+Date.now()}return url},link:function($scope,element,attr,bpaBaseForm){var phoneCodes={},popoverTimeout,popoverVisible=false;bpaBaseForm.init($scope,element,"mpesa").setSubmit(_submit);bpaBaseForm.setRemoveAction(_removeMop);$scope.isAccountHolderPopoverVisible=function(){return popoverVisible};$scope.showAccountHolderPopover=function(){if(popoverTimeout){$timeout.cancel(popoverTimeout);popoverTimeout=null}popoverVisible=true};$scope.hideAccountHolderPopover=function(){if(popoverTimeout){$timeout.cancel(popoverTimeout)}popoverTimeout=$timeout(function(){popoverVisible=false;popoverTimeout=null},100)};$scope.changeCountry=function(){var country=$scope.bpaFormData.country;if(angular.isDefined(phoneCodes[country])){if($scope.bpaFormData.phone){$scope.bpaFormData.phone.phoneCountryCode=phoneCodes[country].countryCode}$scope.mpesaPhonePattern=phoneCodes[country].numberPattern}};$scope.initPhoneCodes=function(codes){phoneCodes=codes;$timeout(function(){$scope.changeCountry()})};if(element[0].querySelector(".bpa-flash-messages")){bpaBaseForm.setNeedAttention()}function _submit(callbackObject){if(bpaBaseForm.isValid()){bpaIovation.updateScope($scope,function(){bpaBaseForm.sendFormData($scope.bpaFormData,callbackObject)})}}function _removeMop(callbackObject){eoModal.custom({locals:{_injectedProperties:{}},keyboard:false,controller:"yesNoModalController",templateUrl:"removalWarning.html"}).result.then(function(){if($scope.removeMopUrl){document.location=$scope.removeMopUrl}},function(){})}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("payNowForm",["bpaDepositMethods","bpaUrl","$http","DEPOSIT_METHODS_URL_PART",function(bpaDepositMethods,bpaUrl,$http,DEPOSIT_METHODS_URL_PART){return{scope:{currentAe:"<"},templateUrl:bpaUrl.resourceUrl(DEPOSIT_METHODS_URL_PART+"/partials/pay-now.html"),link:function($scope,element,attr){var payNowStatus;receivePayNowStatus();$scope.payNow=function(){bpaDepositMethods.setUpModal({locals:{_injectedProperties:{}},size:"sm",keyboard:false,backdrop:"static",controller:"yesNoModalController",templateUrl:"payNowDialog.html"},function(result){if(result&&result.success){bpaDepositMethods.setScreenLoading(true);payNow($scope.currentAe)}})};$scope.isDisabled=function(){return payNowStatus&&typeof payNowStatus.isPayNowEnabled!=="undefined"?!payNowStatus.isPayNowEnabled:true};$scope.getBalanceDue=function(){return payNowStatus&&typeof payNowStatus.balanceDue!=="undefined"?payNowStatus.balanceDue:0};$scope.$watch("currentAe",function(oldAe,newAe){if(oldAe!=newAe){receivePayNowStatus()}});function payNow(aeRid){$http.post(bpaUrl.depositMethodsBaseUrl(aeRid)+"/pay-now").success(function(data,status){if(status!==202){bpaDepositMethods.processResponse(aeRid,data)}else{receivePayNowStatus()}}).error(function(){bpaDepositMethods.processFatalErrorInResponse(aeRid)})}function receivePayNowStatus(){$http.post(bpaUrl.depositMethodsBaseUrl($scope.currentAe)+"/pay-now-status").success(function(data){payNowStatus=data}).error(function(){bpaDepositMethods.processFatalErrorInResponse($scope.currentAe)})}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("ccTemporaryCharges",["bpaUrl",function(bpaUrl){return{restrict:"E",scope:{gotItUrl:"@"},templateUrl:bpaUrl.resourceUrl("/resources/html/temporary-charges.partial.html")}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("useBalanceForm",["bpaUrl","$http",function(bpaUrl,$http){return{scope:{stubMode:"@"},restrict:"E",require:"bpaBaseForm",templateUrl:bpaUrl.resourceUrl(["/resources/html/use-balance.partial.html","use-balance.partial.html"]),link:function($scope,element,attr,bpaBaseForm){bpaBaseForm.init($scope,element,"use_balance").setSubmit(_submit).setIsValid(_isValid);if($scope.stubMode){bpaBaseForm.setStubMode(true)}function _submit(callbackObject){var submitLock="useBalanceLock";bpaBaseForm.setSubmitLock(submitLock);$http.get(bpaUrl.baseUrl()+"add-primary-method/use-balance").success(function(){callbackObject.success()}).error(function(){bpaBaseForm.releaseSubmitLock(submitLock);bpaBaseForm.addStandardError(callbackObject,{})})}function _isValid(){return true}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("verifyMopForm",["bpaUrl","$http","$rootScope","$compile",function(bpaUrl,$http,$rootScope,$compile){var refreshAnchor=Date.now();return{restrict:"E",require:"bpaBaseForm",scope:{mopRid:"=?",callbackObject:"=?"},templateUrl:getBaseUrl,link:function($scope,element,attr,baseForm){if(!baseForm.templateIsOk(getBaseUrl(element,attr))){return}var isBlocked=false;init();refreshAnchor=Date.now();$scope.$watch("mopRid",function(mopRid){if("undefined"===typeof mopRid){return}var url=getBaseUrl(element,attr,mopRid);isBlocked=true;$http.get(url,{cache:true}).then(function(response){if(!baseForm.templateIsOk(url)){return}element.html(response.data);$compile(element.contents())($scope);init();isBlocked=false})});function init(){baseForm.init($scope,element,"verifyMop");baseForm.setActionUrl(baseForm.getFormNode().getAttribute("data-action-url"));baseForm.setSubmit(_submit);baseForm.setCheckSuccessResponse(_checkSuccessResponse);var interfaceObject=baseForm.getInterfaceObject();interfaceObject.isBlocked=_isBlocked}function _isBlocked(){return isBlocked||baseForm.isScreenLocked("form")}function _submit(callbackObject){if(baseForm.isValid()){baseForm.sendFormData($scope.bpaFormData,callbackObject)}}function _checkSuccessResponse(responseData){return!!responseData.verified}}};function getBaseUrl(tElement,tAttr,mopRid){var url="verify-payment/partial/form.html";if(mopRid){url+="/"+mopRid}url+="?"+refreshAnchor;if(tAttr.forcePrimary){url+="&forcePrimary=1"}return bpaUrl.baseUrl(true)+url}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("verifyPaymentMethod",["bpaUrl","bpa","$timeout","$window","bpaVerifyMopEventLogger",function(bpaUrl,bpa,$timeout,$window,bpaVerifyMopEventLogger){var _templateUrl=bpaUrl.resourceUrl("verify-payment/partial/modern-form.partial.html");return{restrict:"E",require:"bpaBaseForm",scope:{mopRid:"=?",mopData:"=?",forcePrimary:"@",callbackObject:"=?",flowName:"@"},templateUrl:_templateUrl,link:function($scope,element,attr,baseForm){var isBlocked=false;init();$scope.$watch("mopRid",function(mopRid){if(!mopRid){return}if(!$scope.mopData){isBlocked=true;bpa.getMethodOfPaymentInfo(mopRid,function(data){if(data&&data.id){$scope.mopData=data;$timeout(function(){angular.element($window).triggerHandler("resize")})}else{baseForm.showErrorNotification()}isBlocked=false},function(){baseForm.showErrorNotification();isBlocked=false})}});function init(){baseForm.init($scope,element,"verifyPaymentMethod");baseForm.setActionUrl(bpaUrl.baseUrl(true)+"verify-payment");baseForm.setSubmit(_submit);baseForm.setCheckSuccessResponse(_checkSuccessResponse);baseForm.setEventLogger(bpaVerifyMopEventLogger);var interfaceObject=baseForm.getInterfaceObject();interfaceObject.isBlocked=_isBlocked}function _isBlocked(){return isBlocked||baseForm.isScreenLocked("form")}function _submit(callbackObject){if($scope.mopData&&baseForm.isValid()){$scope.bpaFormData.mopRid=$scope.mopData.id;$scope.bpaFormData.forcePrimary=$scope.forcePrimary;baseForm.sendFormData($scope.bpaFormData,callbackObject)}}function _checkSuccessResponse(responseData){return Boolean(responseData.verified)}}}}])})(angular);
(function(angular){"use strict";angular.module("bpa-ui.directives").directive("bpaBaseForm",["bpaUrl","bpaFormMode","bpaBlockMode","bpaNetworkErrors","bpaGtmEvents","$http","$parse","$document","$window","$timeout",function(bpaUrl,bpaFormMode,bpaBlockMode,bpaNetworkErrors,bpaGtmEvents,$http,$parse,$document,$window,$timeout){return{require:["bpaBaseForm","?^^bpaBaseForm"],restrict:"A",link:function($scope,element,attr,controllers){var bpaBaseForm=controllers[0],parentForm=controllers[1];if(attr.bpaCommObject){var commObjectSetter=$parse(attr.bpaCommObject).assign;commObjectSetter($scope,bpaBaseForm.getInterfaceObject())}if(attr.callbackObject){var callbackObjectGetter=$parse(attr.callbackObject);bpaBaseForm.setCallbackObject(callbackObjectGetter($scope))}if(attr.isActive){var isActiveGetter=$parse(attr.isActive);bpaBaseForm.setIsActiveGetter(isActiveGetter)}if(attr.pagedMode){bpaBaseForm.setPagedMode(true)}if(attr.hideControls){var hideControlsGetter=$parse(attr.hideControls);bpaBaseForm.setControlsHidden(hideControlsGetter($scope))}if(attr.validateOnSubmit){var validateOnSubmitGetter=$parse(attr.validateOnSubmit);bpaBaseForm.setValidateOnSubmitGetter(validateOnSubmitGetter)}if(attr.standardErrorMessage){bpaBaseForm.setStandardErrorMessage(attr.standardErrorMessage)}if(attr.showErrorNotification){var showErrorNotificationGetter=$parse(attr.showErrorNotification);bpaBaseForm.setShowErrorNotification(showErrorNotificationGetter($scope))}if(attr.lockOnSubmit){var lockOnSubmitGetter=$parse(attr.lockOnSubmit);bpaBaseForm.setLockOnSubmit(lockOnSubmitGetter($scope)||attr.lockOnSubmit)}if(attr.preventLeaveOnSubmit){var preventLeaveOnSubmitGetter=$parse(attr.preventLeaveOnSubmit);bpaBaseForm.setPreventLeaveOnSubmit(preventLeaveOnSubmitGetter($scope))}if(attr.trustevDisabled&&attr.trustevDisabled==1){bpaBaseForm.setTrustevDisabled(attr.trustevDisabled)}if(attr.enableFlashMessages){var getter=$parse(attr.enableFlashMessages);if(getter($scope)){bpaBaseForm.enableFlashMessages()}}if(parentForm){bpaBaseForm.setParentForm(parentForm);parentForm.addChildForm(bpaBaseForm)}bpaBaseForm.triggerFormLinked()},controller:function($scope){var ctrlsByModel={},ctrlsByInput={},postNameMap={},submitLocks={},sensitiveFields=[],ctrlsByValidationGroup={},childForms=[],submitIsUnlocked=true,screenIsUnlocked=true,leaveIsAllowed=true,errorNotificationIsShown=false,trustevDisabled=0,flashMessagesEnabled=false,parentForm,rootNodeElement,formNode,formDOMName="",formName="",actionUrl="",formScope,formCtrl,callbackObject,interfaceObject,standardErrorMessage,errorKey=0,bodyLockClassCount=0,bodyLockClassWasAdded=false,templateNetworkError,isStubMode=false,self=this,gtmEvents={},formPages=[],pagedMode=false,currentPage=0,eventLogger={};this.setGtmEvents=function(events){gtmEvents=events};this.templateIsOk=function(templateUrl){var networkError=bpaNetworkErrors.getErrorForUrl(templateUrl);if(networkError){if(callbackObject){doCallbackNetworkError(callbackObject,networkError)}else{templateNetworkError=networkError}return false}return true};this.init=function(scope,element,name){scope.getCtrlByModelName=self.getCtrlByModelName;scope.getCtrlByInputName=self.getCtrlByInputName;scope.isErrorNotification=self.isErrorNotification;scope.getFormName=self.getFormName;scope.hasError=self.hasError;rootNodeElement=element;formNode=_getFormNode(element);if(formNode){formDOMName=formNode.getAttribute("data-name");formCtrl=scope[formDOMName]}formName=name;formScope=scope;_fillScope(scope);return self};this.getFormName=function(){return formName};this.triggerFormLinked=function(){if(callbackObject&&callbackObject.formLinked){callbackObject.formLinked(this)}};function _getFormNode(element){var selectors=["div.ng-form","div[ng-form]","form"],formNode;for(var i=0,l=selectors.length;i<l;i++){formNode=element[0].querySelector(selectors[i]);if(formNode){return formNode}}return null}function _fillScope(scope){scope.bpaFormErrors={};scope.bpaFormData={};scope.isScreenLocked=self.isScreenLocked;scope.isLeavePrevented=self.isLeavePrevented;scope.isPagedMode=self.isPagedMode;scope.bpaFormCtrl=formCtrl;if("undefined"!==typeof self.isControlsHidden){setControlsHiddenOnScope(self.isControlsHidden,scope)}}this.setParentForm=function(_parentForm){parentForm=_parentForm};this.setStandardErrorMessage=function(msg){standardErrorMessage=msg};this.setCallbackObject=function(_callbackObject){callbackObject=_callbackObject;if(templateNetworkError){doCallbackNetworkError(callbackObject,templateNetworkError)}};this.setStubMode=function(enabled){isStubMode=enabled};this.setSubmit=function(submitFunction){if(!formScope){throw"init must be called first"}formScope.submitForm=function(_callbackObject){_callbackObject=_callbackObject||callbackObject;if(self.isStubMode()){doCallbackSuccess(_callbackObject);return}_validateOnSubmit();if(!self.isValid()){doCallbackError(_callbackObject,null,"Client-side validation error");self.showErrorNotification();return}if(_callbackObject&&_callbackObject.beforeSubmit){_callbackObject.beforeSubmit(function(){submitFunction(_callbackObject)})}else{submitFunction(_callbackObject)}};return self};this.setRemoveAction=function(removeAction){if(!formScope){throw"init must be called first"}formScope.removeAction=function(_callbackObject){_callbackObject=_callbackObject||callbackObject;removeAction(_callbackObject)};return self};function _validateOnSubmit(){if(!self.validateOnSubmitGetter){self.validateAllFields();return}if(self.validateOnSubmitGetter($scope)){self.validateAllFields()}}this.showErrorNotification=function(){if(self.isErrorNotificationAllowed){scrollToErrors()}errorNotificationIsShown=true};this.setIsValid=function(isValidFunction){self.customIsValidFunction=isValidFunction;return self};this.setCheckSuccessResponse=function(checkFunction){self.customCheckSuccessResponse=checkFunction;return self};this.setIsAboutToRedirect=function(isAboutToRedirectFunction){self.customIsAboutToRedirect=isAboutToRedirectFunction;return self};this.setValidateOnSubmitGetter=function(getter){self.validateOnSubmitGetter=getter};this.setControlsHidden=function(isControlsHidden){self.isControlsHidden=isControlsHidden;if(formScope){setControlsHiddenOnScope(isControlsHidden,formScope)}};this.setShowErrorNotification=function(showNotification){self.isErrorNotificationAllowed=showNotification};this.setLockOnSubmit=function(lockOnSubmit){self.lockOnSubmit=lockOnSubmit};this.setPreventLeaveOnSubmit=function(preventLeaveOnSubmit){self.preventLeaveOnSubmit=preventLeaveOnSubmit};function setControlsHiddenOnScope(isControlsHidden,scope){scope.isControlsHidden=isControlsHidden}this.addController=function(modelName,attr,ctrl){ctrlsByModel[modelName]=ctrl;ctrlsByInput[attr.name]=ctrl;_initValidationGroup(modelName,attr,ctrl)};function _initValidationGroup(modelName,attr,ctrl){if(!attr.validationGroup){return}var validationGroup=ctrlsByValidationGroup[attr.validationGroup]||[];validationGroup[modelName]=ctrl;ctrlsByValidationGroup[attr.validationGroup]=validationGroup;ctrl.$parsers.push(function(value){validationGroup=ctrlsByValidationGroup[attr.validationGroup];$timeout(function(){for(var modelNameKey in validationGroup){if(modelName===modelNameKey){continue}var ctrlToValidate=validationGroup[modelNameKey];if(ctrlToValidate.validationLock){continue}if(!ctrlToValidate.$viewValue){continue}ctrlToValidate.validationLock=true;self.validateCtrl(ctrlToValidate);ctrlToValidate.validationLock=false}});return value})}this.setPagedMode=function(mode){pagedMode=!!mode;if(pagedMode&&formPages.length&&formPages[0]){currentPage=0;this.setPageVisible(formPages[0].id)}};this.isFirstPage=function(){return currentPage===0};this.isLastPage=function(){return currentPage===formPages.length-1};this.isPagedMode=function(){return pagedMode};this.addFormPage=function(pageId,pageController){formPages.push({id:pageId,controller:pageController,controls:[],visible:true})};this.getPageById=function(pageId){for(var index=0,count=formPages.length;index<count;index++){if(formPages[index].id===pageId){return formPages[index]}}return null};this.isPageVisible=function(pageId){var page=this.getPageById(pageId);return page!==null&&page.visible};this.getFormPages=function(){return formPages.map(function(page){return page.id})};this.setPageVisible=function(pageId){var firstVisibleIndex=null;for(var index=0,count=formPages.length;index<count;index++){formPages[index].visible=pageId==="all"||formPages[index].id===pageId;if(firstVisibleIndex===null&&formPages[index].visible){firstVisibleIndex=index}}if(firstVisibleIndex!==null&&formPages[firstVisibleIndex].controls.length&&formPages[firstVisibleIndex].controls[0].element){$timeout(function(){formPages[firstVisibleIndex].controls[0].element[0].focus()})}if(callbackObject&&callbackObject.pageChanged){callbackObject.pageChanged(index)}};this.nextPage=function(){if(!self.isLastPage()){if(_validatePageControls(formPages[currentPage])){self.setPageVisible(formPages[++currentPage].id);_logEvent("nextPageSuccess")}else{_logEvent("nextPageFailure",true)}}};this.previousPage=function(){if(!self.isFirstPage()){self.setPageVisible(formPages[--currentPage].id);_logEvent("previousPage")}};this.addControllerToPage=function(pageId,ctrl){var page=this.getPageById(pageId);page!==null&&page.controls.push(ctrl)};function _validatePageControls(page){var valid=true;if(page!==null){for(var ctrl=0,ctrlCount=page.controls.length;ctrl<ctrlCount;ctrl++){self.validateCtrl(page.controls[ctrl]);if(page.controls[ctrl].$invalid){valid=false}}}return valid}this.validateFormPageById=function(pageId){var page=this.getPage(pageId);return page!==null&&_validatePageControls(page)};this.getCtrlByModelName=function(modelName){return ctrlsByModel[modelName]};this.getCtrlByInputName=function(inputName){return ctrlsByInput[inputName]};this.setPostNameMap=function(modelName,postName){postNameMap[modelName]=postName};this.addSensitiveField=function(model,element){sensitiveFields.push({model:model,element:element})};this.addChildForm=function(baseForm){childForms.push(baseForm);if(this.addActiveFormCallback&&isChildFormActive(baseForm)){this.addActiveFormCallback(baseForm)}};this.getActiveChildForm=function(){var childForm;for(var i=0,l=childForms.length;i<l;i++){childForm=childForms[i];if(isChildFormActive(childForm)){return childForm}}};function isChildFormActive(childForm){return childForm.isActiveGetter&&childForm.isActiveGetter(formScope)}this.setIsActiveGetter=function(isActiveGetter){self.isActiveGetter=isActiveGetter};this.getInterfaceObject=function(){if(interfaceObject){return interfaceObject}interfaceObject={submit:formScopeGetter("submitForm"),remove:formScopeGetter("removeAction"),isSubmitAllowed:self.isCanSubmit,isValid:self.isValid,isAboutToRedirect:self.isAboutToRedirect,validate:self.validateAllFields,formIsCancelled:self.postCancelFormEvent,isPagedMode:self.isPagedMode,nextPage:self.nextPage,previousPage:self.previousPage,isFirstPage:self.isFirstPage,isLastPage:self.isLastPage};return interfaceObject};function formScopeGetter(method){return function(_callbackObject){if(!formScope){return false}return formScope[method](_callbackObject)}}this.isCanSubmit=function(checkValid){return(checkValid?self.isValid():true)&&submitIsUnlocked};this.isErrorNotification=function(){return self.isErrorNotificationAllowed&&errorNotificationIsShown};this.isValid=function(){if(self.isStubMode()){return true}if(self.customIsValidFunction){return self.customIsValidFunction()}return formCtrl.$valid&&!formCtrl.$pristine};this.isStubMode=function(){var alreadySubmitted=formScope.isSubmited&&!formScope.allowDoubleSubmit;return isStubMode||alreadySubmitted||bpaFormMode.isStub};this.isAboutToRedirect=function(){if(self.customIsAboutToRedirect){return self.customIsAboutToRedirect()}return false};this.setNeedAttention=function(_formName){_formName=_formName||formName;self.formNeedAttention=_formName;if(self.needAttentionCallback){self.needAttentionCallback(_formName)}if(parentForm){parentForm.setNeedAttention(_formName)}};this.setNeedAttentionCallback=function(needAttentionCallback){if(self.formNeedAttention){needAttentionCallback(self.formNeedAttention)}self.needAttentionCallback=needAttentionCallback;return self};this.isScreenLocked=function(mode){if("page"===mode&&!bodyLockClassCount){return false}if("form"===mode&&bodyLockClassCount){return false}return!screenIsUnlocked};this.isLeavePrevented=function(){if(false===self.preventLeaveOnSubmit){return false}return!leaveIsAllowed};this.setSubmitLock=function(lockName,blockMode,parameter){if(blockMode&bpaBlockMode.lockScreen&&"none"===parameter){blockMode&=~bpaBlockMode.lockScreen}blockMode=blockMode||bpaBlockMode.lockSubmit;var lockObject={mode:blockMode};if(blockMode&bpaBlockMode.lockScreen){screenIsUnlocked=false;lockObject.param=_setLockScreenParameter(parameter)}if(blockMode&bpaBlockMode.preventLeave){leaveIsAllowed=false}submitIsUnlocked=false;submitLocks[lockName]=lockObject};this.releaseSubmitLock=function(lockName){var status=0,lockObject=submitLocks[lockName];if(!lockObject){return}if(lockObject.mode&bpaBlockMode.lockScreen&&"page"===lockObject.param){bodyLockClassCount--}if(bodyLockClassWasAdded&&0===bodyLockClassCount){$document.find("body").removeClass("eo-block-all")}delete submitLocks[lockName];for(var key in submitLocks){status|=submitLocks[key].mode}submitIsUnlocked=0===status;screenIsUnlocked=!(status&bpaBlockMode.lockScreen);leaveIsAllowed=!(status&bpaBlockMode.preventLeave)};this.areErrorsVisible=function(){for(var model in ctrlsByModel){var ctrl=ctrlsByModel[model];if(ctrl.$dirty&&ctrl.$invalid){return true}}return false};this.validateAllFields=function(){for(var model in ctrlsByModel){self.validateCtrl(ctrlsByModel[model])}};this.revalidateField=function(fieldModelName){var controller=self.getCtrlByModelName(fieldModelName);if(controller){self.validateCtrl(controller)}};this.validateCtrl=function(controller){if(controller.element){controller.element.triggerHandler("updateEvent")}if(controller.$valid&&Object.keys(controller.$asyncValidators).length&&"undefined"!==typeof controller.$modelValue){return}controller.$setDirty();controller.$validate();var inputGroup=controller.bpaInputGroup;if(!inputGroup){return}if(controller.$invalid){inputGroup.setStatus(false,true)}else if(!inputGroup.hasParent()){inputGroup.setStatus(true,false)}};this.setActionUrl=function(url){actionUrl=url};this.setTrustevDisabled=function(disabled){trustevDisabled=disabled};this.enableFlashMessages=function(){flashMessagesEnabled=true};this.sendFormData=function(scopeData,_callbackObject){if(!actionUrl){throw"actionUrl must be set first"}scopeData=scopeData||formScope.bpaFormData;_callbackObject=_callbackObject||callbackObject;var data=_constructPostDataObject(scopeData),lockName="sendFormData";self.clearFormErrors();self.setSubmitLock(lockName,bpaBlockMode.preventLeave|bpaBlockMode.lockScreen,self.getSubmitLockMode());if(trustevDisabled!=1&&window.TrustevV2){data.trustevSessionId=window.TrustevV2.SessionId}if(flashMessagesEnabled){data.flashMessagesEnabled=true}$http.post(actionUrl,data,{doNotRetry:true}).success(function(responseData,status,headers,config){self.releaseSubmitLock(lockName);if(!responseData){self.addStandardError(_callbackObject,responseData);return}if(responseData.redirect){doCallbackError(responseData,null,"Server-side redirection");$window.location=responseData.redirect;return}if(_fillErrorsFromResponse(responseData)){doCallbackError(_callbackObject,responseData,"Server-side validation or saving error");return}if(!self.checkSuccessResponse(responseData)){self.addStandardError(_callbackObject,responseData);return}formScope.isSubmited=true;self.setSubmitLock("success");_removeSensitiveData();doCallbackSuccess(_callbackObject,responseData)}).error(function(responseData,status,headers,config){self.releaseSubmitLock(lockName);self.addStandardError(_callbackObject,responseData)})};this.postCancelFormEvent=function(){_postGtmEvent("cancel");return true};this.addStandardError=function(_callbackObject,responseData){self.clearFormErrors();self.addFormError(standardErrorMessage?standardErrorMessage:"We are sorry! We are experiencing a technical"+" problem and cannot process your request right now."+" Please try again in a minute.");scrollToErrors();doCallbackError(_callbackObject,responseData,"Request error or response is invalid")};this.hasError=function(){if(formScope.bpaFormErrors){for(var key in formScope.bpaFormErrors){return true}}return self.isErrorNotification()};this.getSubmitLockMode=function(){return self.lockOnSubmit||"page"};this.getFormNode=function(){return formNode};this.checkSuccessResponse=function(responseData){if(self.customCheckSuccessResponse){return self.customCheckSuccessResponse(responseData)}return!!responseData.id};function _setLockScreenParameter(parameter){if(bodyLockClassCount){parameter="page"}else{parameter=parameter||"page"}if("page"===parameter){var $body=$document.find("body");if(!$body.hasClass("eo-block-all")&&!bodyLockClassCount){bodyLockClassWasAdded=true;$body.addClass("eo-block-all")}bodyLockClassCount++}return parameter}function _fillErrorsFromResponse(responseData){var messages=responseData.errors&&responseData.errors.length?responseData.errors:!responseData.status&&responseData.messages&&responseData.messages.length?responseData.messages:null;if(!messages){return false}for(var i=0,len=messages.length;i<len;i++){self.addFormError(messages[i])}scrollToErrors();return true}function scrollToErrors(){var scrollTop=getOffsetTop(rootNodeElement[0]);$window.scroll(0,scrollTop);function getOffsetTop(node){return node?node.offsetTop+getOffsetTop(node.offsetParent):0}}function _postGtmEvent(event,data){if(gtmEvents[event]){var data=data||{};var eventDefaultData=gtmEvents[event];if(angular.isString(eventDefaultData)){eventDefaultData={eventAction:eventDefaultData}}var mergedEventData=angular.extend({},eventDefaultData,data);switch(event){case"success":bpaGtmEvents.postSuccessEvent(mergedEventData);break;case"failure":bpaGtmEvents.postFailureEvent(mergedEventData);break;case"cancel":bpaGtmEvents.postCancelEvent(mergedEventData);break}}}function _postGtmFailureEvent(error){_postGtmEvent("failure",{errorCode:error})}function doCallbackError(_callbackObject,responseData,errorDescription){_postGtmFailureEvent(errorDescription?errorDescription:"Server-side error");_logEvent("submitFailure",true);if(_callbackObject&&_callbackObject.error){_callbackObject.error(responseData)}}function doCallbackNetworkError(_callbackObject,error){_postGtmFailureEvent("Template loading error");if(_callbackObject&&_callbackObject.networkError){_callbackObject.networkError(error.code,error.data)}}function doCallbackSuccess(_callbackObject,responseData){_postGtmEvent("success");_logEvent("submitSuccess");if(_callbackObject&&_callbackObject.success){_callbackObject.success(responseData)}}this.addFormError=function(text,key){key=key||++errorKey;formScope.bpaFormErrors[key]=text};this.clearFormErrors=function(){errorNotificationIsShown=false;formScope.bpaFormErrors={}};function _constructPostDataObject(scopeData){var fieldsObject={},formObject={},postName,modelValue;for(var modelName in scopeData){postName=postNameMap[modelName];if(postName===null){continue}modelValue=scopeData[modelName];if(!modelValue){continue}postName=postName||modelName;if(postName.indexOf(":")!==-1){var parts=postName.split(":");if(typeof fieldsObject[parts[0]]==="undefined"){fieldsObject[parts[0]]={}}fieldsObject[parts[0]][parts[1]]=modelValue}else{fieldsObject[postName]=modelValue}}formObject[formDOMName]=fieldsObject;return formObject}function _removeSensitiveData(){var field;for(var i=0,l=sensitiveFields.length;i<l;i++){field=sensitiveFields[i];field.model.$setViewValue("");_setModelAsValid(field.model)}}function _setModelAsValid(model){for(var error in model.$error){model.$setValidity(error,true)}}this.setEventLogger=function(logger){eventLogger=logger;if(formScope.flowName&&eventLogger.setFlowName){eventLogger.setFlowName(formScope.flowName)}};function _logEvent(eventName,addErrors){if(eventLogger&&eventLogger[eventName]){if(addErrors){$timeout(function(){eventLogger[eventName](_getVisibleErrors())},100)}else{eventLogger[eventName]()}}}function _getVisibleErrors(){var errors=[],i;for(var key in formScope.bpaFormErrors){errors.push(formScope.bpaFormErrors[key])}var controlNames={};for(var validatorId in formCtrl.$error){for(i=0;i<formCtrl.$error[validatorId].length;i++){var name=formCtrl.$error[validatorId][i].$name;controlNames[name]=1}}var validationErrors=_getValidationErrors();for(i=0;i<validationErrors.length;i++){errors.push(validationErrors[i])}return errors}function _getValidationErrors(){var errors=[];var messages=formNode.querySelectorAll("[ng-messages]:not(.ng-hide) .form-message.form-error");for(var i=0;i<messages.length;i++){errors.push(messages[i].innerText.trim())}return errors}}}}]).directive("bpaFormActionUrl",[function(){return{restrict:"A",require:"^bpaBaseForm",link:function($scope,elem,attr,baseForm){baseForm.setActionUrl(attr.bpaFormActionUrl)}}}]).directive("creditCardForm",["bpaUrl","$http","$timeout","$window","CreditCards","bpaBlockMode","ExternalScripts","bpaIovation","bpaCcEventLogger",function(bpaUrl,$http,$timeout,$window,CreditCards,bpaBlockMode,ExternalScripts,bpaIovation,bpaCcEventLogger){return{restrict:"E",scope:{allowDoubleSubmit:"=?",isSubmited:"=?",trustevDisabled:"=?",colFieldsClass:"@",cancelUrl:"@",recordId:"@",disallowCurrencies:"@",lockOnCountryChange:"@",formLockSelector:"@",forcePrimary:"@",flowName:"@"},require:"bpaBaseForm",templateUrl:getTemplateUrl,link:function($scope,element,attr,baseForm){var ccNumberCache={},originalSavedCountry=null,originalSavedCurrency=null,retryNumberCountriesCurrent=0,retryNumberCountriesMax=1;baseForm.init($scope,element,"creditCard");if($scope.recordId){_checkServerSideErrors();baseForm.setSubmit(_submitEditForm);$timeout(function(){_countryChange();if($scope.bpaFormData){originalSavedCountry=$scope.bpaFormData.country;originalSavedCurrency=$scope.bpaFormData.chargeCurrency}});$timeout(function(){if(baseForm.areErrorsVisible()){baseForm.showErrorNotification()}},300)}else{baseForm.setSubmit(_submitAddForm).setGtmEvents({success:"Add Credit Card",failure:"Add Credit Card",cancel:"Click"});if(attr.pagedMode){baseForm.setEventLogger(bpaCcEventLogger)}_initJsHandlers();$timeout(function(){if($scope.bpaFormData&&$scope.bpaFormData.country){_countryChange()}});initCardTypeCurrencyHandler()}function initCardTypeCurrencyHandler(){var oldCard;$scope.$watch("bpaFormData.ccNumber",function(){var currentCard=CreditCards.getCurrentCard();if(currentCard&&currentCard.type!==oldCard){oldCard=currentCard.type;if(currentCard.currenciesAllowed&&$scope.bpaFormData.country){_countryChange()}}})}function logLoadingFailure(message){bpaCcEventLogger.loadingFailure(message+": "+angular.toJson(CreditCards.getServicesState()))}function _initJsHandlers(){var jsGroupName="add-credit-card",jsWaitLockName="add-cc-js-lock";$scope.jsLoadError=false;if(!ExternalScripts.isGroupReady(jsGroupName)){baseForm.setSubmitLock(jsWaitLockName,bpaBlockMode.lockScreen,"form")}ExternalScripts.addReadyCallback(jsGroupName,function(){$timeout(function(){baseForm.releaseSubmitLock(jsWaitLockName);$scope.jsLoadError=!CreditCards.isReady();if($scope.jsLoadError){logLoadingFailure("Tokenization API failed to load")}})});ExternalScripts.addErrorCallback(jsGroupName,function(){$timeout(function(){baseForm.releaseSubmitLock(jsWaitLockName);$scope.jsLoadError=true;logLoadingFailure("External scripts loading error")})})}function _checkServerSideErrors(){var errorStatus=document.getElementById("card-error-status");if(!errorStatus){return}if("not-found"===errorStatus.value){$window.location=bpaUrl.getMainBillingMethodsPageUri()}}function areCurrenciesAllowed(){var cardType=CreditCards.getCurrentCard();return $scope.disallowCurrencies!=="1"&&(!cardType||cardType.currenciesAllowed)}function _submitAddForm(callbackObject){var tokenizeLockName="Tokenize";if(!CreditCards.isReady()){baseForm.addStandardError();return}baseForm.setSubmitLock(tokenizeLockName,bpaBlockMode.preventLeave|bpaBlockMode.lockScreen,baseForm.getSubmitLockMode());if(!areCurrenciesAllowed()){$scope.bpaFormData.chargeCurrency="USD"}CreditCards.tokenize($scope.bpaFormData,function(tokens,error){$timeout(function(){if(!error&&tokens.adyen&&baseForm.isValid()){_completeStateField();$scope.bpaFormData.forcePrimary=$scope.forcePrimary;if(tokens.mes){$scope.bpaFormData.token=tokens.mes}$scope.bpaFormData.adyenToken=tokens.adyen;if($scope.bpaFormData.ccNumber){var ccNumber=$scope.bpaFormData.ccNumber.replace(/\s/g,"");$scope.bpaFormData.lastFourDigits=ccNumber.substr(-4);$scope.bpaFormData.firstSixDigits=ccNumber.substr(0,6)}bpaIovation.updateScope($scope,function(){baseForm.releaseSubmitLock(tokenizeLockName);baseForm.sendFormData($scope.bpaFormData,callbackObject)})}else{baseForm.releaseSubmitLock(tokenizeLockName);baseForm.addStandardError()}})})}function _submitEditForm(callbackObject){if(baseForm.isValid()){_completeStateField();bpaIovation.updateScope($scope,function(){baseForm.sendFormData($scope.bpaFormData,callbackObject)})}}function _completeStateField(){if(!$scope.isCountryWithStates()){$scope.bpaFormData.countryState=null}else{if("USA"===$scope.bpaFormData.country){$scope.bpaFormData.countryState={stateUsa:$scope.bpaFormData.stateUsa}}else if("CAN"===$scope.bpaFormData.country){$scope.bpaFormData.countryState={stateCanada:$scope.bpaFormData.stateCanada}}}}$scope.countryChange=_countryChange;$scope.isCountryWithStates=function(){var countryCode=$scope.bpaFormData&&$scope.bpaFormData.country;return!!countryCode&&-1<["USA","CAN"].indexOf(countryCode)};$scope.checkCountryCode=function(code){return $scope.bpaFormData&&$scope.bpaFormData.country&&code===$scope.bpaFormData.country};$scope.currencyChange=function(){var currencyObject,currentCode=$scope.bpaFormData.chargeCurrency;currencyObject=getCurrencyObjectByCode(currentCode);if(currencyObject){setCurrentCurrencyObject(currencyObject)}};function _countryChange(){var countryCode=$scope.bpaFormData.country;if(!countryCode){return}retryNumberCountriesCurrent=0;var ccCacheData=ccNumberCache[countryCode];if(ccCacheData){_setCCDataFromData(ccCacheData)}else{_fetchAndSetCCDataByCountryCode(countryCode)}}$scope.isCurrencySelected=function(testCode,index){var chargeCurrencyCode=$scope.bpaFormData.chargeCurrency;if(!chargeCurrencyCode){return 0===index}return testCode===chargeCurrencyCode};$scope.areCurrenciesAllowed=areCurrenciesAllowed;function _fetchAndSetCCDataByCountryCode(countryCode){if(!areCurrenciesAllowed()){_setCCDataFromData({countryCode:countryCode,currencies:[{code:"USD"}]});return}var ccDataLockName="ccDataLock";ccNumberCache[countryCode]=true;if(!baseForm.isPagedMode()||baseForm.isPagedMode()&&!baseForm.isFirstPage()){baseForm.setSubmitLock(ccDataLockName,bpaBlockMode.lockScreen,$scope.lockOnCountryChange)}$http.get(bpaUrl.baseUrl()+"countries/"+$scope.bpaFormData.country,{cache:true}).success(function(data){_setCCDataFromData(data);ccNumberCache[countryCode]=data;baseForm.releaseSubmitLock(ccDataLockName)}).error(function(data){if(retryNumberCountriesCurrent<retryNumberCountriesMax){retryNumberCountriesCurrent++;_fetchAndSetCCDataByCountryCode(countryCode)}else{_setCCData([]);delete ccNumberCache[countryCode];baseForm.releaseSubmitLock(ccDataLockName)}})}function _setCCDataFromData(data){if(true===data){return}$scope.bpaFormData.country=data.countryCode;revalidateIfInvalid("country");revalidateIfInvalid("zip");_setCCData(data.currencies)}function revalidateIfInvalid(fieldModelName){var controller=baseForm.getCtrlByModelName(fieldModelName);if(controller.$invalid&&controller.$dirty){baseForm.revalidateField(fieldModelName)}}function _getListOfCurrenciesIfForexUnavailable(currencyCode){return[{code:currencyCode,date:"",name:"",rate:""},{code:"USD",date:"",name:"U.S. dollars",rate:""}]}function _setCCData(currenciesList){var currencyCode=$scope.bpaFormData.chargeCurrency,countryCode=$scope.bpaFormData.country,currencyObject;if(currenciesList.length===1&&countryCode&&originalSavedCurrency&&currenciesList[0].code==="USD"&&countryCode===originalSavedCountry&&originalSavedCurrency!=="USD"){$scope.chargeCurrenciesList=_getListOfCurrenciesIfForexUnavailable(originalSavedCurrency);currencyCode=originalSavedCurrency}else if(currenciesList.length<=1){$scope.chargeCurrenciesList=[];$scope.bpaFormData.chargeCurrency="";return}else{$scope.chargeCurrenciesList=currenciesList}if(currencyCode){currencyObject=getCurrencyObjectByCode(currencyCode)}if(!currencyObject){currencyObject=currenciesList[0]}if(currencyObject){setCurrentCurrencyObject(currencyObject)}}function getCurrencyObjectByCode(currencyCode){var currencyObject;for(var i=0,l=$scope.chargeCurrenciesList.length;i<l;i++){currencyObject=$scope.chargeCurrenciesList[i];if(currencyObject.code===currencyCode){return currencyObject}}return null}function setCurrentCurrencyObject(currencyObject){$scope.currentCurrency=currencyObject;$scope.bpaFormData.chargeCurrency=currencyObject.code}}};function getTemplateUrl(tElement,tAttr){var url=tAttr.recordId?bpaUrl.formUrl("edit-credit-card"):CreditCards.getAddFormUrl(Boolean(tAttr.pagedMode));if(url&&"/"===url[0]){if(tAttr.recordId){url+="/"+tAttr.recordId}url+="?"+Date.now()}return url}}]).directive("bpaCcNumber",["CreditCards",function(CreditCards){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){var changes=0,knownValidation={bpaCcNumber:1,bpaCcType:1,bpaCcFormat:1,required:1};ctrl.validationStatus={};ctrl.$validators.bpaCcNumber=function(){return!!ctrl.validationStatus.bpaCcNumber};ctrl.$validators.bpaCcType=function(){return!!ctrl.validationStatus.bpaCcType};ctrl.$validators.required=function(){return!!ctrl.validationStatus.required};ctrl.$validators.bpaCcFormat=function(){for(var key in ctrl.validationStatus){if(!knownValidation[key]&&!ctrl.validationStatus[key]){return false}}if("undefined"===typeof ctrl.validationStatus.bpaCcFormat){return true}return!!ctrl.validationStatus.bpaCcFormat};CreditCards.init(attr.ccInputId);CreditCards.addChangeCallback(_onChange);function _onChange(){ctrl.validationStatus=CreditCards.getValidationStatus();ctrl.$setViewValue(""+ ++changes)}}}}]).directive("bpaCvc",["CreditCards",function(CreditCards){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){var knownValidators={bpaCvc34:[3,4],bpaCvc3:[3],bpaCvc:[]};angular.forEach(knownValidators,function(val,validatorName){ctrl.$validators[validatorName]=function(value){return validate(value,validatorName)}});function validate(value,validatorName){if(!value){return true}var hasOnlyDigits=!/\D/.test(value),validLengths=CreditCards.getCvvLength(),hasValidLength=validLengths&&-1!==validLengths.indexOf(value.length);if(isForValidator(validatorName)){return hasOnlyDigits&&hasValidLength}if(!hasKnownValidators()){return hasOnlyDigits&&(hasValidLength||value.length>=3)}return true}function hasKnownValidators(){for(var validatorName in knownValidators){if(isForValidator(validatorName)){return true}}return false}function isForValidator(validatorName){var validLengths=CreditCards.getCvvLength(),lengthsToCheck=knownValidators[validatorName];if(!validLengths||lengthsToCheck.length!==validLengths.length){return false}for(var i=0,l=lengthsToCheck.length;i<l;i++){if(-1===validLengths.indexOf(lengthsToCheck[i])){return false}}return true}}}}]).directive("bpaHaveLetter",[function(){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){ctrl.$validators.bpaHaveLetter=_validate;function _validate(value){if(!value){return true}return/[^0-9 -.,]/.test(value)}}}}]).directive("bpaMaxlengthLink",[function(){return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){if(!ctrl){return}var maxlength=+attr.maxlength,init=false,linkedCtrl;ctrl.$validators.maxlengthLink=_validate;$scope.$watch(_getLinkedValue,function(linkedValue){
var viewValue=ctrl.$viewValue;if(linkedValue&&viewValue){init=true}if(!init){return}ctrl.$setViewValue(viewValue?"":" ");ctrl.$setViewValue(viewValue)});function _validate(value){return((value||"")+(_getLinkedValue()||"")).length<=maxlength}function _getLinkedValue(){if(!linkedCtrl){linkedCtrl=$scope.getCtrlByModelName(attr.bpaMaxlengthLink)}return linkedCtrl.$viewValue}}}}]).directive("bpaZip",["$parse",function($parse){var countryPatterns={USA:/^\d{5}$/,CAN:/^[a-z]\d[a-z](?:\s?\d[a-z]\d)?$/i};return{restrict:"A",require:"ngModel",link:function($scope,elem,attr,ctrl){ctrl.$validators.bpaZip=_validateZip;ctrl.$validators.bpaZipRequired=_validateZipRequired;ctrl.$validators.bpaPostal=_validatePostal;ctrl.$validators.bpaPostalRequired=_validatePostalRequired;ctrl.$validators.bpaPostalIncorrect=_validatePostalIncorrect;var attrOptional=$parse(attr.zipIsOptional);attrOptional.assign($scope,true);$scope.$watch(_getCountryCode,function(countryCode){attrOptional.assign($scope,!countryPatterns[countryCode])});function _validateZip(value){if(!_isUSA()){return true}return _validate(value)}function _validatePostal(value){if(!_isCanada()){return true}return _validate(value)}function _validate(value){if(!$scope.bpaFormData){return true}if(!value){return true}value=value.trim();var pattern=countryPatterns[_getCountryCode()];return pattern?pattern.test(value):true}function _validateZipRequired(value){if(!_isUSA()){return true}return!!value}function _validatePostalRequired(value){if(!_isCanada()){return true}return!!value}function _getCountryCode(){return $scope.bpaFormData?$scope.bpaFormData[attr.zipCountryModel]:""}function _validatePostalIncorrect(value){if(!value){return true}value=value.trim();return value&&/^[a-z0-9\/\-,\.:;\+\(\)# ]{1,10}$/i.test(value)}function _isCanada(){return"CAN"===_getCountryCode()}function _isUSA(){return"USA"===_getCountryCode()}}}}]).directive("bpaInputGroup",[function(){return{restrict:"A",require:["bpaInputGroup","?^^bpaInputGroup"],controller:function($scope){var controllersArray=[],addControllerCallback,element,parent,self=this;this.addController=function(controller){controller.bpaInputGroup=self;controllersArray.push(controller);if(addControllerCallback){addControllerCallback()}};this.setAddControllersCallback=function(callback){addControllerCallback=callback;if(controllersArray.length){addControllerCallback()}};this.getControllers=function(){return controllersArray};this.setElementAndParent=function(elem,parentController){element=elem;parent=parentController};this.hasParent=function(){return!!parent};this.setStatus=function(allOk,oneFail){if(parent){parent.setStatus(allOk,oneFail)}else{element.toggleClass("has-success",allOk);element.toggleClass("has-error",oneFail)}}},link:function($scope,element,attr,ctrls){var ctrl=ctrls[0],parts,watches=[],ctrlIndex=0,stopWatchCallback,isDirty,allOk,oneFail;ctrl.setElementAndParent(element,ctrls[1]);ctrl.setAddControllersCallback(function(){parts=ctrl.getControllers();var partsLength=parts.length,watchesLength=watches.length;if(partsLength&&!watchesLength){watches.push(function(){ctrlIndex=0;isDirty=false;allOk=true;oneFail=false;return getWatch()});watchesLength++}for(;watchesLength<partsLength;watchesLength++){watches.push(getWatch)}if(stopWatchCallback){stopWatchCallback()}stopWatchCallback=$scope.$watchGroup(watches,function(){if(isDirty){ctrl.setStatus(allOk,oneFail)}})});function getWatch(){var part=parts[ctrlIndex];if(part.$dirty){isDirty=true}allOk=allOk&&part.$valid&&!!part.$modelValue;oneFail=oneFail||part.$invalid;ctrlIndex++;return part.$modelValue||part.$viewValue+"_"}}}}]).directive("bpaPhone",["$parse","$timeout","$filter","$injector",function($parse,$timeout,$filter,$injector){return{restrict:"A",require:["?^bpaInputGroup","^^bpaBaseForm","ngModel","?eoPhoneNumber"],link:function($scope,element,attr,ctrl){var inputGroup=ctrl[0],baseForm=ctrl[1],model=ctrl[2],eoPhoneNumber=ctrl[3],childForm=model.$$parentForm[attr.name],childModel=childForm[attr.name],value=null,fields=["countryCode","areaCode","number"],phoneValueObject={},valueFieldName,attrFieldName,phonePatternGetter;childModel=childModel||model;childModel.$validators.incorrectParts=_incorrectParts;childModel.$validators.incorrectLength=_phoneLength;childModel.$validators.incorrectAreaCode=_areaCodeMaxLength;childModel.$validators.incorrectCharacters=_incorrectCharacters;childModel.$validators.incorrectCountryCode=_countryCodeMaxLength;childModel.$validators.incorrectPhone=_incorrectPhone;if(attr.phonePattern){phonePatternGetter=$parse(attr.phonePattern)}if(attr.value){try{value=JSON.parse(attr.value)}catch(e){}}for(var i=0,l=fields.length;i<l;i++){attrFieldName=fields[i];valueFieldName=attr[attrFieldName];if(value&&value[valueFieldName]){phoneValueObject[attrFieldName]=value[valueFieldName]}baseForm.setPostNameMap(valueFieldName,attr.ngModel+":"+valueFieldName)}for(var key in phoneValueObject){if(eoPhoneNumber){if($injector.has("eoPhoneDisplayFilter")){var number=$filter("eoPhoneDisplay")(value,$scope.showSettings);eoPhoneNumber.getFormController().phoneNumber.$setViewValue(number)}}else{modal.$setViewValue(phoneValueObject)}$parse(attr.ngModel).assign($scope,phoneValueObject);break}$timeout(function(){model.$setPristine();model.$setUntouched()});if(inputGroup){inputGroup.addController(childModel)}baseForm.addController(attr.ngModel,attr,childModel);$scope.$watch(attr.ngModel,function(){var modelData=model.$modelValue,formData=$scope.bpaFormData;if(!modelData){return}childModel.$setDirty(childForm.$dirty);for(var key in modelData){formData[attr[key]]=(modelData[key]||"").replace(/\D/g,"")}});function _incorrectPhone(value){if(!value){return true}var fullPhone="",phonePart;for(var i=0,l=fields.length;i<l;i++){phonePart=value[fields[i]];if(!phonePart){return true}fullPhone+=phonePart}if(!phonePatternGetter){return true}var pattern=phonePatternGetter($scope);if(!pattern){return true}pattern=pattern.replace(/^\/|\/$/g,"");return!!fullPhone.match(new RegExp(pattern))}}};function _incorrectCharacters(value){if(!value){return true}var pattern=/[^0-9()-. ]/;for(var key in value){if(value[key]&&pattern.test(value[key])){return false}}return true}function _incorrectParts(value){return value&&value["number"]&&value["number"].replace(/\D/g,"").length}function _phoneLength(value){var textLength=0;if(!value){return true}if(!value["countryCode"]||!value["areaCode"]){return true}for(var key in value){textLength+=(value[key]||"").replace(/\D/g,"").length}return 6<=textLength&&15>=textLength}function _countryCodeMaxLength(value){return _MaxLengthPart(value,"countryCode")}function _areaCodeMaxLength(value){return _MaxLengthPart(value,"areaCode")}function _MaxLengthPart(value,key){if(!value){return true}var part=value[key];if("undefined"===typeof part||null===part){return false}return 0<part.length&&4>=part.length}}]).directive("bpaModel",["$compile","$parse","$timeout",function($compile,$parse,$timeout){return{restrict:"A",require:["?^bpaInputGroup","?^^bpaBaseForm","?ngModel","?^^bpaFormPage"],scope:{bpaModel:"@",ngModel:"@",bpaPostName:"@",bpaPostSkip:"@",bpaSensitive:"@",bpaAddInputGroup:"@"},compile:function(telement,tattr){telement.attr("ng-model","bpaFormData."+tattr.bpaModel);return{pre:_link};function _link($scope,element,attr,ctrl){var inputGroup=ctrl[0],baseForm=ctrl[1],model=ctrl[2],formPage=ctrl[3];if(model){model.bpaPostName=$scope.bpaPostName;model.element=element;if(attr.value&&attr.type!=="radio"){$timeout(function(){$parse(attr.ngModel).assign($scope.$parent,attr.value)})}if(inputGroup&&$scope.bpaAddInputGroup!=="false"){inputGroup.addController(model)}if(baseForm){var modelName=$scope.bpaModel||$scope.ngModel;baseForm.addController(modelName,attr,model);if(formPage){formPage.addController(model)}var postName;if($scope.bpaPostSkip){postName=null}else if($scope.bpaPostName){postName=$scope.bpaPostName}else{postName=modelName}baseForm.setPostNameMap(modelName,postName);if($scope.bpaSensitive){baseForm.addSensitiveField(model,element)}}}else{$compile(element)($scope.$parent)}}}}}]).directive("bpaPreventLeave",["$window",function($window){return{restrict:"A",scope:{active:"&",message:"@"},link:function($scope,element,attr,ctrl){$window.addEventListener("beforeunload",onBeforeUnloadHandler);function onBeforeUnloadHandler(e){if($scope.active()){(e||window.event).returnValue=$scope.message;return $scope.message}}}}}])})(angular);
(function(angular){"use strict";var interceptor=angular.module("bpa-ui.interceptors.error",[]);interceptor.config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("bpaUiErrorInterceptor")}]);interceptor.factory("bpaUiErrorInterceptor",["$q","$injector","$window","$templateCache","bpaNetworkErrors",function($q,$injector,$window,$templateCache,bpaNetworkErrors){var isModalShown=false;var prefixes=Applet.getVar("bpa_ui_base_url");if(typeof prefixes==="undefined"){prefixes=["/"]}else if(typeof prefixes==="string"){prefixes=[prefixes]}function hasRelevantPrefix(url){for(var index=prefixes.length-1;index>=0;index--){if(url.indexOf(prefixes[index])===0){return true}}return false}function showModal(){if(!isModalShown){var templateId="templateLoadingErrorModal.html";if(!$templateCache.get(templateId)){return}var eoModal=$injector.get("eoModal");if(!eoModal){throw"bpa-ui.interceptors.error requires eoModal"}eoModal.custom({locals:{_injectedProperties:{}},keyboard:false,controller:"yesNoModalController",templateUrl:templateId}).result.then(function(){$window.location.reload()},function(){isModalShown=false});isModalShown=true}}return{request:function(config){config.isTemplateRequest="GET"==config.method&&config.url.indexOf(".html")!==-1&&"object"===typeof config.cache&&"undefined"===typeof config.cache.get(config.url)&&hasRelevantPrefix(config.url);return config},responseError:function(response){if(!response.config){return $q.reject("Invalid Response.")}if(response.config.isTemplateRequest){var data="application/json"===response.headers("content-type")?JSON.parse(response.data):response.data;bpaNetworkErrors.setErrorForUrl(response.config.url,response.status,data);showModal();response.status=200;response.statusText="OK";response.data="";return $q.resolve(response)}return $q.reject(response)}}}])})(angular);
(function(angular){"use strict";var bpaUi=angular.module("bpa-ui",["components.core.time","components.core.validation","components.core.block","components.core.fields.phoneNumber","components.core.popover","components.core.alert","components.core.authorization.oauth2","components.core","ngAnimate","ngRoute","ngResource","bpa-ui.constants","bpa-ui.directives","bpa-ui.factories","bpa-ui.controllers","bpa-ui.interceptors.error"])})(angular);
(function(angular){"use strict";angular.module("bpa-ui").run(["$cacheFactory","$templateCache",function($cacheFactory,$templateCache){var cache=$cacheFactory.get("$http");cache.put("/ab/payments/paypal/config",'{"env":"production","key":"AVk-cM9XEqjQVY08lAKbg6h19SKNlhFMjrS4ZTm8NRHK6o9HWRmg4_2klnQkEdBkFvGrvhDLTktltW98","url":"https:\\/\\/www.paypalobjects.com\\/api\\/checkout.js","version":4,"createUrl":"\\/ab\\/payments\\/00000\\/billing-agreement\\/create"}');cache.put("/ab/payments/plaid/config",'{"env":"production","key":"ce704fa163c96e942d630909992457","script_url":"https:\\/\\/cdn.plaid.com\\/link\\/v2\\/stable\\/link-initialize.js","client_name":"Upwork"}');cache.put("/ab/payments/iovation/config",'{"jsUrl":"https:\\/\\/mpsnare.iesnare.com\\/snare.js"}');$templateCache.put("/ab/payments/verify-payment/partial/modern-form.partial.html",'\n\n\n\n\n\n<div data-ng-if="bpaFormErrors">\n    <eo-alert type="danger" data-ng-repeat="(key, error) in bpaFormErrors" class="m-0-left-right m-lg-bottom">\n        <span ng-bind-html="error"></span>\n    </eo-alert>\n</div>\n\n<div data-ng-switch="mopData.type">\n            <div data-ng-switch-when="CC">\n        Check your credit card statement for the two small charges we made to your <strong>{{mopData.name}}</strong>. Enter them here just as they appear on your statement.     <a target="_blank" href="https://support.upwork.com/entries/23151363">Learn more</a>\n\n\n    </div>\n\n            <div data-ng-switch-when="ACH">\n        Check your bank account statement for the two small deposits we made to your <strong>{{mopData.name}}</strong>. Enter them here just as they appear on your statement.     <a target="_blank" href="https://support.upwork.com/entries/23151363">Learn more</a>\n\n\n    </div>\n\n            <div data-ng-switch-when="ACH_DEPOSIT">\n        Check your bank account statement for the two small deposits we made to your <strong>{{mopData.name}}</strong>. Enter them here just as they appear on your statement.     <a target="_blank" href="https://support.upwork.com/entries/23151363">Learn more</a>\n\n\n    </div>\n\n</div>\n\n<div id="verifyMop" data-name="verifyMop"\n     data-ng-submit="submit()"\n     class="ng-form m-lg-top-bottom"\n     data-ng-model-options="{updateOn:\'updateEvent\'}"\n    >\n    <div class="row">\n        <div class="col-sm-6">\n                        <div class="form-group m-0-bottom"\n         data-ng-class="{ \'has-error\': getCtrlByModelName(&#039;amountOne&#039;).$dirty && getCtrlByModelName(&#039;amountOne&#039;).$invalid, \'has-success\': getCtrlByModelName(&#039;amountOne&#039;).$dirty && getCtrlByModelName(&#039;amountOne&#039;).$valid }">\n        <label for="verifyMop_amountOne" class="control-label">Amount 1</label>\n        <input id="verifyMop_amountOne" name="verifyMop[amountOne]"\n               data-bpa-model="amountOne"  type="text" class="form-control text-right" data-bpa-model="amountOne" bpa-amount-input="" required="required" />\n    </div>\n\n            <div class="visible-xs m-sm-bottom"></div>\n        </div>\n        <div class="col-sm-6">\n                        <div class="form-group m-0-bottom"\n         data-ng-class="{ \'has-error\': getCtrlByModelName(&#039;amountTwo&#039;).$dirty && getCtrlByModelName(&#039;amountTwo&#039;).$invalid, \'has-success\': getCtrlByModelName(&#039;amountTwo&#039;).$dirty && getCtrlByModelName(&#039;amountTwo&#039;).$valid }">\n        <label for="verifyMop_amountTwo" class="control-label">Amount 2</label>\n        <input id="verifyMop_amountTwo" name="verifyMop[amountTwo]"\n               data-bpa-model="amountTwo"  type="text" class="form-control text-right" data-bpa-model="amountTwo" bpa-amount-input="" required="required" />\n    </div>\n\n        </div>\n    </div>\n\n    <div ng-messages="bpaFormCtrl.$error" data-ng-show="bpaFormCtrl.$invalid && bpaFormCtrl.$dirty">\n        <span ng-message="bpaPattern" class="form-message form-error">\n            Please enter amounts accurate to two decimal places.\n        </span>\n        <span ng-message="bpaMin" class="form-message form-error">\n            Amount should be greater than $0. Please check your statement for correct amounts.\n        </span>\n        <span ng-message="required" class="form-message form-error">\n            Please enter amounts accurate to two decimal places.\n        </span>\n    </div>\n</div>\n\n<img class="m-lg-top-bottom img img-responsive" src="/ab/payments/images/128cf6a.png?6c81f68" />\n\n<div data-ng-show="mopData.type == \'CC\'" class="m-lg-top-bottom">\n        <img style="width: 30px; vertical-align: middle" class="m-sm-right" src="/ab/payments/images/224ce29.png?6c81f68" />\n        Your card will be refunded within 10 days.\n</div>\n');$templateCache.put("/ab/payments/add-primary-method/add-button",'<div class="bpa-primary-payment-area">\n        <div class="bpa-cards-icon-img"></div>\n\n    <div ng-show="isLoading" data-eo-block="{{isLoading}}" class="p-md-top-bottom"></div>\n    <eo-alert ng-show="isError" type="danger">\n        We are sorry! We are experiencing a technical problem and cannot process your request right now. Please try again in a minute.\n    </eo-alert>\n\n    <div ng-show="!isLoading">\n        <button\n            ng-click="click()"\n            ng-show="!isPrimaryPayment()"\n            class="{{getAddButtonClass(&quot;m-0-top-bottom btn btn-primary p-md-left p-md-right m-0-left&quot;)}}">\n            <span aria-hidden="true" class="glyphicon air-icon-add m-0-left m-md-right"></span>\n            {{ getAddButtonLabel(&quot;Add Billing Now&quot;) }}\n        </button>\n\n        <div ng-show="isPrimaryPayment()" class="m-sm-top">\n            <div class="{{ getPaymentIconClass() }}"></div>\n            <div>\n                <div ng-bind-html="paymentData.display_name"></div>\n                <div ng-show="isVerificationInProgress()" class="m-sm-top">\n                    <em>Remember to verify your billing method later, before your first payment is made.</em>\n                </div>\n            </div>\n        </div>\n    </div>\n\n        <link rel="stylesheet" href="/ab/payments/css/payments.css?6c81f68" />\n</div>\n');$templateCache.put("/ab/payments/deposit-methods/partials/add-billing-method.html",'\n\n\n<style>\n    #bpa-add-primary-payment, #bpa-cc-form-lock {\n        min-height: 400px;\n    }\n    .bpa-security-banner {\n        min-height: 42px;\n        background-color: #EBF7EC;\n        text-align: center;\n        padding: 10px 6%;\n    }\n    .bpa-security-banner img {\n        height: 23px;\n        margin-right: 5px;\n        margin-top: -1px;\n    }\n    #bpa-add-primary-payment .bpa-hide-loading {\n        display: none !important;\n    }\n    .bpa-upwork-balance {\n        color: #767676;\n    }\n    .bpa-collapsed {\n        padding: 0 3px;\n    }\n    .bpa-form-page {\n        padding: 0 2px;\n    }\n    .bpa-content {\n        min-height: 152px;\n        width: 100%;\n    }\n    .bpa-method-choice:not(:first-child) {\n        border-top: 1px solid #E0E0E0;\n    }\n</style>\n\n<div id="bpa-add-primary-payment" class="bpa-add-primary-payment">\n    <div id="bpa-cc-form-lock">\n        <div data-eo-block="{{isBlocked()}}" target="{{formLockSelector}}"></div>\n        <div class="bpa-hide-loading">\n            <div data-ng-show="interfaceObject.isAddPaymentFormActive()">\n                <div class="bpa-security-banner">\n                                        <img src="/ab/payments/images/8db3dc6.png?6c81f68" />\n                                        With <strong>Upwork Payment Protection,</strong> only pay for work delivered.\n                </div>\n                <div class="row m-0 p-0">\n                        <div id="bpa-method-ACH_DEPOSIT"\n         class="bpa-method-choice ng-cloak p-lg-left-right p-md-top-bottom bpa-primary-payment-content"\n         data-ng-if="hasMethod(\'ACH_DEPOSIT\')"\n         data-ng-class="{\n            \'bpa-mode-active\': isActive(\'ACH_DEPOSIT\'),\n            \'bpa-mode-inactive\': !isActive(\'ACH_DEPOSIT\')\n         }"\n         data-ng-init="addMethod(\'ACH_DEPOSIT\')">\n\n         <div class="radio">\n          <label>\n            <input type="radio" name="methodType" data-ng-model="$parent.mode" value="ACH_DEPOSIT">\n            <strong>Bank Account</strong>\n          </label>\n        </div>\n        <div class="bpa-collapsed" data-ng-show="isActive(\'ACH_DEPOSIT\')">\n            <div class="bpa-content">\n\n                    <div class="forward-slide">\n                        <div class="bpa-form-page" data-ng-show="!isManualBankAccountShown()">\n                            <bank-account-plaid-form\n                                callback-object="plaidCallbackObject"\n                                account-types="availableMethods.ACH_DEPOSIT.accountTypes"\n                                processing-fee="availableMethods.ACH_DEPOSIT.processingFee"\n                                force-primary="{{ forcePrimary }}"\n                            ></bank-account-plaid-form>\n                        </div>\n                    </div>\n                    <div class="backward-slide">\n                        <div class="bpa-form-page" data-ng-show="isManualBankAccountShown()">\n                            <bank-account-form\n                                bpa-base-form\n                                mop-type="deposit"\n                                callback-object="baCallbackObject"\n                                bpa-comm-object="$parent.bankAccountInterface"\n                                is-active="isActive(\'ACH_DEPOSIT\')"\n                                lock-on-submit="form"\n                                paged-mode="1"\n                                is-modern="1"\n                                enable-back-button="hasPlaid()"\n                                standard-error-message="We are sorry! We are experiencing a technical problem and cannot process your request right now. Please try again in a minute."\n                                flow-name="{{flowName}}"\n                                force-primary="{{ forcePrimary }}"\n                            ></bank-account-form>\n                        </div>\n                    </div>\n                                </div>\n        </div>\n    </div>\n\n\n                        <div id="bpa-method-CC"\n         class="bpa-method-choice ng-cloak p-lg-left-right p-md-top-bottom bpa-primary-payment-content"\n         data-ng-if="hasMethod(\'CC\')"\n         data-ng-class="{\n            \'bpa-mode-active\': isActive(\'CC\'),\n            \'bpa-mode-inactive\': !isActive(\'CC\')\n         }"\n         data-ng-init="addMethod(\'CC\')">\n\n         <div class="radio">\n          <label>\n            <input type="radio" name="methodType" data-ng-model="$parent.mode" value="CC">\n            <strong>Credit or Debit Card</strong>\n          </label>\n        </div>\n        <div class="bpa-collapsed" data-ng-show="isActive(\'CC\')">\n            <div class="bpa-content">\n\n                        <credit-card-form\n                            bpa-base-form\n                            col-fields-class="col-sm-12"\n                            callback-object="ccCallbackObject"\n                            bpa-comm-object="$parent.creditCardInterface"\n                            is-active="isActive(\'CC\')"\n                            lock-on-submit="form"\n                            lock-on-country-change="form"\n                            paged-mode="1"\n                            form-lock-selector="{{ccFormLockSelector}}"\n                            standard-error-message="We&#x20;are&#x20;sorry&#x21;&#x20;We&#x20;are&#x20;experiencing&#x20;a&#x20;technical&#x20;problem&#x20;and&#x20;cannot&#x20;process&#x20;your&#x20;card&#x20;now.&#x20;Please&#x20;try&#x20;again&#x20;in&#x20;a&#x20;minute."\n                            flow-name="{{flowName}}"\n                            force-primary="{{ forcePrimary }}"\n                        ></credit-card-form>\n                                </div>\n        </div>\n    </div>\n\n\n                                            <div id="bpa-method-PAYPAL_DEPOSIT"\n         class="bpa-method-choice ng-cloak p-lg-left-right p-md-top-bottom bpa-primary-payment-content"\n         data-ng-if="hasMethod(\'PAYPAL_DEPOSIT\')"\n         data-ng-class="{\n            \'bpa-mode-active\': isActive(\'PAYPAL_DEPOSIT\'),\n            \'bpa-mode-inactive\': !isActive(\'PAYPAL_DEPOSIT\')\n         }"\n         data-ng-init="addMethod(\'PAYPAL_DEPOSIT\')">\n\n         <div class="radio">\n          <label>\n            <input type="radio" name="methodType" data-ng-model="$parent.mode" value="PAYPAL_DEPOSIT">\n            <strong><img src="/ab/payments/images/a53365a.png?6c81f68" /></strong>\n          </label>\n        </div>\n        <div class="bpa-collapsed" data-ng-show="isActive(\'PAYPAL_DEPOSIT\')">\n            <div class="bpa-content">\n\n                                            <div class="m-md-top" data-ng-show="!paypalLoadingFailure">\n                            <eo-alert\n                                class="m-0-left-right m-md-bottom"\n                                ng-show="hasPaypalError"\n                                type="danger"\n                            >\n                                <span data-ng-bind-html="paypalGetError(&#039;We are sorry! We are experiencing a technical problem and cannot process your request right now. Please try again in a minute.&#039;)"></span>\n                            </eo-alert>\n\n                            <p data-ng-show="availableMethods.PAYPAL_DEPOSIT.verification">You’ll be redirected to PayPal to link a verified account.</p>\n                            <bpa-paypal-button\n                                size="medium"\n                                callbacks="ppCallbackObject"\n                                flow-name="{{flowName}}"\n                                force-primary="{{ forcePrimary }}"\n                            ></bpa-paypal-button>\n                        </div>\n                        <div class="m-md-top" data-ng-show="paypalLoadingFailure">\n                            <eo-alert class="m-0-left-right m-md-bottom" type="danger">Sorry, a critical component of this page failed to load. Please reload the page.</eo-alert>\n                        </div>\n                                </div>\n        </div>\n    </div>\n\n                        <div id="bpa-method-BALANCE"\n         class="bpa-method-choice ng-cloak p-lg-left-right p-md-top-bottom bpa-primary-payment-content"\n         data-ng-if="hasMethod(\'BALANCE\')"\n         data-ng-class="{\n            \'bpa-mode-active\': isActive(\'BALANCE\'),\n            \'bpa-mode-inactive\': !isActive(\'BALANCE\')\n         }"\n         data-ng-init="addMethod(\'BALANCE\')">\n\n         <div class="radio">\n          <label>\n            <input type="radio" name="methodType" data-ng-model="$parent.mode" value="BALANCE">\n            <strong>Account balance <span class="bpa-upwork-balance">{{ availableMethods.BALANCE.accountBalance | currency:"$" }}</span></strong>\n          </label>\n        </div>\n        <div class="bpa-collapsed" data-ng-show="isActive(\'BALANCE\')">\n            <div class="bpa-content">\n\n                        <p class="m-0 p-0-bottom p-md-top ">Pay with the funds in {{ availableMethods.BALANCE.accountName }} account {{ availableMethods.BALANCE.accountBalance | currency:&quot;$&quot; }}.</p>\n                        <a data-ng-click="useBalance()" class="btn btn-primary m-0-left m-0-bottom m-lg-top">\n                            Pay Now\n                        </a>\n                                </div>\n        </div>\n    </div>\n\n                </div>\n            </div>\n            <div data-ng-show="interfaceObject.isVerificationFormActive()">\n                <div class="p-0-bottom p-lg-top p-lg-left-right bpa-primary-payment-content">\n                    <verify-payment-method\n                        bpa-base-form\n                        show-error-notification="true"\n                        bpa-comm-object="verifyInterface"\n                        callback-object="verifyCallbackObject"\n                        mop-rid="verificationMopRid"\n                        force-primary="{{ forcePrimary }}"\n                        lock-on-submit="form"\n                        flow-name="{{flowName}}"\n                        standard-error-message="We are sorry! We are experiencing a technical problem and cannot process your request right now. Please try again in a minute."\n                    ></verify-payment-method>\n\n                    <div class="p-lg-bottom">\n                        <button class="btn btn-primary m-0-left m-0-top"\n                            data-ng-click="verifyInterface.submit()"\n                            data-ng-disabled="!verifyInterface.isSubmitAllowed()">\n                            Verify\n                        </button>\n                        <button class="btn btn-link m-0-top" data-ng-click="cancelVerification()">\n                            Do it later\n                        </button>\n                    </div>\n                </div>\n            </div>\n            <div data-ng-show="interfaceObject.isSubscriptionFormActive()">\n                <div class="p-0-bottom p-lg-top p-lg-left-right">\n                    <client-plan-subscription\n                            bpa-base-form\n                            show-error-notification="true"\n                            bpa-comm-object="subscriptionInterface"\n                            callback-object="subscriptionCallbackObject"\n                            subscription-info="subscriptionInfo"\n                            lock-on-submit="form"\n                            flow-name="{{flowName}}"\n                            standard-error-message="We are sorry! We are experiencing a technical problem and cannot process your request right now. Please try again in a minute."\n                            subscription-url="/ab/plans/client/subscribe-to-plan"\n                    ></client-plan-subscription>\n\n                    <div>\n                        <button class="btn btn-primary m-0-left m-0-top"\n                                data-ng-click="subscriptionInterface.submit()"\n                                data-ng-disabled="!subscriptionInterface.isSubmitAllowed()">\n                            Select Flat Monthly Fee\n                        </button>\n                        <button class="btn btn-link m-0-top" data-ng-click="cancelSubscription()">\n                            Cancel\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n\n<div data-ng-init="templateLoaded()"></div>\n\n    <link rel="stylesheet" href="/ab/payments/css/payments.css?6c81f68" />\n');$templateCache.put("/ab/payments/deposit-methods/partials/add-billing-method-modal.html",'<style>\n    #bpa-add-primary-payment-modal, #bpa-cc-form-lock-modal {\n        min-height: 430px;\n    }\n\n    .bpa-hide-loading .modal-header {\n        display: none !important;\n    }\n</style>\n<style>\n.modal-header .close:before {\n    content: "";\n}\n</style>\n\n<div data-ng-hide="addBillingInterface.isModalHidden()" id="bpa-add-primary-payment-modal" class="bpa-add-primary-payment">\n    <div id="bpa-cc-form-lock-modal">\n        <div class="bpa-hide-loading">\n            <div class="modal-header">\n                <button data-ng-hide="config.hideCloseButton" type="button" class="close" data-ng-click="close()">\n                    <span class="glyphicon glyphicon-md air-icon-close m-0" aria-hidden="true"></span>\n                    <span class="sr-only">Close</span>\n                </button>\n                <h2 data-ng-show="addBillingInterface.isAddPaymentFormActive()" class="modal-title">Add a billing method</h2>\n                <h2 data-ng-show="addBillingInterface.isVerificationFormActive()" class="modal-title">Verify Your Billing Method</h2>\n                <h2 data-ng-show="addBillingInterface.isSubscriptionFormActive()" class="modal-title">Save in payment processing fees</h2>\n            </div>\n            <div class="modal-body p-0 m-0 bpa-add-billing-method">\n                <add-billing-method\n                    interface-object="addBillingInterface"\n                    callback-object="addBillingCallback"\n                    form-lock-selector="#bpa-add-primary-payment-modal"\n                    cc-form-lock-selector="#bpa-cc-form-lock-modal"\n                    return-payment-data="config.returnPaymentData"\n                    skip-verification="config.skipVerification"\n                    flow-name="{{config.flowName}}"\n                    enable-subscription="config.enableSubscription"\n                    force-primary="{{config.forcePrimary}}"\n                ></add-billing-method>\n            </div>\n        </div>\n    </div>\n</div>\n');$templateCache.put("/ab/payments/deposit-methods/partials/add-billing-method-plaid-modal.html",'<style>\n    #add-plaid-bank-account-modal {\n        overflow: hidden;\n    }\n\n    .bpa-add-plaid-modal {\n        min-height: 410px;\n    }\n</style>\n<style>\n.modal-header .close:before {\n    content: "";\n}\n</style>\n\n<div data-ng-hide="isPlaidModalHidden()" id="bpa-add-plaid-modal" class="bpa-add-plaid-modal" data-ng-class="{\'bpa-min-height-auto\' : !isAddPlaidFormActive()}">\n    <div data-eo-block="{{isBlocked()}}" target="#bpa-add-plaid-modal"></div>\n    <div data-ng-show="isAddPlaidFormActive()" class="modal-header">\n        <button type="button" class="close" data-ng-click="close()">\n            <span class="glyphicon air-icon-close m-0" aria-hidden="true"></span>\n            <span class="sr-only">Close</span>\n        </button>\n        <h2 class="modal-title">Select your bank account</h2>\n    </div>\n    <div class="modal-body p-0 m-0 bpa-add-billing-method">\n        <div data-ng-show="!isAddPlaidFormActive()">\n            <div class="p-xlg-left-right p-xlg-top-bottom">\n    <p class="text-center">\n                    <img width="295" height="138" alt="deposit_methods.plaid.image_alt" src="/ab/payments/images/939124a.png?6c81f68" />\n            </p>\n    <p class="text-center m-0">\n        You are being redirected to Plaid to instantly link and verify your account. does not store your bank login credentials.\n    </p>\n</div>\n        </div>\n\n        <div data-ng-show="isAddPlaidFormActive()" id="plaidForm" data-name="plaidForm" class="form-group ng-form">\n            <bank-account-plaid-modal-form\n                bpa-base-form\n                bpa-comm-object="bpaCommObject"\n                callback-object="callbackObject"\n                account-types="accountTypes"\n                force-primary="{{ forcePrimary }}"\n                lock-on-submit="form"\n                standard-error-message="We&#x20;are&#x20;sorry&#x21;&#x20;We&#x20;are&#x20;experiencing&#x20;a&#x20;technical&#x20;problem&#x20;and&#x20;cannot&#x20;process&#x20;your&#x20;card&#x20;now.&#x20;Please&#x20;try&#x20;again&#x20;in&#x20;a&#x20;minute."\n            />\n        </div>\n    </div>\n</div>\n');$templateCache.put("/ab/payments/deposit-methods/partials/bank-account-plaid.html",'<div id="add-plaid-bank-account">\n    <div class="p-md-top" data-ng-show="isNetworkError() || isPlaidAccountsEmpty() || loadingFailure">\n        <eo-alert class="m-0-left-right add-plaid-bank-account-errors" data-ng-show="isNetworkError()" type="danger">\n            We are sorry! We are experiencing a technical problem and cannot process your request right now. Please try again in a minute.\n        </eo-alert>\n        <eo-alert class="m-0-left-right add-plaid-bank-account-errors" data-ng-show="isPlaidAccountsEmpty()" type="danger">\n            Sorry, we were unable to import any checkings/savings account using this login. Please try again.\n        </eo-alert>\n        <eo-alert class="m-0-left-right add-plaid-bank-account-errors" data-ng-show="loadingFailure" type="danger">\n            Sorry, a critical component of this page failed to load. Please reload the page.\n        </eo-alert>\n    </div>\n\n    <div data-ng-show="!loadingFailure">\n        <p class="p-md-top m-md-bottom">\n            {{ processingFee }}\n        </p>\n        <div class="bpa-fix-shadow-left p-md-top p-sm-bottom row">\n            <div class="col-md-6">\n                <a data-ng-click="initPlaid()" class="btn btn-primary m-0">Link Your Bank Account</a>\n            </div>\n            <div class="col-md-6">\n                <p class="text-right m-0 p-md-top">\n                    <a data-ng-click="showManual()" href="javascript:">\n                        Or enter it manually\n                    </a>\n                </p>\n            </div>\n        </div>\n    </div>\n</div>\n');$templateCache.put("/ab/payments/deposit-methods/partials/client-plan-subscription-form.html",'\n\n\n<div id="clientPlanSubscription" data-name="clientPlanSubscription"\n     data-ng-submit="submit()"\n     class="ng-form p-0-top-bottom bpa-subscription-form">\n    <div data-ng-if="bpaFormErrors">\n        <eo-alert type="danger" data-ng-repeat="(key, error) in bpaFormErrors" class="m-0-left-right m-lg-bottom">\n            <span data-ng-bind-html="error"></span>\n        </eo-alert>\n    </div>\n\n    <p>You’re currently paying a {{getSubscriptionFee()}} fee on every payment.</p>\n    <hr />\n    <h4 class="text-center m-sm-bottom">Pay a flat fee instead</h4>\n    <h1 class="text-center m-sm-bottom text-primary">{{ subscriptionInfo.plan.price|currency:"$":0 }}</h1>\n    <p class="text-center m-md-bottom text-uppercase">per month</p>\n    <div class="row"><hr class="col-sm-4 m-0-top m-lg-bottom" /></div>\n    <ul class="m-sm-bottom list-unstyled">\n        <li class="bpa-list-checked"><span class="glyphicon air-icon-check text-primary" aria-hidden="true"></span>Best for clients spending over {{ getBenefitAmount()|currency:&quot;$&quot;:-1 }}/month</li>\n        <li class="bpa-list-checked" data-ng-show="subscriptionInfo.type == \'ACH_DEPOSIT\'">\n            <span class="glyphicon air-icon-check text-primary" aria-hidden="true"></span>Must pay with your bank account</li>\n        <li class="bpa-list-checked" data-ng-show="subscriptionInfo.type == \'CC\'">\n            <span class="glyphicon air-icon-check text-primary" aria-hidden="true"></span>Must pay with your credit card</li>\n        <li class="bpa-list-checked"><span class="glyphicon air-icon-check text-primary" aria-hidden="true"></span>Charged once a month, no matter how many users or freelancers you have</li>\n        <li class="bpa-list-checked"><span class="glyphicon air-icon-check text-primary" aria-hidden="true"></span>You can change this selection at any time</li>\n    </ul>\n    <div class="m-lg-bottom" data-ng-click="learnmoreSubscription()" data-ng-show="subscriptionInfo.type == \'ACH_DEPOSIT\'">    <a target="_blank" href="https://support.upwork.com/hc/en-us/articles/211068088">Learn more</a>\n</div>\n    <div class="m-lg-bottom" data-ng-click="learnmoreSubscription()" data-ng-show="subscriptionInfo.type == \'CC\'">    <a target="_blank" href="https://support.upwork.com/hc/en-us/articles/211068028">Learn more</a>\n</div>\n</div>\n');$templateCache.put("/ab/payments/deposit-methods/partials/pay-now.html",'<div id="pay-now-block" class="air-card m-0-left-right">\n    <div class="row">\n        <div class="col-md-7">\n            <h2 class="m-md-bottom">Balance Due</h2>\n            Your balance due is <strong id="pay-now-due">{{getBalanceDue() | currency:"$"}}</strong>\n        </div>\n        <div class="col-md-5 text-right">\n            <button class="btn btn-primary m-0-right" data-ng-disabled="isDisabled()" data-ng-click="payNow()">\n                Pay Now\n            </button>\n        </div>\n    </div>\n</div>\n');$templateCache.put("/ab/payments/resources/html/form-controls.partial.html",'<div class="bpa-controls">\n    <footer data-ng-if="commObject.isPagedMode()" class="p-0-top-bottom">\n        <button type="button"\n                name="nextButton"\n                id="nextButton"\n                class="btn btn-primary m-0-top-bottom m-0-left no-hide-animation"\n                data-ng-click="commObject.nextPage()"\n                data-ng-show="!commObject.isLastPage()">Continue</button>\n\n        <button type="button"\n                name="submitButton"\n                id="submitButton"\n                class="btn btn-primary m-0-top-bottom m-0-left no-hide-animation"\n                data-ng-show="commObject.isLastPage()"\n                data-ng-click="commObject.submit()"\n                data-ng-disabled="!commObject.isSubmitAllowed()">Save</button>\n\n        <a class="btn btn-link m-0-top-bottom no-hide-animation"\n           data-ng-click="commObject.previousPage()"\n           data-ng-show="!commObject.isFirstPage()">\n            <strong>Back</strong>\n        </a>\n    </footer>\n    <footer data-ng-if="!commObject.isPagedMode()" class="p-lg-top-bottom">\n        <button type="button" name="submitButton" id="submitButton" class="btn btn-primary m-0-top-bottom m-0-left"\n                data-ng-click="commObject.submit()"\n                data-ng-disabled="!commObject.isSubmitAllowed()">{{ submitLabel }}</button>\n\n        <button type="button" name="removeButton" id="removeButton" class="btn btn-default m-0-top-bottom"\n                data-ng-if="showRemoveButton"\n                data-ng-click="commObject.remove()">Remove</button>\n\n        <a class="btn btn-link m-0-top-bottom"\n           data-ng-click="commObject.formIsCancelled()"\n           data-ng-href="{{cancelUrl}}">\n            <strong>Cancel</strong>\n        </a>\n    </footer>\n</div>\n')}])})(angular);